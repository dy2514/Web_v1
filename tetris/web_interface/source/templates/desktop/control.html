<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TETRIS - 데스크탑 관제 (현대차 브랜딩)</title>
    
    <!-- Google Fonts Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- 디자인 시스템 CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <!-- 대시보드 컨테이너 -->
    <div class="dashboard-container">
        <!-- 대시보드 헤더 -->
        <header class="dashboard-header">
            <div>
                <h1 class="dashboard-title">TETRIS Control Dashboard</h1>
                <p class="dashboard-subtitle">AI 기반 좌석 배치 최적화 시스템</p>
            </div>
            <div class="connection-status">
                <div class="status-indicator offline" id="connectionIndicator"></div>
                <span id="connectionStatus">연결 대기중</span>
    </div>
        </header>

        <!-- 메인 대시보드 그리드 -->
        <div class="dashboard-grid">
            <!-- 중앙 2개 메인 카드 -->
            <div class="main-cards">
                <!-- 모바일 접속 현황 카드 -->
                <div class="dashboard-card mobile-status-card">
                    <div class="card-header-unified">
                        <div>
                            <h2 class="card-title-unified">
                                <span class="icon icon-mobile icon-md" style="color: white;"></span>
                                모바일 접속 현황
                            </h2>
                            <p class="card-subtitle-unified">모바일 기기 접속 및 트리거 상태</p>
                        </div>
                    </div>
                    <div class="dashboard-card-body mobile-card-split">
                        <!-- 좌측: QR 코드 섹션 -->
                        <div class="qr-section">
                            <div class="qr-code-container" id="qrCodeContainer">
                                <div class="qr-code-loading" id="qrCodeText">QR 코드 로딩 중...</div>
                                <img id="qrCodeImage" src="/desktop/qr.png" alt="접속 QR" style="display: none;">
                            </div>
                            
                            <div class="mobile-instruction">
                                모바일에서 스캔하여 연결하세요
                            </div>
                        </div>
                        
                        <!-- 우측: 상태 내용 섹션 -->
                        <div class="status-section">
                            <div class="mobile-status-table-container">
                                <table class="mobile-status-table">
                                    <tbody>
                                        <tr id="mobileConnectionRow" data-status="disconnected">
                                            <td>
                                                <div class="status-type">
                                                    <span class="material-icons status-type-icon">smartphone</span>
                                                    <span class="status-type-text">모바일 접속 상태</span>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="mobile-status-badge" id="mobileConnectionStatus" data-status="disconnected">
                                                    <span class="status-indicator"></span>
                                                    <span class="status-text">접속 없음</span>
                                                </span>
                                            </td>
                                        </tr>
                                        <tr id="imageUploadRow" data-status="waiting">
                                            <td>
                                                <div class="status-type">
                                                    <span class="material-icons status-type-icon">cloud_upload</span>
                                                    <span class="status-type-text">이미지 업로드 상태</span>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="mobile-status-badge" id="imageUploadStatus" data-status="waiting">
                                                    <span class="status-indicator"></span>
                                                    <span class="status-text">대기중</span>
                                                </span>
                                            </td>
                                        </tr>
                                        <tr id="executionTriggerRow" data-status="inactive">
                                            <td>
                                                <div class="status-type">
                                                    <span class="material-icons status-type-icon">play_circle</span>
                                                    <span class="status-type-text">실행 트리거 작동 여부</span>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="mobile-status-badge" id="executionTriggerStatus" data-status="inactive">
                                                    <span class="status-indicator"></span>
                                                    <span class="status-text">비활성</span>
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
        
                <!-- 하드웨어 동작 현황 카드 -->
                <div class="dashboard-card system-hardware-card">
                    <div class="card-header-unified">
                        <div>
                            <h2 class="card-title-unified">
                                <span class="material-icons" style="color: white; font-size: 24px;">settings</span>
                                하드웨어 동작 현황
                            </h2>
                            <p class="card-subtitle-unified">라즈베리파이5 리소스 현황 및 아두이노 통신 현황</p>
                        </div>
                    </div>
                    <div class="dashboard-card-body hardware-card-split">
                        <!-- 좌측: 라즈베리파이 섹션 -->
                        <div class="raspberry-section">
                            <h3 class="section-title">
                                <span class="material-icons" style="color: var(--image-primary); font-size: 20px;">memory</span>
                                라즈베리파이5 리소스 현황
                            </h3>
                            <div class="system-status-grid">
                                <div class="system-status-box">
                                    <div class="system-status-icon">#</div>
                                    <div class="system-status-content">
                                        <h4 class="system-status-label">CPU</h4>
                                        <p class="system-status-value" id="cpuStatusValue">00%</p>
                                    </div>
                                </div>
                                <div class="system-status-box">
                                    <div class="system-status-icon">#</div>
                                    <div class="system-status-content">
                                        <h4 class="system-status-label">RAM</h4>
                                        <p class="system-status-value" id="memoryStatusValue">00%</p>
                                    </div>
                                </div>
                                <div class="system-status-box">
                                    <div class="system-status-icon">#</div>
                                    <div class="system-status-content">
                                        <h4 class="system-status-label">세션</h4>
                                        <p class="system-status-value" id="sessionStatusValue">00%</p>
                                    </div>
                                </div>
                                <div class="system-status-box">
                                    <div class="system-status-icon">#</div>
                                    <div class="system-status-content">
                                        <h4 class="system-status-label">네트워크</h4>
                                        <p class="system-status-value" id="networkStatusValue">00%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 우측: 아두이노 섹션 -->
                        <div class="arduino-section">
                            <h3 class="section-title">
                                <span class="material-icons" style="color: var(--image-primary); font-size: 20px;">usb</span>
                                아두이노 통신 현황
                            </h3>
                            <div class="arduino-connection-status">
                                <div class="arduino-status-table">
                                    <!-- 첫 번째 행: Cell1 ~ Cell4 -->
                                    <div class="arduino-header-row">
                                        <div class="arduino-cell-header">Cell1</div>
                                        <div class="arduino-cell-header">Cell2</div>
                                        <div class="arduino-cell-header">Cell3</div>
                                        <div class="arduino-cell-header">Cell4</div>
                                    </div>
                                    
                                    <!-- 두 번째 행: 상태 블록들 -->
                                    <div class="arduino-status-row">
                                        <div class="arduino-status-block">
                                            <span class="connection-status" id="port1Status" data-status="disconnected">
                                                연결 끊김
                                            </span>
                                        </div>
                                        <div class="arduino-status-block">
                                            <span class="connection-status" id="port2Status" data-status="disconnected">
                                                연결 끊김
                                            </span>
                                        </div>
                                        <div class="arduino-status-block">
                                            <span class="connection-status" id="port3Status" data-status="disconnected">
                                                연결 끊김
                                            </span>
                                        </div>
                                        <div class="arduino-status-block">
                                            <span class="connection-status" id="port4Status" data-status="disconnected">
                                                연결 끊김
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI 처리 단계별 진행 상황 (12열 전체 활용) -->
            <div class="ai-processing-full-width">
                <div class="card-header-unified">
                    <div>
                        <h2 class="card-title-unified">
                            <span class="icon icon-cpu-chip icon-md" style="color: white;"></span>
                            AI 처리 단계별 진행 상황
                        </h2>
                        <p class="card-subtitle-unified">4단계 AI 체인 처리 과정 및 진행률 표기</p>
                    </div>
                </div>
                <div class="ai-processing-content">
                    <!-- AI 처리 단계 표시기 (KRDS 표준) -->
                    <div class="step-indicator-container">
                        <h3 class="step-title">TETRIS AI 처리 진행률</h3>
                        <ol class="krds-step-wrap">
                            <li id="stepIndicator1" class="active">
                                <span>
                                    <i class="step"></i>
                                    <span class="step-number">1단계</span>
                                    <span class="step-tit">이미지 분석</span>
                                </span>
                            </li>
                            <li id="stepIndicator2">
                                <span>
                                    <i class="step"></i>
                                    <span class="step-number">2단계</span>
                                    <span class="step-tit">데이터 처리</span>
                                </span>
                            </li>
                            <li id="stepIndicator3">
                                <span>
                                    <i class="step"></i>
                                    <span class="step-number">3단계</span>
                                    <span class="step-tit">최적화 생성</span>
                                </span>
                            </li>
                            <li id="stepIndicator4">
                                <span>
                                    <i class="step"></i>
                                    <span class="step-number">4단계</span>
                                    <span class="step-tit">하드웨어 구동</span>
                                </span>
                            </li>
                        </ol>
                        <div class="step-status-text" id="aiProgressStatus">시스템 준비됨</div>
                    </div>
                    
                    <!-- 처리 세부 현황 (KRDS 아코디언 형식) -->
                    <div class="ai-details-section">
                        <h3 class="ai-details-title">처리 세부 현황</h3>
                        <div class="krds-accordion type-line" role="region" aria-label="AI 처리 세부 현황">
                            <!-- 1단계: 이미지 분석 -->
                            <div class="accordion-item">
                                <h5 class="accordion-header">
                                    <button type="button" id="accordionHeaderStep1" class="btn-accordion" aria-controls="accordionCollapseStep1">
                                        <span class="accordion-step-number">1</span>
                                        <span class="accordion-step-title">이미지 분석</span>
                                        <span class="accordion-step-status" id="step1AccordionStatus">대기중</span>
                                    </button>
                                </h5>
                                <div id="accordionCollapseStep1" class="accordion-collapse collapse" aria-labelledby="accordionHeaderStep1">
                                    <div class="accordion-body">
                                        <div class="step-detail-content">
                                            <p class="step-description">업로드된 이미지에서 좌석과 승객 인식</p>
                                            <div class="step-progress-section">
                                                <div class="step-progress-bar" role="progressbar" aria-label="이미지 분석 진행률" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    <div class="step-progress-fill" id="step1Progress" aria-hidden="true"></div>
                                                </div>
                                                <span class="step-progress-text" id="step1ProgressText">0%</span>
                                            </div>
                                            <div class="step-detail-info" id="step1DetailInfo">
                                                <p>• 이미지 업로드 대기중</p>
                                                <p>• AI 모델 준비 완료</p>
                                                <p>• 좌석 인식 알고리즘 활성화</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 2단계: 데이터 처리 -->
                            <div class="accordion-item">
                                <h5 class="accordion-header">
                                    <button type="button" id="accordionHeaderStep2" class="btn-accordion" aria-controls="accordionCollapseStep2">
                                        <span class="accordion-step-number">2</span>
                                        <span class="accordion-step-title">데이터 처리</span>
                                        <span class="accordion-step-status" id="step2AccordionStatus">대기중</span>
                                    </button>
                                </h5>
                                <div id="accordionCollapseStep2" class="accordion-collapse collapse" aria-labelledby="accordionHeaderStep2">
                                    <div class="accordion-body">
                                        <div class="step-detail-content">
                                            <p class="step-description">인식된 데이터를 구조화하고 분석</p>
                                            <div class="step-progress-section">
                                                <div class="step-progress-bar" role="progressbar" aria-label="데이터 처리 진행률" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    <div class="step-progress-fill" id="step2Progress" aria-hidden="true"></div>
                                                </div>
                                                <span class="step-progress-text" id="step2ProgressText">0%</span>
                                            </div>
                                            <div class="step-detail-info" id="step2DetailInfo">
                                                <p>• 데이터 구조화 대기중</p>
                                                <p>• 분석 알고리즘 준비 완료</p>
                                                <p>• 데이터 검증 모듈 활성화</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 3단계: 최적화 생성 -->
                            <div class="accordion-item">
                                <h5 class="accordion-header">
                                    <button type="button" id="accordionHeaderStep3" class="btn-accordion" aria-controls="accordionCollapseStep3">
                                        <span class="accordion-step-number">3</span>
                                        <span class="accordion-step-title">최적화 생성</span>
                                        <span class="accordion-step-status" id="step3AccordionStatus">대기중</span>
                                    </button>
                                </h5>
                                <div id="accordionCollapseStep3" class="accordion-collapse collapse" aria-labelledby="accordionHeaderStep3">
                                    <div class="accordion-body">
                                        <div class="step-detail-content">
                                            <p class="step-description">AI 알고리즘으로 최적 좌석 배치 생성</p>
                                            <div class="step-progress-section">
                                                <div class="step-progress-bar" role="progressbar" aria-label="최적화 생성 진행률" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    <div class="step-progress-fill" id="step3Progress" aria-hidden="true"></div>
                                                </div>
                                                <span class="step-progress-text" id="step3ProgressText">0%</span>
                                            </div>
                                            <div class="step-detail-info" id="step3DetailInfo">
                                                <p>• 최적화 알고리즘 대기중</p>
                                                <p>• 좌석 배치 모델 준비 완료</p>
                                                <p>• 시뮬레이션 엔진 활성화</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 4단계: 하드웨어 구동 -->
                            <div class="accordion-item">
                                <h5 class="accordion-header">
                                    <button type="button" id="accordionHeaderStep4" class="btn-accordion" aria-controls="accordionCollapseStep4">
                                        <span class="accordion-step-number">4</span>
                                        <span class="accordion-step-title">하드웨어 구동</span>
                                        <span class="accordion-step-status" id="step4AccordionStatus">대기중</span>
                                    </button>
                                </h5>
                                <div id="accordionCollapseStep4" class="accordion-collapse collapse" aria-labelledby="accordionHeaderStep4">
                                    <div class="accordion-body">
                                        <div class="step-detail-content">
                                            <p class="step-description">모터 제어 코드 생성 및 실행</p>
                                            <div class="step-progress-section">
                                                <div class="step-progress-bar" role="progressbar" aria-label="하드웨어 구동 진행률" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    <div class="step-progress-fill" id="step4Progress" aria-hidden="true"></div>
                                                </div>
                                                <span class="step-progress-text" id="step4ProgressText">0%</span>
                                            </div>
                                            <div class="step-detail-info" id="step4DetailInfo">
                                                <p>• 모터 제어 코드 대기중</p>
                                                <p>• 하드웨어 연결 준비 완료</p>
                                                <p>• 실행 모듈 활성화</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        <!-- 시스템 제어 버튼들 -->
        <div class="dashboard-card" style="margin-top: var(--space-6);">
            <div class="card-header-unified">
                <div>
                    <h2 class="card-title-unified">
                        <span class="icon icon-settings icon-md" style="color: white;"></span>
                        시스템 제어
                    </h2>
                    <p class="card-subtitle-unified">시스템 관리 및 제어</p>
                </div>
            </div>
            <div class="dashboard-card-body">
                <div class="system-control-buttons" style="display: flex; gap: var(--space-4); justify-content: center;">
                    <button class="btn btn-secondary btn-lg" onclick="refreshStatus()">
                        <span class="icon icon-refresh icon-md"></span>
                        상태 새로고침
                    </button>
                    <button class="btn btn-danger btn-lg" onclick="resetSystem()">
                        <span class="icon icon-reset icon-md"></span>
                        시스템 초기화
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 통합 통신 구조 스크립트 -->
    <script src="{{ url_for('static', filename='js/config/frontend-config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils/validation-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils/dom-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/performance-optimizer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/error-handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/unified-communication-manager.js') }}"></script>
    
    <script>
        let streamActive = false;
        let streamSource = null;
        let sessionId = null;
        let logsPaused = false;
        
        // QR 코드 로딩
        function loadQRCode() {
            const qrImage = document.getElementById('qrCodeImage');
            const qrText = document.getElementById('qrCodeText');
            
            qrImage.onload = function() {
                qrText.style.display = 'none';
                qrImage.style.display = 'block';
            };
            
            qrImage.onerror = function() {
                qrText.textContent = 'QR 코드 로딩 실패';
                qrText.style.display = 'block';
                qrImage.style.display = 'none';
            };
            
            // 타임스탬프를 추가하여 캐시 방지
            const timestamp = new Date().getTime();
            qrImage.src = '/desktop/qr.png?t=' + timestamp;
        }

        // 라즈베리파이 상태 업데이트
        function updateRaspberryPiStatus(cpu, memory, process, session) {
            const cpuElement = document.getElementById('cpuStatusValue');
            const memoryElement = document.getElementById('memoryStatusValue');
            const processElement = document.getElementById('processStatusValue');
            const sessionElement = document.getElementById('sessionStatusValue');
            
            if (cpuElement) cpuElement.textContent = `${cpu}%`;
            if (memoryElement) memoryElement.textContent = `${memory}%`;
            if (processElement) processElement.textContent = process;
            if (sessionElement) sessionElement.textContent = session;
        }

        // AI 전체 진행률 업데이트 (AI 섹션)
        function updateAIOverallProgress(percentage) {
            const progressStatus = document.getElementById('aiProgressStatus');
            
            // 단계 표시기 상태 업데이트
            updateStepIndicators(percentage);
            
            // 상세 현황 카드 동기화
            updateDetailStepCards(percentage);
            
            if (progressStatus) {
                if (percentage === 0) {
                    progressStatus.textContent = '시스템 준비됨';
                } else if (percentage < 25) {
                    progressStatus.textContent = '이미지 분석 중...';
                } else if (percentage < 50) {
                    progressStatus.textContent = '데이터 처리 중...';
                } else if (percentage < 75) {
                    progressStatus.textContent = '최적화 생성 중...';
                } else if (percentage < 100) {
                    progressStatus.textContent = '하드웨어 구동 중...';
                } else {
                    progressStatus.textContent = 'AI 처리 완료!';
                    
                    // AI 처리 완료 시 자동으로 기본 통신으로 전환
                    setTimeout(() => {
                        if (streamActive) {
                            toggleStream();
                            addLog('success', 'AI 처리 완료! 실시간 스트림이 기본 통신으로 전환되었습니다.');
                        }
                    }, 2000); // 2초 후 전환
                }
            }
        }

        // 단계 표시기 상태 업데이트 함수 (KRDS 표준)
        function updateStepIndicators(percentage, errorStep = null) {
            const steps = [
                document.getElementById('stepIndicator1'),
                document.getElementById('stepIndicator2'),
                document.getElementById('stepIndicator3'),
                document.getElementById('stepIndicator4')
            ];
            
            steps.forEach((step, index) => {
                if (step) {
                    // 모든 상태 클래스 제거
                    step.classList.remove('done', 'active', 'error');
                    
                    const stepThreshold = (index + 1) * 25;
                    
                    // 오류 상태 처리
                    if (errorStep === index + 1) {
                        step.classList.add('error');
                        return;
                    }
                    
                    if (percentage >= stepThreshold) {
                        // 완료된 단계
                        step.classList.add('done');
                    } else if (percentage >= stepThreshold - 25) {
                        // 현재 진행 중인 단계
                        step.classList.add('active');
                    }
                }
            });
        }

        // 상세 현황 카드 동기화 함수
        function updateDetailStepCards(percentage) {
            const stepCards = [
                document.getElementById('step1'),
                document.getElementById('step2'),
                document.getElementById('step3'),
                document.getElementById('step4')
            ];
            
            stepCards.forEach((card, index) => {
                if (card) {
                    const progressFill = card.querySelector('.ai-step-progress-fill');
                    const statusText = card.querySelector('.sr-only');
                    const stepThreshold = (index + 1) * 25;
                    const stepProgress = Math.min(Math.max(percentage - (index * 25), 0), 25);
                    
                    // 진행률 업데이트
                    if (progressFill) {
                        progressFill.style.width = `${stepProgress * 4}%`; // 0-25%를 0-100%로 변환
                    }
                    
                    // 접근성 속성 업데이트
                    card.setAttribute('aria-valuenow', stepProgress);
                    
                    // 상태 텍스트 업데이트
                    if (statusText) {
                        if (percentage >= stepThreshold) {
                            statusText.textContent = '완료됨';
                        } else if (percentage >= stepThreshold - 25) {
                            statusText.textContent = `진행중 ${Math.round(stepProgress * 4)}%`;
                        } else {
                            statusText.textContent = '대기중';
                        }
                    }
                    
                    // 카드 상태 클래스 업데이트
                    card.classList.remove('active', 'completed');
                    if (percentage >= stepThreshold) {
                        card.classList.add('completed');
                    } else if (percentage >= stepThreshold - 25) {
                        card.classList.add('active');
                    }
                }
            });
        }

        // AI 단계 업데이트 (통합된 함수 - 아코디언 형식)
        function updateAIStep(stepNumber, status, progress = 0) {
            // 전체 진행률로 변환 (stepNumber * 25 + progress)
            const overallProgress = (stepNumber - 1) * 25 + (progress * 0.25);
            updateAIOverallProgress(overallProgress);
            
            // 아코디언 진행률 업데이트
            const accordionProgressFill = document.getElementById(`step${stepNumber}Progress`);
            const accordionProgressText = document.getElementById(`step${stepNumber}ProgressText`);
            const accordionStatus = document.getElementById(`step${stepNumber}AccordionStatus`);
            
            if (accordionProgressFill && accordionProgressText && accordionStatus) {
                accordionProgressFill.style.width = `${progress}%`;
                accordionProgressText.textContent = `${progress}%`;
                
                switch(status) {
                    case 'completed':
                        accordionStatus.textContent = '완료';
                        accordionStatus.style.color = 'var(--color-success)';
                        break;
                    case 'active':
                        accordionStatus.textContent = '진행중';
                        accordionStatus.style.color = 'var(--color-info)';
                        break;
                    case 'waiting':
                        accordionStatus.textContent = '대기중';
                        accordionStatus.style.color = 'var(--text-secondary)';
                        break;
                    case 'error':
                        accordionStatus.textContent = '오류';
                        accordionStatus.style.color = 'var(--color-error)';
                        break;
                    default:
                        accordionStatus.textContent = '대기중';
                        accordionStatus.style.color = 'var(--text-secondary)';
                }
            }
            
            // 아코디언 단계 번호 스타일 업데이트
            const accordionButton = document.getElementById(`accordionHeaderStep${stepNumber}`);
            if (accordionButton) {
                const stepNumberElement = accordionButton.querySelector('.accordion-step-number');
                if (stepNumberElement) {
                    stepNumberElement.className = 'accordion-step-number';
                    switch(status) {
                        case 'completed':
                            stepNumberElement.style.background = 'var(--color-success)';
                            break;
                        case 'active':
                            stepNumberElement.style.background = 'var(--color-info)';
                            break;
                        case 'error':
                            stepNumberElement.style.background = 'var(--color-error)';
                            break;
                        default:
                            stepNumberElement.style.background = 'var(--krds-accordion--button-color-action)';
                    }
                }
            }
        }

        // 로그 추가
        function addLog(type, message) {
            if (logsPaused) return;
            
            const logsList = document.getElementById('logsList');
            const timestamp = new Date().toLocaleTimeString();
            const iconMap = {
                info: 'ℹ️',
                success: '✅',
                warning: '⚠️',
                error: '❌'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-icon">${iconMap[type] || 'ℹ️'}</span>
                <span class="log-message">${message}</span>
            `;
            
            logsList.insertBefore(logEntry, logsList.firstChild);
            
            // 최대 50개 로그만 유지
            while (logsList.children.length > 50) {
                logsList.removeChild(logsList.lastChild);
            }
        }

        // 로그 제어
        function clearLogs() {
            document.getElementById('logsList').innerHTML = '';
            addLog('info', '로그가 지워졌습니다.');
        }

        function toggleLogs() {
            logsPaused = !logsPaused;
            const btn = event.target.closest('button');
            const icon = btn.querySelector('.icon');
            const text = btn.querySelector('span:not(.icon)');
            
            if (logsPaused) {
                icon.classList.remove('icon-pause');
                icon.classList.add('icon-play');
                text.textContent = ' 재개';
                addLog('warning', '로그 업데이트가 일시정지되었습니다.');
                } else {
                icon.classList.remove('icon-play');
                icon.classList.add('icon-pause');
                text.textContent = ' 일시정지';
                addLog('info', '로그 업데이트가 재개되었습니다.');
            }
        }

        // 포트 상태 업데이트 함수
        function updatePortStatus(portNumber, status, connectionTime) {
            const statusElement = document.getElementById(`port${portNumber}Status`);
            const timeElement = document.getElementById(`port${portNumber}Time`);
            
            if (statusElement) {
                statusElement.setAttribute('data-status', status);
            }
            
            if (timeElement) {
                timeElement.textContent = connectionTime;
            }
        }

        // 모바일 상태 트리거 업데이트 함수들 (표 형태)
        function updateMobileConnectionStatus(status) {
            const rowElement = document.getElementById('mobileConnectionRow');
            const statusElement = document.getElementById('mobileConnectionStatus');
            const statusText = statusElement.querySelector('.status-text');
            
            if (rowElement && statusElement) {
                // 행과 상태 요소 모두 업데이트
                rowElement.setAttribute('data-status', status);
                statusElement.setAttribute('data-status', status);
                
                switch(status) {
                    case 'connected':
                        statusText.textContent = '접속됨';
                        break;
                    case 'disconnected':
                        statusText.textContent = '접속 없음';
                        break;
                    default:
                        statusText.textContent = '알 수 없음';
                }
            }
        }

        function updateImageUploadStatus(status) {
            const rowElement = document.getElementById('imageUploadRow');
            const statusElement = document.getElementById('imageUploadStatus');
            const statusText = statusElement.querySelector('.status-text');
            
            if (rowElement && statusElement) {
                // 행과 상태 요소 모두 업데이트
                rowElement.setAttribute('data-status', status);
                statusElement.setAttribute('data-status', status);
                
                switch(status) {
                    case 'uploading':
                        statusText.textContent = '업로드중';
                        break;
                    case 'completed':
                        statusText.textContent = '완료';
                        break;
                    case 'waiting':
                        statusText.textContent = '대기중';
                        break;
                    case 'error':
                        statusText.textContent = '오류';
                        break;
                    default:
                        statusText.textContent = '대기중';
                }
            }
        }

        function updateExecutionTriggerStatus(status) {
            const rowElement = document.getElementById('executionTriggerRow');
            const statusElement = document.getElementById('executionTriggerStatus');
            const statusText = statusElement.querySelector('.status-text');
            
            if (rowElement && statusElement) {
                // 행과 상태 요소 모두 업데이트
                rowElement.setAttribute('data-status', status);
                statusElement.setAttribute('data-status', status);
                
                switch(status) {
                    case 'active':
                        statusText.textContent = '활성';
                        break;
                    case 'inactive':
                        statusText.textContent = '비활성';
                        break;
                    case 'processing':
                        statusText.textContent = '처리중';
                        break;
                    default:
                        statusText.textContent = '비활성';
                }
            }
        }

        // 아코디언 토글 기능
        function initializeAccordion() {
            const accordionButtons = document.querySelectorAll('.btn-accordion');
            
            accordionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('aria-controls');
                    const targetCollapse = document.getElementById(targetId);
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';
                    
                    // 현재 상태 토글
                    if (isExpanded) {
                        this.setAttribute('aria-expanded', 'false');
                        targetCollapse.classList.remove('show');
                    } else {
                        this.setAttribute('aria-expanded', 'true');
                        targetCollapse.classList.add('show');
                    }
                });
            });
        }

        // 초기 UI 상태 설정
        function initializeUI() {
            updateRaspberryPiStatus(0, 0, '대기중', '비활성');
            updateAIOverallProgress(25); // 1단계 활성 상태로 초기화
            addLog('info', 'TETRIS 시스템이 준비되었습니다.');
            
            // 아두이노 포트 초기 상태 설정
            resetArduinoPorts();
            
            // 모바일 상태 트리거 초기 상태 설정
            updateMobileConnectionStatus('disconnected');
            updateImageUploadStatus('waiting');
            updateExecutionTriggerStatus('inactive');
            
            // 헤더 연결 상태 업데이트
            updateHeaderConnectionStatus();
            
            // 아코디언 초기화
            initializeAccordion();
        }

        // 통신 매니저 초기화
        function initializeCommunication() {
            if (window.UnifiedCommunicationManager) {
                const commManager = new UnifiedCommunicationManager();
                
                // 세션 시작
                commManager.startSession().then(session => {
                    sessionId = session.session_id;
                    addLog('success', `세션이 시작되었습니다. ID: ${sessionId}`);
                    updateStatus('session', '활성');
                }).catch(error => {
                    addLog('error', `세션 시작 실패: ${error.message}`);
                });
                
                // SSE 메시지 처리
                commManager.on('progress', (data) => {
                    updateAIOverallProgress(data.progress);
                    
                    if (data.step) {
                        updateAIStep(data.step, 'active', data.step_progress || 0);
                    }
                    
                    if (data.message) {
                        addLog('info', data.message);
                    }
                });
                
                // 에러 처리
                commManager.on('error', (error) => {
                    addLog('error', error.message);
                });
                
                // 상태 업데이트
                commManager.on('status', (status) => {
                    updateStatus('connection', status.connection);
                    updateStatus('upload', status.upload);
                    updateStatus('process', status.process);
                });
            }
        }

        // 상태 업데이트 헬퍼
        function updateStatus(type, value) {
            const statusMap = {
                connection: 'connectionStatusValue',
                upload: 'uploadStatusValue',
                process: 'processStatusValue',
                session: 'sessionStatusValue'
            };
            
            const element = document.getElementById(statusMap[type]);
            if (element) {
                element.textContent = value;
            }
        }

        // 헤더 연결 상태 업데이트 (주요 시스템 기반)
        function updateHeaderConnectionStatus() {
            const connectionIndicator = document.getElementById('connectionIndicator');
            const connectionStatus = document.getElementById('connectionStatus');
            
            // 아두이노 포트 연결 상태 체크 (새로운 표 형식)
            let connectedPorts = 0;
            let totalPorts = 4;
            
            for (let i = 1; i <= totalPorts; i++) {
                const portStatusElement = document.getElementById(`port${i}Status`);
                if (portStatusElement && portStatusElement.getAttribute('data-status') === 'connected') {
                    connectedPorts++;
                }
            }
            
            // 라즈베리파이 세션 상태 체크
            const sessionElement = document.getElementById('sessionStatusValue');
            const isSessionActive = sessionElement && sessionElement.textContent === '활성';
            
            // 전체 연결 상태 결정
            if (connectedPorts === totalPorts && isSessionActive) {
                // 모든 포트 연결 + 세션 활성
                connectionIndicator.className = 'status-indicator online';
                connectionStatus.textContent = '시스템 정상';
            } else if (connectedPorts > 0 && isSessionActive) {
                // 일부 포트 연결 + 세션 활성
                connectionIndicator.className = 'status-indicator warning';
                connectionStatus.textContent = '부분 연결';
            } else if (isSessionActive) {
                // 세션만 활성
                connectionIndicator.className = 'status-indicator warning';
                connectionStatus.textContent = '하드웨어 연결 필요';
            } else {
                // 연결 안됨
                connectionIndicator.className = 'status-indicator offline';
                connectionStatus.textContent = '시스템 오프라인';
            }
        }

        // AI 처리 시작 (모바일에서 제어됨, 자동으로 실시간 스트림 활성화)
        function startProcessing() {
            addLog('info', 'AI 처리를 시작합니다...');
            updateAIStep(1, 'active', 0);
            updateRaspberryPiStatus(25, 30, '처리중', '활성');
            updateAIOverallProgress(5);
            
            // 자동으로 실시간 스트림 활성화
            if (!streamActive) {
                toggleStream();
            }
            
            if (window.UnifiedCommunicationManager) {
                const commManager = new UnifiedCommunicationManager();
                commManager.startProcessing().then(response => {
                    addLog('success', 'AI 처리가 성공적으로 시작되었습니다. 실시간 스트림이 활성화되었습니다.');
                }).catch(error => {
                    addLog('error', `처리 시작 실패: ${error.message}`);
                });
            }
        }

        function refreshStatus() {
            addLog('info', '상태를 새로고침합니다...');
            updateRaspberryPiStatus(15, 25, '대기중', '활성');
            updateAIOverallProgress(0);
            
            if (window.UnifiedCommunicationManager) {
                const commManager = new UnifiedCommunicationManager();
                commManager.getStatus().then(status => {
                    // 라즈베리파이 상태 업데이트
                    updateRaspberryPiStatus(
                        status.cpu || 15,
                        status.memory || 25,
                        status.process || '대기중',
                        status.session || '활성'
                    );
                    addLog('success', '상태가 업데이트되었습니다.');
                }).catch(error => {
                    addLog('error', `상태 새로고침 실패: ${error.message}`);
                });
            }
        }

        function resetSystem() {
            if (confirm('시스템을 초기화하시겠습니까? 모든 진행 상황이 초기화됩니다.')) {
                addLog('warning', '시스템 초기화를 시작합니다...');
                updateRaspberryPiStatus(0, 0, '대기중', '비활성');
                updateAIOverallProgress(0);
                
                // 모든 AI 단계를 대기 상태로 리셋
                for (let i = 1; i <= 4; i++) {
                    updateAIStep(i, 'waiting', 0);
                }
                
                // 아두이노 포트 초기화
                resetArduinoPorts();
                
                if (window.UnifiedCommunicationManager) {
                    const commManager = new UnifiedCommunicationManager();
                    commManager.resetSystem().then(() => {
                        addLog('success', '시스템이 초기화되었습니다.');
                    }).catch(error => {
                        addLog('error', `시스템 초기화 실패: ${error.message}`);
                    });
                }
            }
        }

        function toggleStream() {
            streamActive = !streamActive;
            const btn = document.getElementById('streamBtn');
            const icon = btn.querySelector('.icon');
            
            if (streamActive) {
                icon.classList.remove('icon-wifi');
                icon.classList.add('icon-pause');
                btn.innerHTML = '<span class="icon icon-pause icon-md"></span>실시간 스트림 활성<br><small style="display: block; font-size: 0.7em; opacity: 0.8;">(자동 제어)</small>';
                addLog('info', '실시간 스트림이 활성화되었습니다.');
            } else {
                icon.classList.remove('icon-pause');
                icon.classList.add('icon-wifi');
                btn.innerHTML = '<span class="icon icon-wifi icon-md"></span>실시간 스트림<br><small style="display: block; font-size: 0.7em; opacity: 0.8;">(자동 제어)</small>';
                addLog('info', '실시간 스트림이 비활성화되었습니다.');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                addLog('success', 'URL이 클립보드에 복사되었습니다.');
            }).catch(() => {
                addLog('error', 'URL 복사에 실패했습니다.');
            });
        }

        // 오류 상태 테스트 함수 (개발용)
        function testErrorState(stepNumber) {
            addLog('warning', `${stepNumber}단계에서 오류가 발생했습니다.`);
            updateStepIndicators(0, stepNumber);
        }

        // 단계별 진행 테스트 함수 (개발용)
        function testStepProgress(stepNumber) {
            const percentage = stepNumber * 25;
            addLog('info', `${stepNumber}단계 진행 중... (${percentage}%)`);
            updateStepIndicators(percentage);
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadQRCode();
            initializeUI();
            initializeCommunication();
            
            // 개발용: 단계별 진행 테스트 (자동 실행)
            // setTimeout(() => testStepProgress(1), 2000);
            // setTimeout(() => testStepProgress(2), 4000);
            // setTimeout(() => testStepProgress(3), 6000);
            // setTimeout(() => testStepProgress(4), 8000);
            
            // 개발용: 오류 상태 테스트
            // setTimeout(() => testErrorState(2), 10000);
        });
    </script>
</body>
</html>
