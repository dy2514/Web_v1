<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TETRIS - 데스크탑 관제 (현대차 브랜딩)</title>
    
    <!-- KRDS UI/UX 라이브러리 -->
    <link href="https://cdn.jsdelivr.net/npm/krds-uiux@1.0.3/resources/cdn/krds.min.css" type="text/css" rel="stylesheet" />
    
    <!-- Google Fonts Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- 디자인 시스템 CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    
    <!-- KRDS 표준 추가 스타일 -->
    <style>
        /* ========================================
           KRDS 표준 레이아웃 스타일
           ======================================== */
        
        /* 컨테이너 및 레이아웃 */
        .krds-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
            background: var(--bg-primary);
            min-height: 100vh;
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .krds-header {
            background: linear-gradient(135deg, var(--image-primary) 0%, var(--image-primary-light) 100%);
            border-radius: 12px;
            padding: var(--space-6);
            margin-bottom: var(--space-8);
            color: white;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.15);
        }
        
        .krds-header__content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .krds-header__title h1 {
            margin: 0 0 var(--space-2) 0;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .krds-header__title p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .krds-header__status {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .krds-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--color-error);
        }
        
        .krds-status-indicator--success {
            background: var(--color-success);
        }
        
        .krds-status-indicator--warning {
            background: var(--color-warning);
        }
        
        .krds-status-indicator--danger {
            background: var(--color-error);
        }
        
        /* 그리드 시스템 */
        .krds-grid {
            display: grid;
            gap: var(--space-6);
        }
        
        .krds-grid--12 {
            grid-template-columns: repeat(12, 1fr);
        }
        
        .krds-grid--2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .krds-col {
            display: flex;
            flex-direction: column;
        }
        
        .krds-col--6 {
            grid-column: span 6;
        }
        
        .krds-col--12 {
            grid-column: span 12;
        }
        
        .krds-row {
            display: flex;
            gap: var(--space-6);
        }
        
        /* 카드 스타일 */
        .krds-card {
            background: var(--color-white);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid var(--color-gray-200);
        }
        
        .krds-card__header {
            background: linear-gradient(135deg, var(--image-primary) 0%, var(--image-primary-light) 100%);
            padding: var(--space-6);
            color: white;
        }
        
        .krds-card__title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-2);
        }
        
        .krds-card__title h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .krds-card__body {
            padding: var(--space-6);
        }
        
        /* 아이콘 스타일 */
        .krds-icon {
            font-size: 1.5rem;
        }
        
        .krds-icon--lg {
            font-size: 2rem;
        }
        
        /* 텍스트 스타일 */
        .krds-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .krds-title--xl {
            font-size: 2.5rem;
        }
        
        .krds-title--lg {
            font-size: 1.5rem;
        }
        
        .krds-title--md {
            font-size: 1.25rem;
        }
        
        .krds-text {
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .krds-text--secondary {
            color: var(--text-secondary);
        }
        
        .krds-text--center {
            text-align: center;
        }
        
        .krds-text--small {
            font-size: 0.875rem;
        }
        
        .krds-text--status {
            font-weight: 500;
        }
        
        /* 버튼 스타일 */
        .krds-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-6);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.5;
            text-align: center;
            text-decoration: none;
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            white-space: nowrap;
            min-height: 44px;
        }
        
        .krds-btn--secondary {
            background-color: var(--color-gray-100);
            color: var(--text-primary);
            border-color: var(--color-gray-300);
        }
        
        .krds-btn--secondary:hover {
            background-color: var(--color-gray-200);
            border-color: var(--color-gray-400);
        }
        
        .krds-btn--danger {
            background-color: var(--color-error);
            color: white;
            border-color: var(--color-error);
        }
        
        .krds-btn--danger:hover {
            background-color: var(--color-error-light);
        }
        
        .krds-btn--lg {
            padding: var(--space-4) var(--space-8);
            font-size: 1.125rem;
            min-height: 52px;
        }
        
        .krds-button-group {
            display: flex;
            gap: var(--space-4);
        }
        
        .krds-button-group--center {
            justify-content: center;
        }
        
        /* 배지 스타일 */
        .krds-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 6px;
            border: 1px solid transparent;
        }
        
        .krds-badge--success {
            background-color: var(--color-success-light);
            color: var(--color-success);
            border-color: var(--color-success);
        }
        
        .krds-badge--danger {
            background-color: var(--color-error-light);
            color: var(--color-error);
            border-color: var(--color-error);
        }
        
        .krds-badge--warning {
            background-color: var(--color-warning-light);
            color: var(--color-warning);
            border-color: var(--color-warning);
        }
        
        .krds-badge--secondary {
            background-color: var(--color-gray-100);
            color: var(--text-secondary);
            border-color: var(--color-gray-300);
        }
        
        .krds-badge--primary {
            background-color: var(--color-primary-light);
            color: var(--color-primary);
            border-color: var(--color-primary);
        }
        
        /* 진행률 바 스타일 */
        .krds-progress {
            width: 100%;
            height: 8px;
            background-color: var(--color-gray-200);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .krds-progress__bar {
            height: 100%;
            background-color: var(--color-primary);
            transition: width 0.3s ease;
        }
        
        /* 테이블 스타일 */
        .krds-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-4);
        }
        
        .krds-table th,
        .krds-table td {
            padding: var(--space-3);
            text-align: left;
            border-bottom: 1px solid var(--color-gray-200);
        }
        
        .krds-table th {
            background-color: var(--color-gray-50);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .krds-table tbody tr:hover {
            background-color: var(--color-gray-50);
        }
        
        /* 통계 스타일 */
        .krds-stat {
            text-align: center;
            padding: var(--space-4);
            background: var(--color-gray-50);
            border-radius: 8px;
            border: 1px solid var(--color-gray-200);
        }
        
        .krds-stat__label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-1);
        }
        
        .krds-stat__value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
        }
        
        /* QR 코드 섹션 */
        .qr-section {
            text-align: center;
        }
        
        .qr-code-container {
            width: 120px;
            height: 120px;
            margin: 0 auto var(--space-4);
            border: 2px dashed var(--color-gray-300);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-gray-50);
        }
        
        .qr-code-container img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
        }
        
        /* 상태 타입 */
        .status-type {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .status-type-icon {
            font-size: 1.25rem;
            color: var(--text-secondary);
        }
        
        /* 아두이노 상태 */
        .arduino-status-table {
            margin-top: var(--space-4);
        }
        
        .arduino-header-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-2);
            margin-bottom: var(--space-2);
        }
        
        .arduino-cell-header {
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .arduino-status-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-2);
        }
        
        .arduino-status-block {
            text-align: center;
        }
        
        /* 단계 표시기 */
        .step-indicator-container {
            margin-bottom: var(--space-8);
        }
        
        .step-indicator-container h3 {
            margin-bottom: var(--space-6);
            text-align: center;
        }
        
        .krds-step-wrap {
            display: flex;
            justify-content: space-between;
            align-items: center;
            list-style: none;
            padding: 0;
            margin: 0;
            position: relative;
        }
        
        .krds-step-wrap::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--color-gray-300);
            z-index: 1;
        }
        
        .krds-step-wrap li {
            position: relative;
            z-index: 2;
            background: var(--color-white);
            padding: var(--space-2);
        }
        
        .krds-step-wrap li span {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
        }
        
        .step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--color-gray-300);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .krds-step-wrap li.active .step {
            background: var(--color-primary);
        }
        
        .krds-step-wrap li.done .step {
            background: var(--color-success);
        }
        
        .krds-step-wrap li.error .step {
            background: var(--color-error);
        }
        
        .step-number {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .step-tit {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 600;
            text-align: center;
        }
        
        .step-status-text {
            text-align: center;
            margin-top: var(--space-4);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* 아코디언 스타일 */
        .ai-details-section {
            margin-top: var(--space-8);
        }
        
        .ai-details-section h3 {
            margin-bottom: var(--space-6);
        }
        
        .krds-accordion {
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .accordion-item {
            border-bottom: 1px solid var(--color-gray-200);
        }
        
        .accordion-item:last-child {
            border-bottom: none;
        }
        
        .accordion-header {
            margin: 0;
        }
        
        .btn-accordion {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4);
            background: var(--color-white);
            border: none;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .btn-accordion:hover {
            background: var(--color-gray-50);
        }
        
        .btn-accordion:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: -2px;
        }
        
        .accordion-step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-gray-300);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: var(--space-3);
        }
        
        .accordion-step-title {
            flex: 1;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .accordion-step-status {
            font-size: 0.875rem;
            padding: var(--space-1) var(--space-2);
            border-radius: 4px;
        }
        
        .accordion-collapse {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .accordion-collapse.show {
            max-height: 500px;
        }
        
        .accordion-body {
            padding: var(--space-4);
            background: var(--color-gray-50);
            border-top: 1px solid var(--color-gray-200);
        }
        
        .step-detail-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        .step-progress-section {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .step-progress-section .krds-progress {
            flex: 1;
        }
        
        .step-detail-info {
            background: var(--color-white);
            padding: var(--space-4);
            border-radius: 8px;
            border: 1px solid var(--color-gray-200);
        }
        
        .krds-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .krds-list li {
            padding: var(--space-1) 0;
            color: var(--text-primary);
        }
        
        .krds-list li::before {
            content: '•';
            color: var(--color-primary);
            font-weight: bold;
            margin-right: var(--space-2);
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .krds-grid--12 {
                grid-template-columns: 1fr;
            }
            
            .krds-col--6 {
                grid-column: span 1;
            }
            
            .krds-row {
                flex-direction: column;
            }
            
            .krds-header__content {
                flex-direction: column;
                gap: var(--space-4);
                text-align: center;
            }
            
            .krds-button-group {
                flex-direction: column;
            }
            
            .krds-step-wrap {
                flex-direction: column;
                gap: var(--space-4);
            }
            
            .krds-step-wrap::before {
                display: none;
            }
        }
        
        /* 접근성 */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* 포커스 스타일 */
        *:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }
        
        /* 애니메이션 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .krds-card {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <!-- 메인 컨테이너 -->
    <div class="krds-container">
        <!-- 헤더 섹션 -->
        <header class="krds-header">
            <div class="krds-header__content">
                <div class="krds-header__title">
                    <h1 class="krds-title krds-title--xl">TETRIS Control Dashboard</h1>
                    <p class="krds-text krds-text--secondary">AI 기반 좌석 배치 최적화 시스템</p>
                </div>
                <div class="krds-header__status">
                    <div class="krds-status-indicator" id="connectionIndicator" aria-hidden="true"></div>
                    <span class="krds-text krds-text--status" id="connectionStatus" role="status" aria-live="polite">연결 대기중</span>
                </div>
            </div>
        </header>

        <!-- 메인 콘텐츠 영역 -->
        <main class="krds-main">
            <!-- 그리드 컨테이너 -->
            <div class="krds-grid krds-grid--12">
                
                <!-- 모바일 접속 현황 카드 (6열) -->
                <div class="krds-col krds-col--6">
                    <div class="krds-card">
                        <div class="krds-card__header">
                            <div class="krds-card__title">
                                <span class="material-icons krds-icon krds-icon--lg" aria-hidden="true">smartphone</span>
                                <h2 class="krds-title krds-title--lg">모바일 접속 현황</h2>
                            </div>
                            <p class="krds-text krds-text--secondary">모바일 기기 접속 및 트리거 상태</p>
                        </div>
                        <div class="krds-card__body">
                            <!-- QR 코드 섹션 -->
                            <div class="krds-row">
                                <div class="krds-col krds-col--6">
                                    <div class="qr-section">
                                        <div class="qr-code-container" id="qrCodeContainer">
                                            <div class="qr-code-loading" id="qrCodeText">QR 코드 로딩 중...</div>
                                            <img id="qrCodeImage" src="/desktop/qr.png" alt="접속 QR" style="display: none;">
                                        </div>
                                        <div class="krds-text krds-text--center">
                                            모바일에서 스캔하여 연결하세요
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 상태 테이블 섹션 -->
                                <div class="krds-col krds-col--6">
                                    <div class="status-section">
                                        <table class="krds-table" role="table" aria-label="모바일 접속 현황">
                                            <caption class="sr-only">모바일 기기 접속 상태, 이미지 업로드 상태, 실행 트리거 상태를 표시하는 테이블</caption>
                                            <thead>
                                                <tr>
                                                    <th scope="col">상태 유형</th>
                                                    <th scope="col">현재 상태</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr id="mobileConnectionRow" data-status="disconnected">
                                                    <th scope="row">
                                                        <div class="status-type">
                                                            <span class="material-icons status-type-icon" aria-hidden="true">smartphone</span>
                                                            <span class="status-type-text">모바일 접속 상태</span>
                                                        </div>
                                                    </th>
                                                    <td>
                                                        <span class="krds-badge krds-badge--secondary" id="mobileConnectionStatus" data-status="disconnected">
                                                            <span class="status-indicator" aria-hidden="true"></span>
                                                            <span class="status-text">접속 없음</span>
                                                        </span>
                                                    </td>
                                                </tr>
                                                <tr id="imageUploadRow" data-status="waiting">
                                                    <th scope="row">
                                                        <div class="status-type">
                                                            <span class="material-icons status-type-icon" aria-hidden="true">cloud_upload</span>
                                                            <span class="status-type-text">이미지 업로드 상태</span>
                                                        </div>
                                                    </th>
                                                    <td>
                                                        <span class="krds-badge krds-badge--secondary" id="imageUploadStatus" data-status="waiting">
                                                            <span class="status-indicator" aria-hidden="true"></span>
                                                            <span class="status-text">대기중</span>
                                                        </span>
                                                    </td>
                                                </tr>
                                                <tr id="executionTriggerRow" data-status="inactive">
                                                    <th scope="row">
                                                        <div class="status-type">
                                                            <span class="material-icons status-type-icon" aria-hidden="true">play_circle</span>
                                                            <span class="status-type-text">실행 트리거 작동 여부</span>
                                                        </div>
                                                    </th>
                                                    <td>
                                                        <span class="krds-badge krds-badge--secondary" id="executionTriggerStatus" data-status="inactive">
                                                            <span class="status-indicator" aria-hidden="true"></span>
                                                            <span class="status-text">비활성</span>
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 하드웨어 동작 현황 카드 (6열) -->
                <div class="krds-col krds-col--6">
                    <div class="krds-card">
                        <div class="krds-card__header">
                            <div class="krds-card__title">
                                <span class="material-icons krds-icon krds-icon--lg" aria-hidden="true">settings</span>
                                <h2 class="krds-title krds-title--lg">하드웨어 동작 현황</h2>
                            </div>
                            <p class="krds-text krds-text--secondary">라즈베리파이5 리소스 현황 및 아두이노 통신 현황</p>
                        </div>
                        <div class="krds-card__body">
                            <div class="krds-row">
                                <!-- 라즈베리파이 섹션 -->
                                <div class="krds-col krds-col--6">
                                    <div class="raspberry-section">
                                        <h3 class="krds-title krds-title--md">
                                            <span class="material-icons krds-icon" aria-hidden="true">memory</span>
                                            라즈베리파이5 리소스 현황
                                        </h3>
                                        <div class="krds-grid krds-grid--2">
                                            <div class="krds-col krds-col--6">
                                                <div class="krds-stat">
                                                    <div class="krds-stat__label">CPU</div>
                                                    <div class="krds-stat__value" id="cpuStatusValue">00%</div>
                                                </div>
                                            </div>
                                            <div class="krds-col krds-col--6">
                                                <div class="krds-stat">
                                                    <div class="krds-stat__label">RAM</div>
                                                    <div class="krds-stat__value" id="memoryStatusValue">00%</div>
                                                </div>
                                            </div>
                                            <div class="krds-col krds-col--6">
                                                <div class="krds-stat">
                                                    <div class="krds-stat__label">세션</div>
                                                    <div class="krds-stat__value" id="sessionStatusValue">00%</div>
                                                </div>
                                            </div>
                                            <div class="krds-col krds-col--6">
                                                <div class="krds-stat">
                                                    <div class="krds-stat__label">네트워크</div>
                                                    <div class="krds-stat__value" id="networkStatusValue">00%</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 아두이노 섹션 -->
                                <div class="krds-col krds-col--6">
                                    <div class="arduino-section">
                                        <h3 class="krds-title krds-title--md">
                                            <span class="material-icons krds-icon" aria-hidden="true">usb</span>
                                            아두이노 통신 현황
                                        </h3>
                                        <div class="arduino-connection-status">
                                            <div class="arduino-status-table">
                                                <div class="arduino-header-row">
                                                    <div class="arduino-cell-header">Cell1</div>
                                                    <div class="arduino-cell-header">Cell2</div>
                                                    <div class="arduino-cell-header">Cell3</div>
                                                    <div class="arduino-cell-header">Cell4</div>
                                                </div>
                                                <div class="arduino-status-row">
                                                    <div class="arduino-status-block">
                                                        <span class="krds-badge krds-badge--danger" id="port1Status" data-status="disconnected">
                                                            연결 끊김
                                                        </span>
                                                    </div>
                                                    <div class="arduino-status-block">
                                                        <span class="krds-badge krds-badge--danger" id="port2Status" data-status="disconnected">
                                                            연결 끊김
                                                        </span>
                                                    </div>
                                                    <div class="arduino-status-block">
                                                        <span class="krds-badge krds-badge--danger" id="port3Status" data-status="disconnected">
                                                            연결 끊김
                                                        </span>
                                                    </div>
                                                    <div class="arduino-status-block">
                                                        <span class="krds-badge krds-badge--danger" id="port4Status" data-status="disconnected">
                                                            연결 끊김
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI 처리 단계별 진행 상황 (전체 12열) -->
                <div class="krds-col krds-col--12">
                    <div class="krds-card">
                        <div class="krds-card__header">
                            <div class="krds-card__title">
                                <span class="material-icons krds-icon krds-icon--lg" aria-hidden="true">psychology</span>
                                <h2 class="krds-title krds-title--lg">AI 처리 단계별 진행 상황</h2>
                            </div>
                            <p class="krds-text krds-text--secondary">4단계 AI 체인 처리 과정 및 진행률 표기</p>
                        </div>
                        <div class="krds-card__body">
                            <!-- AI 처리 단계 표시기 -->
                            <div class="step-indicator-container">
                                <h3 class="krds-title krds-title--md">TETRIS AI 처리 진행률</h3>
                                <ol class="krds-step-wrap">
                                    <li id="stepIndicator1" class="active">
                                        <span>
                                            <i class="step" aria-hidden="true"></i>
                                            <span class="step-number">1단계</span>
                                            <span class="step-tit">이미지 분석</span>
                                        </span>
                                    </li>
                                    <li id="stepIndicator2">
                                        <span>
                                            <i class="step" aria-hidden="true"></i>
                                            <span class="step-number">2단계</span>
                                            <span class="step-tit">데이터 처리</span>
                                        </span>
                                    </li>
                                    <li id="stepIndicator3">
                                        <span>
                                            <i class="step" aria-hidden="true"></i>
                                            <span class="step-number">3단계</span>
                                            <span class="step-tit">최적화 생성</span>
                                        </span>
                                    </li>
                                    <li id="stepIndicator4">
                                        <span>
                                            <i class="step" aria-hidden="true"></i>
                                            <span class="step-number">4단계</span>
                                            <span class="step-tit">하드웨어 구동</span>
                                        </span>
                                    </li>
                                </ol>
                                <div class="step-status-text" id="aiProgressStatus" role="status" aria-live="polite" aria-atomic="true">시스템 준비됨</div>
                            </div>
                            
                            <!-- 처리 세부 현황 아코디언 -->
                            <div class="ai-details-section">
                                <h3 class="krds-title krds-title--md">처리 세부 현황</h3>
                                <div class="krds-accordion type-line" role="region" aria-label="AI 처리 세부 현황" aria-live="polite">
                                    <!-- 1단계: 이미지 분석 -->
                                    <div class="accordion-item">
                                        <h5 class="accordion-header">
                                            <button type="button" id="accordionHeaderStep1" class="btn-accordion" aria-controls="accordionCollapseStep1" aria-expanded="false">
                                                <span class="accordion-step-number">1</span>
                                                <span class="accordion-step-title">이미지 분석</span>
                                                <span class="accordion-step-status" id="step1AccordionStatus">대기중</span>
                                            </button>
                                        </h5>
                                        <div id="accordionCollapseStep1" class="accordion-collapse collapse" aria-labelledby="accordionHeaderStep1" aria-hidden="true">
                                            <div class="accordion-body">
                                                <div class="step-detail-content">
                                                    <p class="krds-text">업로드된 이미지에서 좌석과 승객 인식</p>
                                                    <div class="step-progress-section">
                                                        <div class="krds-progress" role="progressbar" aria-label="이미지 분석 진행률" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-valuetext="이미지 분석 진행률: 0%">
                                                            <div class="krds-progress__bar" id="step1Progress" style="width: 0%"></div>
                                                        </div>
                                                        <span class="krds-text krds-text--small" id="step1ProgressText">0%</span>
                                                    </div>
                                                    <div class="step-detail-info" id="step1DetailInfo">
                                                        <ul class="krds-list">
                                                            <li>이미지 업로드 대기중</li>
                                                            <li>AI 모델 준비 완료</li>
                                                            <li>좌석 인식 알고리즘 활성화</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 2단계: 데이터 처리 -->
                                    <div class="accordion-item">
                                        <h5 class="accordion-header">
                                            <button type="button" id="accordionHeaderStep2" class="btn-accordion" aria-controls="accordionCollapseStep2" aria-expanded="false">
                                                <span class="accordion-step-number">2</span>
                                                <span class="accordion-step-title">데이터 처리</span>
                                                <span class="accordion-step-status" id="step2AccordionStatus">대기중</span>
                                            </button>
                                        </h5>
                                        <div id="accordionCollapseStep2" class="accordion-collapse collapse" aria-labelledby="accordionHeaderStep2" aria-hidden="true">
                                            <div class="accordion-body">
                                                <div class="step-detail-content">
                                                    <p class="krds-text">인식된 데이터를 구조화하고 분석</p>
                                                    <div class="step-progress-section">
                                                        <div class="krds-progress" role="progressbar" aria-label="데이터 처리 진행률" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-valuetext="데이터 처리 진행률: 0%">
                                                            <div class="krds-progress__bar" id="step2Progress" style="width: 0%"></div>
                                                        </div>
                                                        <span class="krds-text krds-text--small" id="step2ProgressText">0%</span>
                                                    </div>
                                                    <div class="step-detail-info" id="step2DetailInfo">
                                                        <ul class="krds-list">
                                                            <li>데이터 구조화 대기중</li>
                                                            <li>분석 알고리즘 준비 완료</li>
                                                            <li>데이터 검증 모듈 활성화</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 3단계: 최적화 생성 -->
                                    <div class="accordion-item">
                                        <h5 class="accordion-header">
                                            <button type="button" id="accordionHeaderStep3" class="btn-accordion" aria-controls="accordionCollapseStep3" aria-expanded="false">
                                                <span class="accordion-step-number">3</span>
                                                <span class="accordion-step-title">최적화 생성</span>
                                                <span class="accordion-step-status" id="step3AccordionStatus">대기중</span>
                                            </button>
                                        </h5>
                                        <div id="accordionCollapseStep3" class="accordion-collapse collapse" aria-labelledby="accordionHeaderStep3" aria-hidden="true">
                                            <div class="accordion-body">
                                                <div class="step-detail-content">
                                                    <p class="krds-text">AI 알고리즘으로 최적 좌석 배치 생성</p>
                                                    <div class="step-progress-section">
                                                        <div class="krds-progress" role="progressbar" aria-label="최적화 생성 진행률" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-valuetext="최적화 생성 진행률: 0%">
                                                            <div class="krds-progress__bar" id="step3Progress" style="width: 0%"></div>
                                                        </div>
                                                        <span class="krds-text krds-text--small" id="step3ProgressText">0%</span>
                                                    </div>
                                                    <div class="step-detail-info" id="step3DetailInfo">
                                                        <ul class="krds-list">
                                                            <li>최적화 알고리즘 대기중</li>
                                                            <li>좌석 배치 모델 준비 완료</li>
                                                            <li>시뮬레이션 엔진 활성화</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 4단계: 하드웨어 구동 -->
                                    <div class="accordion-item">
                                        <h5 class="accordion-header">
                                            <button type="button" id="accordionHeaderStep4" class="btn-accordion" aria-controls="accordionCollapseStep4" aria-expanded="false">
                                                <span class="accordion-step-number">4</span>
                                                <span class="accordion-step-title">하드웨어 구동</span>
                                                <span class="accordion-step-status" id="step4AccordionStatus">대기중</span>
                                            </button>
                                        </h5>
                                        <div id="accordionCollapseStep4" class="accordion-collapse collapse" aria-labelledby="accordionHeaderStep4" aria-hidden="true">
                                            <div class="accordion-body">
                                                <div class="step-detail-content">
                                                    <p class="krds-text">모터 제어 코드 생성 및 실행</p>
                                                    <div class="step-progress-section">
                                                        <div class="krds-progress" role="progressbar" aria-label="하드웨어 구동 진행률" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-valuetext="하드웨어 구동 진행률: 0%">
                                                            <div class="krds-progress__bar" id="step4Progress" style="width: 0%"></div>
                                                        </div>
                                                        <span class="krds-text krds-text--small" id="step4ProgressText">0%</span>
                                                    </div>
                                                    <div class="step-detail-info" id="step4DetailInfo">
                                                        <ul class="krds-list">
                                                            <li>모터 제어 코드 대기중</li>
                                                            <li>하드웨어 연결 준비 완료</li>
                                                            <li>실행 모듈 활성화</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 시스템 제어 버튼들 (전체 12열) -->
                <div class="krds-col krds-col--12">
                    <div class="krds-card">
                        <div class="krds-card__header">
                            <div class="krds-card__title">
                                <span class="material-icons krds-icon krds-icon--lg" aria-hidden="true">settings</span>
                                <h2 class="krds-title krds-title--lg">시스템 제어</h2>
                            </div>
                            <p class="krds-text krds-text--secondary">시스템 관리 및 제어</p>
                        </div>
                        <div class="krds-card__body">
                            <div class="krds-button-group krds-button-group--center">
                                <button class="krds-btn krds-btn--secondary krds-btn--lg" onclick="refreshStatus()" aria-label="시스템 상태 새로고침">
                                    <span class="material-icons krds-icon" aria-hidden="true">refresh</span>
                                    상태 새로고침
                                </button>
                                <button class="krds-btn krds-btn--danger krds-btn--lg" onclick="resetSystem()" aria-label="시스템 초기화">
                                    <span class="material-icons krds-icon" aria-hidden="true">restart_alt</span>
                                    시스템 초기화
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- KRDS UI/UX JavaScript -->
    <script defer src="https://cdn.jsdelivr.net/npm/krds-uiux@1.0.3/resources/cdn/krds.min.js"></script>
    
    <!-- 통합 통신 구조 스크립트 -->
    <script src="{{ url_for('static', filename='js/config/frontend-config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils/validation-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils/dom-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/performance-optimizer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/error-handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/unified-communication-manager.js') }}"></script>
    
    <script>
        // ========================================
        // TETRIS Control Dashboard JavaScript
        // KRDS 표준 기반 완전한 기능 구현
        // ========================================
        
        // 전역 변수
        let streamActive = false;
        let streamSource = null;
        let sessionId = null;
        let logsPaused = false;
        let statusUpdateInterval = null;
        let simulationInterval = null;
        
        // ========================================
        // 초기화 및 로딩 함수들
        // ========================================
        
        // QR 코드 로딩
        function loadQRCode() {
            const qrImage = document.getElementById('qrCodeImage');
            const qrText = document.getElementById('qrCodeText');
            
            if (qrImage && qrText) {
                qrImage.onload = function() {
                    qrText.style.display = 'none';
                    qrImage.style.display = 'block';
                };
                
                qrImage.onerror = function() {
                    qrText.textContent = 'QR 코드 로딩 실패';
                    qrText.style.display = 'block';
                    qrImage.style.display = 'none';
                };
                
                // 타임스탬프를 추가하여 캐시 방지
                const timestamp = new Date().getTime();
                qrImage.src = '/desktop/qr.png?t=' + timestamp;
            }
        }

        // ========================================
        // 상태 업데이트 함수들
        // ========================================
        
        // 라즈베리파이 상태 업데이트
        function updateRaspberryPiStatus(cpu, memory, session, network) {
            const cpuElement = document.getElementById('cpuStatusValue');
            const memoryElement = document.getElementById('memoryStatusValue');
            const sessionElement = document.getElementById('sessionStatusValue');
            const networkElement = document.getElementById('networkStatusValue');
            
            if (cpuElement) cpuElement.textContent = `${cpu}%`;
            if (memoryElement) memoryElement.textContent = `${memory}%`;
            if (sessionElement) sessionElement.textContent = session;
            if (networkElement) networkElement.textContent = network || '활성';
            
            // 상태에 따른 색상 업데이트
            updateStatColor(cpuElement, cpu, 'cpu');
            updateStatColor(memoryElement, memory, 'memory');
        }
        
        // 통계 색상 업데이트
        function updateStatColor(element, value, type) {
            if (!element) return;
            
            element.style.color = value > 80 ? 'var(--color-error)' : 
                                 value > 60 ? 'var(--color-warning)' : 
                                 'var(--color-success)';
        }

        // AI 전체 진행률 업데이트
        function updateAIOverallProgress(percentage) {
            const progressStatus = document.getElementById('aiProgressStatus');
            
            // 단계 표시기 상태 업데이트
            updateStepIndicators(percentage);
            
            if (progressStatus) {
                if (percentage === 0) {
                    progressStatus.textContent = '시스템 준비됨';
                } else if (percentage < 25) {
                    progressStatus.textContent = '이미지 분석 중...';
                } else if (percentage < 50) {
                    progressStatus.textContent = '데이터 처리 중...';
                } else if (percentage < 75) {
                    progressStatus.textContent = '최적화 생성 중...';
                } else if (percentage < 100) {
                    progressStatus.textContent = '하드웨어 구동 중...';
                } else {
                    progressStatus.textContent = 'AI 처리 완료!';
                }
            }
        }

        // 단계 표시기 상태 업데이트 함수 (KRDS 표준)
        function updateStepIndicators(percentage, errorStep = null) {
            const steps = [
                document.getElementById('stepIndicator1'),
                document.getElementById('stepIndicator2'),
                document.getElementById('stepIndicator3'),
                document.getElementById('stepIndicator4')
            ];
            
            steps.forEach((step, index) => {
                if (step) {
                    // 모든 상태 클래스 제거
                    step.classList.remove('done', 'active', 'error');
                    
                    const stepThreshold = (index + 1) * 25;
                    
                    // 오류 상태 처리
                    if (errorStep === index + 1) {
                        step.classList.add('error');
                        return;
                    }
                    
                    if (percentage >= stepThreshold) {
                        // 완료된 단계
                        step.classList.add('done');
                    } else if (percentage >= stepThreshold - 25) {
                        // 현재 진행 중인 단계
                        step.classList.add('active');
                    }
                }
            });
        }

        // AI 단계 업데이트 (아코디언 형식)
        function updateAIStep(stepNumber, status, progress = 0) {
            // 전체 진행률로 변환
            const overallProgress = (stepNumber - 1) * 25 + (progress * 0.25);
            updateAIOverallProgress(overallProgress);
            
            // 아코디언 진행률 업데이트
            const accordionProgressFill = document.getElementById(`step${stepNumber}Progress`);
            const accordionProgressText = document.getElementById(`step${stepNumber}ProgressText`);
            const accordionStatus = document.getElementById(`step${stepNumber}AccordionStatus`);
            
            if (accordionProgressFill && accordionProgressText && accordionStatus) {
                accordionProgressFill.style.width = `${progress}%`;
                accordionProgressText.textContent = `${progress}%`;
                
                // 진행률 바 접근성 속성 업데이트
                const accordionProgressBar = document.querySelector(`#accordionHeaderStep${stepNumber}`)?.closest('.accordion-item')?.querySelector('.krds-progress');
                if (accordionProgressBar) {
                    accordionProgressBar.setAttribute('aria-valuenow', progress);
                    accordionProgressBar.setAttribute('aria-valuetext', `${accordionProgressBar.getAttribute('aria-label')}: ${progress}%`);
                }
                
                // 상태에 따른 배지 클래스 업데이트
                accordionStatus.className = 'krds-badge ';
                switch(status) {
                    case 'completed':
                        accordionStatus.textContent = '완료';
                        accordionStatus.className += 'krds-badge--success';
                        break;
                    case 'active':
                        accordionStatus.textContent = '진행중';
                        accordionStatus.className += 'krds-badge--primary';
                        break;
                    case 'waiting':
                        accordionStatus.textContent = '대기중';
                        accordionStatus.className += 'krds-badge--secondary';
                        break;
                    case 'error':
                        accordionStatus.textContent = '오류';
                        accordionStatus.className += 'krds-badge--danger';
                        break;
                    default:
                        accordionStatus.textContent = '대기중';
                        accordionStatus.className += 'krds-badge--secondary';
                }
            }
        }

        // 모바일 상태 업데이트 함수들
        function updateMobileConnectionStatus(status) {
            const rowElement = document.getElementById('mobileConnectionRow');
            const statusElement = document.getElementById('mobileConnectionStatus');
            const statusText = statusElement?.querySelector('.status-text');
            
            if (rowElement && statusElement && statusText) {
                rowElement.setAttribute('data-status', status);
                statusElement.setAttribute('data-status', status);
                
                statusElement.className = 'krds-badge ';
                switch(status) {
                    case 'connected':
                        statusText.textContent = '접속됨';
                        statusElement.className += 'krds-badge--success';
                        break;
                    case 'disconnected':
                        statusText.textContent = '접속 없음';
                        statusElement.className += 'krds-badge--secondary';
                        break;
                    default:
                        statusText.textContent = '알 수 없음';
                        statusElement.className += 'krds-badge--warning';
                }
            }
        }

        function updateImageUploadStatus(status) {
            const rowElement = document.getElementById('imageUploadRow');
            const statusElement = document.getElementById('imageUploadStatus');
            const statusText = statusElement?.querySelector('.status-text');
            
            if (rowElement && statusElement && statusText) {
                rowElement.setAttribute('data-status', status);
                statusElement.setAttribute('data-status', status);
                
                statusElement.className = 'krds-badge ';
                switch(status) {
                    case 'uploading':
                        statusText.textContent = '업로드중';
                        statusElement.className += 'krds-badge--primary';
                        break;
                    case 'completed':
                        statusText.textContent = '완료';
                        statusElement.className += 'krds-badge--success';
                        break;
                    case 'waiting':
                        statusText.textContent = '대기중';
                        statusElement.className += 'krds-badge--secondary';
                        break;
                    case 'error':
                        statusText.textContent = '오류';
                        statusElement.className += 'krds-badge--danger';
                        break;
                    default:
                        statusText.textContent = '대기중';
                        statusElement.className += 'krds-badge--secondary';
                }
            }
        }

        function updateExecutionTriggerStatus(status) {
            const rowElement = document.getElementById('executionTriggerRow');
            const statusElement = document.getElementById('executionTriggerStatus');
            const statusText = statusElement?.querySelector('.status-text');
            
            if (rowElement && statusElement && statusText) {
                rowElement.setAttribute('data-status', status);
                statusElement.setAttribute('data-status', status);
                
                statusElement.className = 'krds-badge ';
                switch(status) {
                    case 'active':
                        statusText.textContent = '활성';
                        statusElement.className += 'krds-badge--success';
                        break;
                    case 'inactive':
                        statusText.textContent = '비활성';
                        statusElement.className += 'krds-badge--secondary';
                        break;
                    case 'processing':
                        statusText.textContent = '처리중';
                        statusElement.className += 'krds-badge--primary';
                        break;
                    default:
                        statusText.textContent = '비활성';
                        statusElement.className += 'krds-badge--secondary';
                }
            }
        }

        // 포트 상태 업데이트 함수
        function updatePortStatus(portNumber, status) {
            const statusElement = document.getElementById(`port${portNumber}Status`);
            
            if (statusElement) {
                statusElement.setAttribute('data-status', status);
                
                statusElement.className = 'krds-badge ';
                switch(status) {
                    case 'connected':
                        statusElement.textContent = '연결됨';
                        statusElement.className += 'krds-badge--success';
                        break;
                    case 'disconnected':
                        statusElement.textContent = '연결 끊김';
                        statusElement.className += 'krds-badge--danger';
                        break;
                    default:
                        statusElement.textContent = '알 수 없음';
                        statusElement.className += 'krds-badge--warning';
                }
            }
        }

        // 아두이노 포트 초기화
        function resetArduinoPorts() {
            for (let i = 1; i <= 4; i++) {
                updatePortStatus(i, 'disconnected');
            }
        }

        // 헤더 연결 상태 업데이트
        function updateHeaderConnectionStatus() {
            const connectionIndicator = document.getElementById('connectionIndicator');
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (!connectionIndicator || !connectionStatus) return;
            
            // 아두이노 포트 연결 상태 체크
            let connectedPorts = 0;
            let totalPorts = 4;
            
            for (let i = 1; i <= totalPorts; i++) {
                const portStatusElement = document.getElementById(`port${i}Status`);
                if (portStatusElement && portStatusElement.getAttribute('data-status') === 'connected') {
                    connectedPorts++;
                }
            }
            
            // 전체 연결 상태 결정
            connectionIndicator.className = 'krds-status-indicator ';
            if (connectedPorts === totalPorts) {
                connectionIndicator.className += 'krds-status-indicator--success';
                connectionStatus.textContent = '시스템 정상';
            } else if (connectedPorts > 0) {
                connectionIndicator.className += 'krds-status-indicator--warning';
                connectionStatus.textContent = '부분 연결';
            } else {
                connectionIndicator.className += 'krds-status-indicator--danger';
                connectionStatus.textContent = '시스템 오프라인';
            }
        }

        // ========================================
        // UI 상호작용 함수들
        // ========================================
        
        // 아코디언 토글 기능
        function initializeAccordion() {
            const accordionButtons = document.querySelectorAll('.btn-accordion');
            
            accordionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('aria-controls');
                    const targetCollapse = document.getElementById(targetId);
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';
                    
                    if (targetCollapse) {
                        // 현재 상태 토글
                        if (isExpanded) {
                            this.setAttribute('aria-expanded', 'false');
                            targetCollapse.classList.remove('show');
                            targetCollapse.setAttribute('aria-hidden', 'true');
                        } else {
                            this.setAttribute('aria-expanded', 'true');
                            targetCollapse.classList.add('show');
                            targetCollapse.setAttribute('aria-hidden', 'false');
                        }
                    }
                });
            });
        }

        // ========================================
        // 시뮬레이션 및 테스트 함수들
        // ========================================
        
        // 상태 시뮬레이션 시작
        function startStatusSimulation() {
            if (statusUpdateInterval) clearInterval(statusUpdateInterval);
            
            statusUpdateInterval = setInterval(() => {
                // CPU와 메모리 사용률 시뮬레이션
                const cpu = Math.floor(Math.random() * 30) + 10; // 10-40%
                const memory = Math.floor(Math.random() * 40) + 20; // 20-60%
                const session = Math.random() > 0.3 ? '활성' : '대기중';
                const network = Math.random() > 0.1 ? '활성' : '비활성';
                
                updateRaspberryPiStatus(cpu, memory, session, network);
                
                // 모바일 상태 시뮬레이션
                const mobileStatuses = ['connected', 'disconnected'];
                const uploadStatuses = ['waiting', 'uploading', 'completed'];
                const triggerStatuses = ['active', 'inactive', 'processing'];
                
                if (Math.random() > 0.7) {
                    updateMobileConnectionStatus(mobileStatuses[Math.floor(Math.random() * mobileStatuses.length)]);
                }
                
                if (Math.random() > 0.8) {
                    updateImageUploadStatus(uploadStatuses[Math.floor(Math.random() * uploadStatuses.length)]);
                }
                
                if (Math.random() > 0.9) {
                    updateExecutionTriggerStatus(triggerStatuses[Math.floor(Math.random() * triggerStatuses.length)]);
                }
                
                // 포트 상태 시뮬레이션
                if (Math.random() > 0.95) {
                    const portNumber = Math.floor(Math.random() * 4) + 1;
                    const portStatus = Math.random() > 0.5 ? 'connected' : 'disconnected';
                    updatePortStatus(portNumber, portStatus);
                    updateHeaderConnectionStatus();
                }
            }, 3000); // 3초마다 업데이트
        }

        // AI 처리 시뮬레이션
        function startAISimulation() {
            if (simulationInterval) clearInterval(simulationInterval);
            
            let currentStep = 1;
            let currentProgress = 0;
            
            simulationInterval = setInterval(() => {
                if (currentProgress >= 100) {
                    currentProgress = 0;
                    currentStep++;
                    
                    if (currentStep > 4) {
                        currentStep = 1;
                        updateAIStep(4, 'completed', 100);
                        setTimeout(() => {
                            updateAIOverallProgress(0);
                            for (let i = 1; i <= 4; i++) {
                                updateAIStep(i, 'waiting', 0);
                            }
                        }, 2000);
                        return;
                    }
                }
                
                currentProgress += Math.floor(Math.random() * 10) + 5;
                if (currentProgress > 100) currentProgress = 100;
                
                updateAIStep(currentStep, 'active', currentProgress);
                
                if (currentProgress === 100) {
                    updateAIStep(currentStep, 'completed', 100);
                }
            }, 1000); // 1초마다 업데이트
        }

        // ========================================
        // 시스템 제어 함수들
        // ========================================
        
        function refreshStatus() {
            console.log('상태 새로고침 중...');
            
            // 즉시 상태 업데이트
            updateRaspberryPiStatus(15, 25, '활성', '활성');
            updateAIOverallProgress(0);
            
            // 모든 상태를 초기 상태로 리셋
            updateMobileConnectionStatus('disconnected');
            updateImageUploadStatus('waiting');
            updateExecutionTriggerStatus('inactive');
            resetArduinoPorts();
            updateHeaderConnectionStatus();
            
            // 시뮬레이션 재시작
            startStatusSimulation();
            
            // 통신 매니저가 있는 경우
            if (window.UnifiedCommunicationManager) {
                const commManager = new UnifiedCommunicationManager();
                commManager.getStatus().then(status => {
                    updateRaspberryPiStatus(
                        status.cpu || 15,
                        status.memory || 25,
                        status.process || '대기중',
                        status.session || '활성'
                    );
                }).catch(error => {
                    console.error('상태 새로고침 실패:', error);
                });
            }
        }

        function resetSystem() {
            if (confirm('시스템을 초기화하시겠습니까? 모든 진행 상황이 초기화됩니다.')) {
                console.log('시스템 초기화 중...');
                
                // 모든 상태 초기화
                updateRaspberryPiStatus(0, 0, '비활성', '비활성');
                updateAIOverallProgress(0);
                
                // 모든 AI 단계를 대기 상태로 리셋
                for (let i = 1; i <= 4; i++) {
                    updateAIStep(i, 'waiting', 0);
                }
                
                // 모든 하드웨어 상태 초기화
                resetArduinoPorts();
                updateMobileConnectionStatus('disconnected');
                updateImageUploadStatus('waiting');
                updateExecutionTriggerStatus('inactive');
                updateHeaderConnectionStatus();
                
                // 시뮬레이션 중지
                if (statusUpdateInterval) {
                    clearInterval(statusUpdateInterval);
                    statusUpdateInterval = null;
                }
                
                if (simulationInterval) {
                    clearInterval(simulationInterval);
                    simulationInterval = null;
                }
                
                // 통신 매니저가 있는 경우
                if (window.UnifiedCommunicationManager) {
                    const commManager = new UnifiedCommunicationManager();
                    commManager.resetSystem().then(() => {
                        console.log('시스템이 초기화되었습니다.');
                    }).catch(error => {
                        console.error('시스템 초기화 실패:', error);
                    });
                }
            }
        }

        // ========================================
        // 통신 및 초기화 함수들
        // ========================================
        
        // 초기 UI 상태 설정
        function initializeUI() {
            console.log('UI 초기화 중...');
            
            // 초기 상태 설정
            updateRaspberryPiStatus(0, 0, '대기중', '비활성');
            updateAIOverallProgress(0);
            
            // 아두이노 포트 초기 상태 설정
            resetArduinoPorts();
            
            // 모바일 상태 트리거 초기 상태 설정
            updateMobileConnectionStatus('disconnected');
            updateImageUploadStatus('waiting');
            updateExecutionTriggerStatus('inactive');
            
            // 헤더 연결 상태 업데이트
            updateHeaderConnectionStatus();
            
            // 아코디언 초기화
            initializeAccordion();
            
            console.log('UI 초기화 완료');
        }

        // 통신 매니저 초기화
        function initializeCommunication() {
            console.log('통신 매니저 초기화 중...');
            
            if (window.UnifiedCommunicationManager) {
                const commManager = new UnifiedCommunicationManager();
                
                // 세션 시작
                commManager.startSession().then(session => {
                    sessionId = session.session_id;
                    console.log('세션 시작됨:', sessionId);
                    updateRaspberryPiStatus(15, 25, '활성', '활성');
                }).catch(error => {
                    console.error('세션 시작 실패:', error);
                    // 오프라인 모드로 전환
                    updateRaspberryPiStatus(5, 10, '오프라인', '비활성');
                });
                
                // SSE 메시지 처리
                commManager.on('progress', (data) => {
                    updateAIOverallProgress(data.progress);
                    
                    if (data.step) {
                        updateAIStep(data.step, 'active', data.step_progress || 0);
                    }
                });
                
                // 에러 처리
                commManager.on('error', (error) => {
                    console.error('통신 오류:', error);
                });
            } else {
                console.log('통신 매니저가 없습니다. 오프라인 모드로 실행합니다.');
                // 오프라인 모드에서도 시뮬레이션 실행
                startStatusSimulation();
            }
        }

        // ========================================
        // 페이지 로드 및 이벤트 리스너
        // ========================================
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('TETRIS Control Dashboard 로딩 시작');
            
            // 기본 초기화
            loadQRCode();
            initializeUI();
            initializeCommunication();
            
            // 시뮬레이션 시작 (테스트용)
            setTimeout(() => {
                startStatusSimulation();
                // startAISimulation(); // AI 시뮬레이션은 필요시 수동으로 시작
            }, 2000);
            
            console.log('TETRIS Control Dashboard 로딩 완료');
        });

        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', function() {
            if (statusUpdateInterval) clearInterval(statusUpdateInterval);
            if (simulationInterval) clearInterval(simulationInterval);
        });

        // 키보드 단축키
        document.addEventListener('keydown', function(e) {
            // Ctrl + R: 상태 새로고침
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshStatus();
            }
            // Ctrl + Shift + R: 시스템 초기화
            if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                e.preventDefault();
                resetSystem();
            }
        });

        // ========================================
        // 전역 함수 노출 (HTML에서 호출용)
        // ========================================
        
        window.refreshStatus = refreshStatus;
        window.resetSystem = resetSystem;
        window.updateAIStep = updateAIStep;
        window.startAISimulation = startAISimulation;
    </script>
</body>
</html>