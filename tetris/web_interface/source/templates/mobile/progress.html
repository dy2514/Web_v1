<!DOCTYPE html>
<html lang="ko">
<head>
    <link href="https://cdn.jsdelivr.net/npm/krds-uiux@1.0.3/resources/cdn/krds.min.css" type="text/css" rel="stylesheet" />
    <script defer src="https://cdn.jsdelivr.net/npm/krds-uiux@1.0.3/resources/cdn/krds.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Î∂ÑÏÑù ÏßÑÌñâ Ï§ë - AI TETRIS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hyundai Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            color: #2d3748;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: white;
            padding: 10px 12px;
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        
        .title {
            font-size: 20px;
            font-weight: 700;
            color: white;
            text-align: center;
            flex: 1;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .refresh-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: white;
            padding: 10px 12px;
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        
        .main-content {
            /* background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%); */
            margin-top: 100px;
            padding: 32px 20px;
            text-align: center;
            max-width: 480px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .status-message {
            margin-bottom: 40px;
        }
        
        .status-title {
            font-size: 28px;
            font-weight: 800;
            color: #1a365d;
            letter-spacing: -0.5px;
        }
        
        .status-subtitle {
            font-size: 14px;
            color: #4a5568;
            font-weight: 500;
            opacity: 0.8;
        }
        
        .progress-info {
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            padding: 20px 24px;
            border-radius: 10px;
            margin-bottom: 32px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .progress-percentage {
            font-size: 40px;
            font-weight: 800;
            color: #1a365d;
            margin-bottom: 10px;
            text-shadow: 0 2px 8px rgba(26, 54, 93, 0.15);
            letter-spacing: -1px;
        }
        
        .progress-text {
            font-size: 18px;
            color: #4a5568;
            font-weight: 500;
            line-height: 1.4;
        }
        
        .illustration {
            margin: 30px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .ai-brain {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 50%, #4a5568 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: pulse 2s infinite;
            box-shadow: 0 12px 40px rgba(26, 54, 93, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .ai-brain::before {
            content: "üöó";
            font-size: 48px;
        }
        
        .ai-brain::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid #002c5f;
            animation: ripple 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes ripple {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        
        .progress-steps {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 44, 95, 0.15);
            border: 1px solid rgba(0, 44, 95, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            flex: 1;
            min-width: 0;
            text-align: center;
            position: relative;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 2px;
            background: linear-gradient(90deg, #e9ecef 0%, #dee2e6 100%);
            z-index: 1;
        }
        
        .step.completed:not(:last-child)::after {
            background: linear-gradient(90deg, #00a651 0%, #00c853 100%);
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .step-icon.pending {
            background: #f7fafc;
            color: #a0aec0;
            border: 2px solid #e2e8f0;
        }
        
        .step-icon.active {
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            color: white;
            animation: pulse 1.5s infinite;
            box-shadow: 0 6px 20px rgba(26, 54, 93, 0.25);
            transform: scale(1.05);
        }
        
        .step-icon.completed {
            background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(56, 161, 105, 0.25);
            transform: scale(1.02);
        }
        
        .step-content {
            flex: 1;
            text-align: center;
        }
        
        .step-title {
            font-size: 12px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 6px;
            line-height: 1.3;
            letter-spacing: -0.2px;
        }
        
        .step-description {
            font-size: 10px;
            color: #718096;
            line-height: 1.3;
            font-weight: 500;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .result-check-button {
            width: 100%;
            padding: 20px 24px;
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(26, 54, 93, 0.25);
            letter-spacing: -0.3px;
            display: none;
        }
        
        .result-check-button.show {
            display: block;
        }
        
        .result-check-button:hover {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(26, 54, 93, 0.35);
        }
        
        .result-check-button:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(26, 54, 93, 0.3);
        }
        
        /* ÏÉÅÏÑ∏ Î≥¥Í∏∞ Ìå®ÎÑê (Ïò§Î≤ÑÎ†àÏù¥) */
        .detail-panel {
            margin-top: 78px;
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: #ffffff;
            display: none;
            z-index: 1000;
            overflow-y: auto;
            padding: 16px;
        }
        .detail-panel.show { display: block; }
        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            text-align: center;
        }
        .detail-back-btn {
            display: block;
            margin: auto;
            padding: 10px 16px;
            border: 2px solid #30507a;
            border-radius: 12px;
            background: #f8fbff;
            color: #203a59;
            font-weight: 700;
        }
        .detail-toggle-btn {
            display: inline-block;
            margin: 10px auto 0;
            padding: 10px 18px;
            border: 2px solid #30507a;
            background: #ffffff;
            border-radius: 10px;
            color: #203a59;
            font-weight: 700;
        }

        /* ÏÉÅÏÑ∏ Ìå®ÎÑê ÏÉÅÎã® ÏßÑÌñâ Ïπ¥Îìú */
        .detail-progress-card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e6eef6;
            box-shadow: 0 4px 14px rgba(32, 58, 89, 0.06);
            padding: 16px;
            margin-bottom: 12px;
            text-align: center;
        }
        .detail-progress-percentage {
            font-size: 28px;
            font-weight: 800;
            color: #1a365d;
            letter-spacing: -0.3px;
        }
        .detail-progress-text {
            margin-top: 6px;
            font-size: 14px;
            color: #4a5568;
        }

        /* ÏÉÅÏÑ∏ Ìå®ÎÑê - ÏßÑÌñâ ÌÉÄÏûÑÎùºÏù∏ */
        .timeline {
            margin: 6px 4px 16px 8px;
            position: relative;
            padding-left: 20px;
        }
        .timeline:before {
            content: "";
            position: absolute;
            left: 9px;
            top: 6px;
            bottom: 6px;
            width: 2px;
            background: #e2e8f0;
        }
        .timeline-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            color: #94a3b8;
            font-weight: 700;
        }
        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #cbd5e1;
            border: 2px solid #cbd5e1;
            box-sizing: content-box;
        }
        .timeline-item.active { color: #0f766e; }
        .timeline-item.active .timeline-dot {
            background: #14b8a6;
            border-color: #0f766e;
        }
        .timeline-item.completed { color: #0f766e; }
        .timeline-item.completed .timeline-dot {
            background: #14b8a6;
            border-color: #14b8a6;
        }
        
        /* Ìñ•ÏÉÅÎêú Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .main-content {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .progress-info {
            animation: slideIn 0.8s ease-out;
        }
        
        .progress-steps {
            animation: fadeInUp 1s ease-out;
        }
        
        /* Îã®Í≥ÑÎ≥Ñ Í≤∞Í≥º ÌëúÏãú ÏòÅÏó≠ */
        .step-results {
            margin-top: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }
        
        .step-result-item {
            margin-bottom: 16px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #e2e8f0;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
        }
        
        .step-result-item.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .step-result-item.completed {
            border-left-color: #38a169;
            background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
        }
        
        .step-result-title {
            font-size: 14px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .step-result-title::before {
            content: "‚úì";
            margin-right: 8px;
            color: #38a169;
            font-weight: 800;
        }
        
        .step-result-content {
            font-size: 13px;
            color: #4a5568;
            line-height: 1.5;
            background: #f7fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .step-result-content pre {
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            background: transparent;
            padding: 0;
            border: none;
        }
        
        /* Ìëú Ïä§ÌÉÄÏùº */
        .step-result-content table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            margin: 12px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .step-result-content table thead {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        .step-result-content table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .step-result-content table td {
            padding: 12px 16px;
            font-size: 13px;
            color: #4a5568;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .step-result-content table tbody tr:hover {
            background: #f8fafc;
        }
        
        .step-result-content table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Ìëú ÎÇ¥Î∂Ä pre ÌÉúÍ∑∏ Ïä§ÌÉÄÏùº */
        .step-result-content table pre {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin: 4px 0;
            border: 1px solid #e9ecef;
            max-height: 150px;
            overflow-y: auto;
        }
        
        /* Î∂ÑÏÑù Í≤∞Í≥º ÏöîÏïΩ ÏòÅÏó≠ Ïä§ÌÉÄÏùº */
        .analysis-summary {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .summary-title {
            color: #2d3748;
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 16px 0;
            text-align: center;
        }
        
        .summary-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .summary-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #00a651;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .summary-item-title {
            color: #2d3748;
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }
        
        .summary-item-content {
            color: #4a5568;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .summary-item-content strong {
            color: #2d3748;
            font-weight: 600;
        }
        
        /* Îã®Í≥ÑÎ≥Ñ ÏôÑÎ£å ÌÖçÏä§Ìä∏ ÌëúÏãú */
        .step-completion-text {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
            border-radius: 8px;
            border-left: 4px solid #38a169;
            font-size: 14px;
            color: #2d3748;
            line-height: 1.5;
            animation: slideInFromRight 0.5s ease-out;
        }
        
        .step-completion-text h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 700;
            color: #38a169;
            display: flex;
            align-items: center;
        }
        
        .step-completion-text h4::before {
            content: "‚úÖ";
            margin-right: 8px;
            font-size: 18px;
        }
        
        .step-completion-text p {
            margin: 8px 0;
            font-size: 13px;
            color: #4a5568;
        }
        
        .step-completion-text .highlight {
            background: #e6fffa;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .accordion-item {
            font-size: 12px;
            color: #000;
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="history.back()">‚úï</button>
        <h1 class="title">ÌòÑÎåÄÏûêÎèôÏ∞® AI TETRIS ÏÑúÎπÑÏä§</h1>
        <button class="refresh-btn" onclick="location.reload()">‚Üª</button>
    </div>
    
    <div class="main-content">
        <div class="status-message">
            <h2 class="status-title">Ï∞®Îüâ ÏãúÌä∏ Î∞∞Ïπò Î∂ÑÏÑù</h2>
            <!-- <p class="status-subtitle">Ï∞®Îüâ ÏãúÌä∏ Î∞∞Ïπò Î∂ÑÏÑù</p> -->
        </div>

        <div class="illustration">
            <div class="ai-brain"></div>
        </div>

        <div class="progress-info">
            <div class="progress-percentage" id="progressPercentage">0%</div>
            <div class="progress-text" id="progressText">Î∂ÑÏÑùÏùÑ ÏãúÏûëÌïòÍ≥† ÏûàÏäµÎãàÎã§...</div>
            </div>
        
        <div class="progress-steps">
            <div class="step" id="step1">
                <div class="step-icon pending">1</div>
                <div class="step-content">
                    <div class="step-title">Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù</div>
                    <div class="step-description">ÏÇ¨ÏßÑÏùÑ Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§</div>
        </div>
            </div>
            
            <div class="step" id="step2">
                <div class="step-icon pending">2</div>
                <div class="step-content">
                    <div class="step-title">Ïßê Ïù∏Ïãù Î∞è Î∂ÑÎ•ò</div>
                    <div class="step-description">ÏßêÏùÑ Ïù∏ÏãùÌïòÍ≥† Î∂ÑÎ•òÌïòÍ≥† ÏûàÏäµÎãàÎã§</div>
            </div>
        </div>
            
            <div class="step" id="step3">
                <div class="step-icon pending">3</div>
                <div class="step-content">
                    <div class="step-title">Ï∞®Îüâ Í≥µÍ∞Ñ Í≥ÑÏÇ∞</div>
                    <div class="step-description">Ï∞®Îüâ Í≥µÍ∞ÑÏùÑ Í≥ÑÏÇ∞ÌïòÍ≥† ÏûàÏäµÎãàÎã§</div>
                </div>
        </div>
            
            <div class="step" id="step4">
                <div class="step-icon pending">4</div>
                <div class="step-content">
                    <div class="step-title">ÏµúÏ†Å Î∞∞Ïπò ÏÉùÏÑ±</div>
                    <div class="step-description">ÏµúÏ†ÅÏùò Î∞∞ÏπòÎ•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§</div>
                </div>
        </div>
            
            <div class="step" id="step5">
                <div class="step-icon pending">5</div>
                <div class="step-content">
                    <div class="step-title">Í≤∞Í≥º Í≤ÄÏ¶ù Î∞è ÏôÑÎ£å</div>
                    <div class="step-description">Í≤∞Í≥ºÎ•º Í≤ÄÏ¶ùÌïòÍ≥† ÏûàÏäµÎãàÎã§</div>
                </div>
            </div>
        </div>
        
        <!-- Îã®Í≥ÑÎ≥Ñ Î∂ÑÏÑù Í≤∞Í≥º ÌëúÏãú ÏòÅÏó≠ (Í∏∞Î≥∏ ÌôîÎ©¥ÏóêÏÑúÎäî Ïà®ÍπÄ) -->
        <div class="step-results" id="stepResults" style="display:none;">
            <div class="step-result-item" id="step1Result" style="display: none;">
                <div class="step-result-title">1Îã®Í≥Ñ: Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Í≤∞Í≥º</div>
                <div class="step-result-content" id="step1ResultContent">Î∂ÑÏÑù Ï§ë...</div>
            </div>
            
            <div class="step-result-item" id="step2Result" style="display: none;">
                <div class="step-result-title">2Îã®Í≥Ñ: Ïßê Ïù∏Ïãù Î∞è Î∂ÑÎ•ò Í≤∞Í≥º</div>
                <div class="step-result-content" id="step2ResultContent">Î∂ÑÏÑù Ï§ë...</div>
            </div>
            
            <div class="step-result-item" id="step3Result" style="display: none;">
                <div class="step-result-title">3Îã®Í≥Ñ: Ï∞®Îüâ Í≥µÍ∞Ñ Í≥ÑÏÇ∞ Í≤∞Í≥º</div>
                <div class="step-result-content" id="step3ResultContent">Î∂ÑÏÑù Ï§ë...</div>
            </div>
            
            <div class="step-result-item" id="step4Result" style="display: none;">
                <div class="step-result-title">4Îã®Í≥Ñ: ÏµúÏ†Å Î∞∞Ïπò ÏÉùÏÑ± Í≤∞Í≥º</div>
                <div class="step-result-content" id="step4ResultContent">Î∂ÑÏÑù Ï§ë...</div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <button class="result-check-button" id="resultCheckButton" onclick="openDetailPanel()">ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î≥¥Í∏∞</button>
</div>

    <!-- ÏÉÅÏÑ∏ Î≥¥Í∏∞ Ìå®ÎÑê (Î∂ÑÏÑù Í≤∞Í≥º) -->
    <div class="detail-panel" id="detailPanel" aria-hidden="true">
        <div class="detail-header">
            <h2 style="margin:0; font-size:18px; text-align: center; color:#203a59;">Î∂ÑÏÑù ÏÉÅÏÑ∏</h2>
        </div>
        
        <!-- ÏÉÅÏÑ∏ ÏßÑÌñâ Ïπ¥Îìú -->
        <div class="detail-progress-card">
            <div class="detail-progress-percentage" id="detailProgressPercentage">0%</div>
            <div class="detail-progress-text" id="detailProgressText">Î∂ÑÏÑùÏùÑ ÏãúÏûëÌïòÍ≥† ÏûàÏäµÎãàÎã§...</div>
        </div>
        
        <!-- ÏßÑÌñâ ÌÉÄÏûÑÎùºÏù∏ -->
        <div class="timeline" id="detailTimeline">
            <div style="border: none; color: black;" class="krds-accordion">
                <div class="timeline-item" id="tl-step-1">
                    <span class="timeline-dot"></span>
                    <div id="accordionItem01"> <!-- class="accordion-item"-->
                        <h5 class="accordion-header"><button type="button" id="accordionHeaderSample01" class="btn-accordion" aria-controls="accordionCollapseSample01">Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù</button></h5>
                        <div style="display: none;" id="accordionCollapseSample01" class="accordion-collapse collapse" aria-labelledby="accordionHeaderSample01">
                        <div class="accordion-body">
                            <!-- ÏïÑÏΩîÎîîÏñ∏ ÎÇ¥Ïö© ÏòÅÏó≠ -->
                        </div>
                        </div>
                    </div>
                </div>
                <div class="timeline-item" id="tl-step-2">
                    <span class="timeline-dot"></span>
                    <div id="accordionItem02"> <!-- class="accordion-item"-->
                        <h5 class="accordion-header"><button type="button" id="accordionHeaderSample02" class="btn-accordion" aria-controls="accordionCollapseSample02">Ïßê Ïù∏Ïãù Î∞è Î∂ÑÎ•ò</button></h5>
                        <div style="display: none;" id="accordionCollapseSample02" class="accordion-collapse collapse" aria-labelledby="accordionHeaderSample02">
                        <div class="accordion-body">
                            <!-- ÏïÑÏΩîÎîîÏñ∏ ÎÇ¥Ïö© ÏòÅÏó≠ -->
                        </div>
                        </div>
                    </div>
                </div>
                <div class="timeline-item" id="tl-step-3">
                    <span class="timeline-dot"></span>
                    <div id="accordionItem03"> <!-- class="accordion-item"-->
                        <h5 class="accordion-header"><button type="button" id="accordionHeaderSample03" class="btn-accordion" aria-controls="accordionCollapseSample03">Ï∞®Îüâ Í≥µÍ∞Ñ Í≥ÑÏÇ∞</button></h5>
                        <div style="display: none;" id="accordionCollapseSample03" class="accordion-collapse collapse" aria-labelledby="accordionHeaderSample03">
                        <div class="accordion-body">
                            <!-- ÏïÑÏΩîÎîîÏñ∏ ÎÇ¥Ïö© ÏòÅÏó≠ -->
                        </div>
                        </div>
                    </div>
                </div>
                <div class="timeline-item" id="tl-step-4">
                    <span class="timeline-dot"></span>
                    <div id="accordionItem04"> <!-- class="accordion-item"-->
                        <h5 class="accordion-header"><button type="button" id="accordionHeaderSample04" class="btn-accordion" aria-controls="accordionCollapseSample04">ÏµúÏ†Å Î∞∞Ïπò ÏÉùÏÑ±</button></h5>
                        <div style="display: none;" id="accordionCollapseSample04" class="accordion-collapse collapse" aria-labelledby="accordionHeaderSample04">
                        <div class="accordion-body">
                            <!-- ÏïÑÏΩîÎîîÏñ∏ ÎÇ¥Ïö© ÏòÅÏó≠ -->
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <button class="detail-back-btn" onclick="closeDetailPanel()">Ïù¥Ï†Ñ ÌôîÎ©¥</button>
    </div>
    
    <script>
        let currentStep = 0;
        let progressValue = 0;
        let doneWaitCount = 0;
        let currentScenario = null;
        let eventSource = null;
        let detailPanelOpen = false;
        let stepResultsOriginalParent = null;
        let stepResultsNextSibling = null;
        let shownSteps = { 1: false, 2: false, 3: false, 4: false };
        
        // URLÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        function getScenarioFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('scenario') || 'default';
        }
        
        // Îí§Î°úÍ∞ÄÍ∏∞
        function goBack() {
            window.history.back();
        }
        
        // HTTP Ìè¥ÎßÅ Ï†úÍ±∞Îê®: ÏÉÅÌÉú ÏÉàÎ°úÍ≥†Ïπ®ÏùÄ SSEÎ°úÎßå Ï≤òÎ¶¨
        
        // ÌòÑÏû¨ Îã®Í≥ÑÏóê ÎßûÎäî Î¨∏Íµ¨ Î∞òÌôò
        function getCurrentStepMessage(step) {
            const messages = {
                1: "Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...",
                2: "Ïßê Ïù∏Ïãù Î∞è Î∂ÑÎ•ò Ï§ëÏûÖÎãàÎã§...",
                3: "Ï∞®Îüâ Í≥µÍ∞Ñ Í≥ÑÏÇ∞ Ï§ëÏûÖÎãàÎã§...",
                4: "ÏµúÏ†Å Î∞∞Ïπò ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...",
                5: "Í≤∞Í≥º Í≤ÄÏ¶ù Î∞è ÏôÑÎ£å Ï§ëÏûÖÎãàÎã§..."
            };
            return messages[step] || "Î∂ÑÏÑùÏùÑ ÏãúÏûëÌïòÍ≥† ÏûàÏäµÎãàÎã§...";
        }
        
        // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏ - ÏÑúÎ≤Ñ Í∞íÎßå ÏÇ¨Ïö©
        function updateProgress(percentage, serverStep = null) {
            // ÏßÑÌñâÎ•†ÏùÄ ÌõÑÌá¥ÌïòÏßÄ ÏïäÎèÑÎ°ù Î≥¥Ïû•
            if (typeof percentage === 'number') {
                progressValue = Math.max(progressValue || 0, percentage);
                document.getElementById('progressPercentage').textContent = progressValue + '%';
                if (detailPanelOpen) {
                    const dp = document.getElementById('detailProgressPercentage');
                    if (dp) dp.textContent = progressValue + '%';
                }
            }
            
            // ÏÑúÎ≤Ñ Îã®Í≥ÑÍ∞Ä ÏóÜÏúºÎ©¥ Ï¢ÖÎ£å
            if (serverStep === null || serverStep === undefined) {
                console.log('‚ö†Ô∏è ÏÑúÎ≤ÑÏóêÏÑú Îã®Í≥Ñ Ï†ïÎ≥¥Î•º Î∞õÏßÄ Î™ªÌï®, ÌòÑÏû¨ Îã®Í≥Ñ Ïú†ÏßÄ');
                return;
            }
            console.log('‚úÖ ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Îã®Í≥Ñ:', serverStep);
            
            // Îã®Í≥ÑÎäî ÌõÑÌá¥ÌïòÏßÄ ÏïäÎèÑÎ°ù Î≥¥Ïû• (Îã®, 1Îã®Í≥ÑÎ°úÏùò Ï¥àÍ∏∞ÌôîÎäî ÌóàÏö©)
            if (serverStep < currentStep && serverStep !== 1) {
                console.log('‚è≠Ô∏è Îã®Í≥Ñ ÌõÑÌá¥ Í∞êÏßÄ, Î¨¥ÏãúÌï©ÎãàÎã§. (ÌòÑÏû¨:', currentStep, 'ÏàòÏã†:', serverStep, ')');
                return;
            }
            
            if (serverStep !== currentStep) {
                currentStep = serverStep;
                updateStepDisplay();
                document.getElementById('progressText').textContent = getCurrentStepMessage(currentStep);
                console.log('Îã®Í≥Ñ Î≥ÄÍ≤Ω:', currentStep + 'Îã®Í≥ÑÎ°ú ÏóÖÎç∞Ïù¥Ìä∏');
                if (detailPanelOpen) refreshDetailTimeline();
                if (detailPanelOpen) {
                    const dt = document.getElementById('detailProgressText');
                    if (dt) dt.textContent = getCurrentStepMessage(currentStep);
                }
            }
        }
        
        // Îã®Í≥Ñ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateStepDisplay() {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                const icon = step.querySelector('.step-icon');
                const title = step.querySelector('.step-title');
                const description = step.querySelector('.step-description');
                
                if (i < currentStep) {
                    // ÏôÑÎ£åÎêú Îã®Í≥Ñ
                    icon.className = 'step-icon completed';
                    icon.textContent = '‚úì';
                    title.style.color = '#28a745';
                    description.textContent = 'ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§';
                } else if (i === currentStep) {
                    // ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ Îã®Í≥Ñ
                    if (currentStep === 5) {
                        // 5Îã®Í≥ÑÎäî ÏôÑÎ£å ÏÉÅÌÉúÎ°ú ÌëúÏãú
                        icon.className = 'step-icon completed';
                        icon.textContent = '‚úì';
                        title.style.color = '#28a745';
                        description.textContent = 'Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!';
                    } else {
                        icon.className = 'step-icon active';
                        icon.textContent = i;
                        title.style.color = '#007bff';
                        description.textContent = 'ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§...';
                    }
                } else {
                    // ÎåÄÍ∏∞ Ï§ëÏù∏ Îã®Í≥Ñ
                    icon.className = 'step-icon pending';
                    icon.textContent = i;
                    title.style.color = '#999';
                    description.textContent = 'ÎåÄÍ∏∞ Ï§ëÏûÖÎãàÎã§';
                }
            }
        }
        
        // SSE ÏÉÅÌÉú ÏàòÏã† Ìï∏Îì§Îü¨
        function handleStatusData(statusData) {
            try {
                if (statusData) {
                    console.log('SSE ÏÉÅÌÉú Îç∞Ïù¥ÌÑ∞:', statusData);
                    
                    // Ï†ÑÏ≤¥ statusData Î°úÍ∑∏ Ï∂úÎ†•
                    console.log('üìä Ï†ÑÏ≤¥ statusData:', statusData);
                    console.log('üîç statusData.current_step:', statusData.current_step);
                    console.log('üîç statusData.processing:', statusData.processing);
                    console.log('üîç statusData.progress:', statusData.progress);
                    console.log('üîç statusData.status:', statusData.status);
                    
                    // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Îã®Í≥Ñ Ï†ïÎ≥¥ ÌôïÏù∏
                    const serverStep = statusData.current_step || statusData.processing?.current_step;
                    console.log('‚úÖ ÏÑúÎ≤Ñ Îã®Í≥Ñ Ï†ïÎ≥¥:', serverStep);
                    
                    // current_stepÏù¥ undefinedÏù∏ÏßÄ ÌôïÏù∏
                    if (statusData.current_step === undefined) {
                        console.warn('‚ö†Ô∏è current_stepÏù¥ undefinedÏûÖÎãàÎã§!');
                    } else {
                        console.log('‚úÖ current_step Í∞í:', statusData.current_step, 'ÌÉÄÏûÖ:', typeof statusData.current_step);
                    }
                    
                    // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏ (ÏÑúÎ≤Ñ Í∞íÎßå ÏÇ¨Ïö©)
                    const progress = statusData.progress || statusData.processing?.progress;
                    if (progress !== undefined && serverStep !== null && serverStep !== undefined) {
                        console.log('üìä ÏÑúÎ≤Ñ ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏:', progress + '%', 'Îã®Í≥Ñ:', serverStep);
                        updateProgress(progress, serverStep);
                    } else {
                        console.log('‚ö†Ô∏è ÏÑúÎ≤ÑÏóêÏÑú ÏßÑÌñâÎ•† ÎòêÎäî Îã®Í≥Ñ Ï†ïÎ≥¥Í∞Ä Î∂àÏôÑÏ†ÑÌï®:', {
                            progress: progress,
                            serverStep: serverStep
                        });
                    }
                    
                    // ÏÑúÎ≤Ñ Î©îÏãúÏßÄÍ∞Ä ÏûàÏúºÎ©¥ ÌëúÏãú (ÏßÑÌñâÎ•†Í≥º ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú)
                    const serverMessage = statusData.message;
                    if (serverMessage) {
                        document.getElementById('progressText').textContent = serverMessage;
                        console.log('üìù ÏÑúÎ≤Ñ Î©îÏãúÏßÄ ÏóÖÎç∞Ïù¥Ìä∏:', serverMessage);
                    }
                    
                    // ÌòÑÏû¨ Îã®Í≥Ñ ÌôïÏù∏
                    const currentStep = statusData.current_step || 0;
                    console.log(`ÌòÑÏû¨ Îã®Í≥Ñ: ${currentStep}`);
                    console.log(`ÌòÑÏû¨ Îã®Í≥Ñ ÌÉÄÏûÖ: ${typeof currentStep}`);
                    console.log(`currentStep >= 1: ${currentStep >= 1}`);
                    console.log(`currentStep >= 2: ${currentStep >= 2}`);
                    console.log(`currentStep >= 3: ${currentStep >= 3}`);
                    console.log(`currentStep >= 4: ${currentStep >= 4}`);
                    
                    // ÏÉàÎ°úÏö¥ Î∂ÑÏÑù ÏãúÏûë Í∞êÏßÄ (current_stepÏù¥ 1Ïù¥Í≥† Ïù¥Ï†ÑÏóê Îçî ÎÜíÏùÄ Îã®Í≥ÑÏòÄÎçò Í≤ΩÏö∞)
                    if (currentStep === 1) {
                        console.log('üîÑ ÏÉàÎ°úÏö¥ Î∂ÑÏÑù ÏãúÏûë Í∞êÏßÄ - Ïù¥Ï†Ñ Í≤∞Í≥º ÌÅ¥Î¶¨Ïñ¥');
                        clearAllStepResults();
                    }
                    
                    // Ïù¥Î≤à Ïù¥Î≤§Ìä∏ payloadÏóê Ìè¨Ìï®Îêú Îã®Í≥ÑÎ≥Ñ Í≤∞Í≥ºÎ•º ÏïÑÏΩîÎîîÏñ∏Ïóê Î∞òÏòÅ
                    try {
                        const ar = statusData.analysis_result || {};
                        const pr = statusData.processed_results || {};

                        // Í∞ÄÍ≥µÎêú Í≤∞Í≥º Ïö∞ÏÑ† ÌëúÏãú
                        if (pr.chain1_out && !shownSteps[1]) {
                            displayProcessedStepResult(1, pr.chain1_out);
                            shownSteps[1] = true;
                        }
                        if (pr.chain2_out && !shownSteps[2]) {
                            displayProcessedStepResult(2, pr.chain2_out);
                            shownSteps[2] = true;
                        }
                        if (pr.chain3_out && !shownSteps[3]) {
                            displayProcessedStepResult(3, pr.chain3_out);
                            shownSteps[3] = true;
                        }
                        if (pr.chain4_out && !shownSteps[4]) {
                            displayProcessedStepResult(4, pr.chain4_out);
                            shownSteps[4] = true;
                        }

                        // ÏõêÎ≥∏ Í≤∞Í≥º ÌëúÏãú (Í∞ÄÍ≥µÎêú Í≤∞Í≥ºÍ∞Ä ÏóÜÏùÑ Îïå)
                        if (ar.chain1_out && !shownSteps[1]) {
                            displayStepResult(1, ar.chain1_out);
                            shownSteps[1] = true;
                        }
                        if (ar.chain2_out && !shownSteps[2]) {
                            displayStepResult(2, ar.chain2_out);
                            shownSteps[2] = true;
                        }
                        if (ar.chain3_out && !shownSteps[3]) {
                            displayStepResult(3, ar.chain3_out);
                            shownSteps[3] = true;
                        }
                        if (ar.chain4_out && !shownSteps[4]) {
                            displayStepResult(4, ar.chain4_out);
                            shownSteps[4] = true;
                        }

                        // Î£®Ìä∏Ïóê Ïã§Î¶∞ Í≤ΩÏö∞ÎèÑ ÎåÄÏùë
                        if (statusData.chain1_out && !shownSteps[1]) {
                            displayStepResult(1, statusData.chain1_out);
                            shownSteps[1] = true;
                        }
                        if (statusData.chain2_out && !shownSteps[2]) {
                            displayStepResult(2, statusData.chain2_out);
                            shownSteps[2] = true;
                        }
                        if (statusData.chain3_out && !shownSteps[3]) {
                            displayStepResult(3, statusData.chain3_out);
                            shownSteps[3] = true;
                        }
                        if (statusData.chain4_out && !shownSteps[4]) {
                            displayStepResult(4, statusData.chain4_out);
                            shownSteps[4] = true;
                        }
                    } catch (e) {
                        console.warn('Îã®Í≥ÑÎ≥Ñ Í≤∞Í≥º Î∞òÏòÅ Ï§ë Ïò§Î•ò:', e);
                    }

                    // 5Îã®Í≥Ñ ÏôÑÎ£å Ïãú - Ïã§Ï†ú 4Îã®Í≥Ñ Í≤∞Í≥ºÍ∞Ä ÎèÑÏ∞©Ìïú Í≤ΩÏö∞ÏóêÎßå ÏôÑÎ£å Ï≤òÎ¶¨
                    const hasStep4Output = !!(shownSteps[4] || statusData.analysis_result?.chain4_out);
                    if (currentStep >= 5 && hasStep4Output) {
                        console.log('‚úÖ 5Îã®Í≥Ñ ÏôÑÎ£å - Î∂ÑÏÑù ÏôÑÎ£å Ï≤òÎ¶¨ (Ï∂úÎ†• ÌôïÏù∏Îê®)');
                        updateProgress(100, 5);
                        document.getElementById('progressText').textContent = 'Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!';
                        showResultButton();
                    } else if (currentStep >= 5 && !hasStep4Output) {
                        doneWaitCount = (doneWaitCount || 0) + 1;
                        console.log(`‚è≥ 5Îã®Í≥Ñ Ïã†Ìò∏ ÏàòÏã†, Í∑∏Îü¨ÎÇò step4 Ï∂úÎ†• ÎØ∏ÎèÑÏ∞© ‚Üí ÏôÑÎ£å Ï≤òÎ¶¨ Î≥¥Î•ò (ÏãúÎèÑ ${doneWaitCount})`);
                        // ÏïàÏ†ÑÏû•Ïπò: ÏùºÏ†ï ÌöüÏàò(Ïòà: 5Ìöå) Ïù¥ÏÉÅ ÎåÄÍ∏∞ Ïãú ÏôÑÎ£åÎ°ú Í∞ÑÏ£º
                        if (doneWaitCount >= 5) {
                            console.log('‚ö†Ô∏è ÏµúÏ¢Ö Ï∂úÎ†• ÎØ∏ÎèÑÏ∞© ÌÉÄÏûÑÏïÑÏõÉ ‚Üí ÏôÑÎ£åÎ°ú Í∞ÑÏ£ºÌïòÍ≥† Ï¢ÖÎ£å');
                            document.getElementById('progressText').textContent = 'Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!';
                            updateProgress(100, 5);
                            showResultButton();
                        }
                    }
                    
                    // ÏÉÅÌÉúÏóê Îî∞Î•∏ Ï≤òÎ¶¨
                    const status = statusData.status || statusData.system?.status;
                    if (status === 'done') {
                        const hasFinal = !!(statusData.chain4_out || statusData.analysis_result?.chain4_out || statusData.processed_results?.chain4_out);
                        if (hasFinal) {
                            console.log('Î∂ÑÏÑù ÏôÑÎ£å! (ÏµúÏ¢Ö Ï∂úÎ†• ÌôïÏù∏)');
                            document.getElementById('progressText').textContent = 'Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!';
                            showResultButton();
                        } else {
                            doneWaitCount = (doneWaitCount || 0) + 1;
                            console.log(`Î∂ÑÏÑù ÏôÑÎ£å Ïã†Ìò∏ ÏàòÏã†, Í∑∏Îü¨ÎÇò ÏµúÏ¢Ö Ï∂úÎ†• ÎØ∏ÎèÑÏ∞© ‚Üí Ìè¥ÎßÅ Ïú†ÏßÄ (ÏãúÎèÑ ${doneWaitCount})`);
                        }
                    } else if (status === 'error') {
                        console.log('Î∂ÑÏÑù Ïò§Î•ò Î∞úÏÉù');
                        document.getElementById('progressText').textContent = 'Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                    }
                }
            } catch (error) {
                console.error('ÏÉÅÌÉú Ï≤òÎ¶¨ Ïò§Î•ò:', error);
            }
        }
        
        // Í≤∞Í≥º ÌôïÏù∏ Î≤ÑÌäº ÌëúÏãú
        function showResultButton() {
            const button = document.getElementById('resultCheckButton');
            button.classList.add('show');
        }
        
        // ÏÉÅÏÑ∏ Ìå®ÎÑê Ïó¥Í∏∞
        function openDetailPanel() {
            const panel = document.getElementById('detailPanel');
            // const source = document.getElementById('stepResults');
            // const target = document.getElementById('detailStepResults');
            // const tl = document.getElementById('detailTimeline');
            // if (panel && source && target) {
            if (panel) {
                // ÏµúÏ¥à Ïò§Ìîà Ïãú ÏõêÎûò ÏúÑÏπò Í∏∞Ïñµ
                // if (!stepResultsOriginalParent) {
                //     stepResultsOriginalParent = source.parentNode;
                //     stepResultsNextSibling = source.nextSibling;
                // }
                // ÎèôÏùº ÎÖ∏ÎìúÎ•º ÏÉÅÏÑ∏ Ìå®ÎÑê ÎÇ¥Î∂ÄÎ°ú Ïù¥Îèô ‚Üí SSE Í∞±Ïã†Ïù¥ Í∑∏ÎåÄÎ°ú Î∞òÏòÅÎê®
                // target.innerHTML = '';
                // target.appendChild(source);
                // source.style.display = 'block';
                panel.classList.add('show');
                panel.setAttribute('aria-hidden', 'false');
                detailPanelOpen = true;
                // Ï¥àÍ∏∞ ÌÉÄÏûÑÎùºÏù∏ ÏÉÅÌÉú Í∞±Ïã†
                refreshDetailTimeline();
                // ÏÉÅÏÑ∏ ÏßÑÌñâ Ïπ¥Îìú ÎèôÍ∏∞Ìôî
                syncDetailProgressCard();
            }
        }

        // ÏÉÅÏÑ∏ Ìå®ÎÑê Îã´Í∏∞
        function closeDetailPanel() {
            const panel = document.getElementById('detailPanel');
            const source = document.getElementById('stepResults');
            if (panel) {
                panel.classList.remove('show');
                panel.setAttribute('aria-hidden', 'true');
            }
            // ÏõêÎûò ÏúÑÏπòÎ°ú ÎêòÎèåÎ¶¨Í∏∞
            if (source && stepResultsOriginalParent) {
                try {
                    if (stepResultsNextSibling && stepResultsNextSibling.parentNode === stepResultsOriginalParent) {
                        stepResultsOriginalParent.insertBefore(source, stepResultsNextSibling);
                    } else {
                        stepResultsOriginalParent.appendChild(source);
                    }
                    source.style.display = 'none';
                } catch (_) {}
            }
            detailPanelOpen = false;
        }

        // ÏÉÅÏÑ∏ Ìå®ÎÑêÏùò ÌÉÄÏûÑÎùºÏù∏ ÏÉÅÌÉúÎ•º ÌòÑÏû¨ Îã®Í≥ÑÏóê ÎßûÏ∂∞ Í∞±Ïã†
        function refreshDetailTimeline() {
            const tlSteps = [1,2,3,4];
            tlSteps.forEach((n) => {
                const el = document.getElementById(`tl-step-${n}`);
                if (!el) return;
                el.classList.remove('active','completed');
                if (currentStep > n) {
                    el.classList.add('completed');
                } else if (currentStep === n) {
                    el.classList.add('active');
                }
            });
        }

        // ÏÉÅÏÑ∏ ÏßÑÌñâ Ïπ¥Îìú(ÌçºÏÑºÌä∏/ÌÖçÏä§Ìä∏) ÎèôÍ∏∞Ìôî
        function syncDetailProgressCard() {
            const dp = document.getElementById('detailProgressPercentage');
            const dt = document.getElementById('detailProgressText');
            const p = document.getElementById('progressPercentage');
            const t = document.getElementById('progressText');
            if (dp && dt && p && t) {
                dp.textContent = p.textContent;
                dt.textContent = t.textContent;
            }
        }
        
        // Îã®Í≥ÑÎ≥Ñ Î∂ÑÏÑù Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
        function updateStepResults(resultData) {
            console.log('updateStepResults Ìò∏Ï∂úÎê®:', resultData);
            
            // 1Îã®Í≥Ñ: Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Í≤∞Í≥º
            if (resultData.chain1_out) {
                console.log('1Îã®Í≥Ñ Í≤∞Í≥º Î∞úÍ≤¨:', resultData.chain1_out);
                displayStepResult(1, resultData.chain1_out);
            }
            
            // 2Îã®Í≥Ñ: Ïßê Ïù∏Ïãù Î∞è Î∂ÑÎ•ò Í≤∞Í≥º
            if (resultData.chain2_out) {
                console.log('2Îã®Í≥Ñ Í≤∞Í≥º Î∞úÍ≤¨:', resultData.chain2_out);
                displayStepResult(2, resultData.chain2_out);
            }
            
            // 3Îã®Í≥Ñ: Ï∞®Îüâ Í≥µÍ∞Ñ Í≥ÑÏÇ∞ Í≤∞Í≥º
            if (resultData.chain3_out) {
                console.log('3Îã®Í≥Ñ Í≤∞Í≥º Î∞úÍ≤¨:', resultData.chain3_out);
                displayStepResult(3, resultData.chain3_out);
            }
            
            // 4Îã®Í≥Ñ: ÏµúÏ†Å Î∞∞Ïπò ÏÉùÏÑ± Í≤∞Í≥º
            if (resultData.chain4_out) {
                console.log('4Îã®Í≥Ñ Í≤∞Í≥º Î∞úÍ≤¨:', resultData.chain4_out);
                displayStepResult(4, resultData.chain4_out);
            }
        }
        
        // Í∞ÄÍ≥µÎêú Îã®Í≥ÑÎ≥Ñ Î∂ÑÏÑù Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
        function updateProcessedStepResults(processedResults) {
            console.log('updateProcessedStepResults Ìò∏Ï∂úÎê®:', processedResults);
            
            // 1Îã®Í≥Ñ: Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Í≤∞Í≥º
            if (processedResults.chain1_out) {
                console.log('Í∞ÄÍ≥µÎêú 1Îã®Í≥Ñ Í≤∞Í≥º Î∞úÍ≤¨:', processedResults.chain1_out);
                displayProcessedStepResult(1, processedResults.chain1_out);
            }
            
            // 2Îã®Í≥Ñ: Ïßê Ïù∏Ïãù Î∞è Î∂ÑÎ•ò Í≤∞Í≥º
            if (processedResults.chain2_out) {
                console.log('Í∞ÄÍ≥µÎêú 2Îã®Í≥Ñ Í≤∞Í≥º Î∞úÍ≤¨:', processedResults.chain2_out);
                displayProcessedStepResult(2, processedResults.chain2_out);
            }
            
            // 3Îã®Í≥Ñ: Ï∞®Îüâ Í≥µÍ∞Ñ Í≥ÑÏÇ∞ Í≤∞Í≥º
            if (processedResults.chain3_out) {
                console.log('Í∞ÄÍ≥µÎêú 3Îã®Í≥Ñ Í≤∞Í≥º Î∞úÍ≤¨:', processedResults.chain3_out);
                displayProcessedStepResult(3, processedResults.chain3_out);
            }
            
            // 4Îã®Í≥Ñ: ÏµúÏ†Å Î∞∞Ïπò ÏÉùÏÑ± Í≤∞Í≥º
            if (processedResults.chain4_out) {
                console.log('Í∞ÄÍ≥µÎêú 4Îã®Í≥Ñ Í≤∞Í≥º Î∞úÍ≤¨:', processedResults.chain4_out);
                displayProcessedStepResult(4, processedResults.chain4_out);
            }
        }
        
        // Î™®Îì† Îã®Í≥Ñ Í≤∞Í≥º ÌÅ¥Î¶¨Ïñ¥
        function clearAllStepResults() {
            console.log('üßπ Î™®Îì† Îã®Í≥Ñ Í≤∞Í≥º ÌÅ¥Î¶¨Ïñ¥ ÏãúÏûë');
            
            for (let i = 1; i <= 4; i++) {
                const resultElement = document.getElementById(`step${i}Result`);
                const contentElement = document.getElementById(`step${i}ResultContent`);
                
                if (resultElement && contentElement) {
                    contentElement.innerHTML = '';
                    resultElement.style.display = 'none';
                    console.log(`üßπ ${i}Îã®Í≥Ñ Í≤∞Í≥º ÌÅ¥Î¶¨Ïñ¥ ÏôÑÎ£å`);
                }
            }
            
            console.log('üßπ Î™®Îì† Îã®Í≥Ñ Í≤∞Í≥º ÌÅ¥Î¶¨Ïñ¥ ÏôÑÎ£å');
        }
        
        // ÏïàÏ†Ñ Ïú†Ìã∏Î¶¨Ìã∞ (ÏÇ≠Ï†úÎêòÏóàÏùÑ Ïàò ÏûàÏñ¥ Ïû¨Ï†ïÏùò)
        function safeSliceText(value, max = 100) {
            try {
                if (typeof value !== 'string') {
                    value = JSON.stringify(value);
                }
            } catch (_) {
                value = String(value);
            }
            if (!value) return '';
            return value.length > max ? value.slice(0, max) + '...' : value;
        }
        
        function safeJsonParse(data) {
            if (data && typeof data === 'object') {
                return data;
            }
            if (typeof data !== 'string') {
                return null;
            }
            let s = data.trim();
            // ÏΩîÎìúÌéúÏä§ Ï†úÍ±∞
            if (s.startsWith('```')) {
                s = s.replace(/^```json\s*/i, '')
                     .replace(/^```/i, '')
                     .replace(/```$/i, '')
                     .trim();
            }
            s = s.replace(/```json\s*|```/gi, '').trim();
            // JSON ÌòïÏãùÏù¥ ÏïÑÎãàÎ©¥ Ïä§ÌÇµ
            if (!(s.startsWith('{') || s.startsWith('['))) {
                return null;
            }
            try {
                return JSON.parse(s);
            } catch (_) {
                return null;
            }
        }
        
        // ÌäπÏ†ï Îã®Í≥ÑÏùò Í≤∞Í≥ºÎ•º ÌôîÎ©¥Ïóê ÌëúÏãú
        function displayStepResult(stepNumber, resultData) {
            console.log(`üéØ displayStepResult Ìò∏Ï∂úÎê®: Îã®Í≥Ñ ${stepNumber}, Îç∞Ïù¥ÌÑ∞:`, resultData);
            
            
            const accordionItem = document.getElementById(`accordionItem0${stepNumber}`);
            const accordionCollapse = document.getElementById(`accordionCollapseSample0${stepNumber}`);
            
            if (!accordionItem || !accordionCollapse) {
                console.error(`Îã®Í≥Ñ ${stepNumber} Í≤∞Í≥º ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
                return;
            }
            
            // Ïù¥Ï†Ñ Îç∞Ïù¥ÌÑ∞ ÌÅ¥Î¶¨Ïñ¥
            accordionItem.classList.remove('active');
            accordionCollapse.style.display = 'none';
            
            // Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞ Ìè¨Îß∑ÌåÖ
            const formattedResult = formatStepResult(stepNumber, resultData);
            console.log(`üéØ Ìè¨Îß∑Îêú Í≤∞Í≥º:`, formattedResult);
            
            // ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
            accordionCollapse.innerHTML = formattedResult;
            
            // Í≤∞Í≥º ÏòÅÏó≠ ÌëúÏãú
            accordionItem.classList.add('accordion-item');
            accordionCollapse.style.display = 'inline-block';

            accordionItem.addEventListener('click', () => {
                accordionItem.classList.toggle('active');
            });
            
            console.log(`Îã®Í≥Ñ ${stepNumber} Í≤∞Í≥º ÌëúÏãú ÏôÑÎ£å`);
        }
        
        // Í∞ÄÍ≥µÎêú ÌäπÏ†ï Îã®Í≥ÑÏùò Í≤∞Í≥ºÎ•º ÌôîÎ©¥Ïóê ÌëúÏãú
        function displayProcessedStepResult(stepNumber, processedData) {
            const resultElement = document.getElementById(`step${stepNumber}Result`);
            const contentElement = document.getElementById(`step${stepNumber}ResultContent`);
            
            if (!resultElement || !contentElement) {
                console.error(`Îã®Í≥Ñ ${stepNumber} Í≤∞Í≥º ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
                return;
            }
            
            // Ïù¥Ï†Ñ Îç∞Ïù¥ÌÑ∞ ÌÅ¥Î¶¨Ïñ¥
            contentElement.innerHTML = '';
            resultElement.style.display = 'none';
            
            // Í∞ÄÍ≥µÎêú Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞ Ìè¨Îß∑ÌåÖ
            const formattedResult = formatProcessedStepResult(stepNumber, processedData);
            
            // ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
            contentElement.innerHTML = formattedResult;
            
            // Í≤∞Í≥º ÏòÅÏó≠ ÌëúÏãú
            resultElement.style.display = 'block';
            
            // Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú ÌëúÏãú
            setTimeout(() => {
                resultElement.classList.add('show', 'completed');
                initResultToggle(stepNumber);
            }, 100);
            
            // Îã®Í≥ÑÎ≥Ñ ÏôÑÎ£å ÌÖçÏä§Ìä∏ ÌëúÏãú
            showStepCompletionText(stepNumber, processedData);
            
            console.log(`Í∞ÄÍ≥µÎêú Îã®Í≥Ñ ${stepNumber} Í≤∞Í≥º ÌëúÏãú ÏôÑÎ£å`);
        }
        
        // Îã®Í≥ÑÎ≥Ñ ÏôÑÎ£å ÌÖçÏä§Ìä∏ ÌëúÏãú
        function showStepCompletionText(stepNumber, processedData) {
            const stepResultsContainer = document.getElementById('stepResults');
            if (!stepResultsContainer) return;
            
            // Í∏∞Ï°¥ ÏôÑÎ£å ÌÖçÏä§Ìä∏ Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
            const existingText = document.getElementById(`step${stepNumber}CompletionText`);
            if (existingText) {
                existingText.remove();
            }
            
            // ÏôÑÎ£å ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
            const completionText = createStepCompletionText(stepNumber, processedData);
            
            // ÏôÑÎ£å ÌÖçÏä§Ìä∏Î•º Ìï¥Îãπ Îã®Í≥Ñ Í≤∞Í≥º ÏïÑÎûòÏóê ÏÇΩÏûÖ
            const resultElement = document.getElementById(`step${stepNumber}Result`);
            if (resultElement) {
                resultElement.insertAdjacentHTML('afterend', completionText);
            } else {
                // Í≤∞Í≥º ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Ïª®ÌÖåÏù¥ÎÑàÏóê ÏßÅÏ†ë Ï∂îÍ∞Ä
                stepResultsContainer.insertAdjacentHTML('beforeend', completionText);
            }
            
            console.log(`Îã®Í≥Ñ ${stepNumber} ÏôÑÎ£å ÌÖçÏä§Ìä∏ ÌëúÏãú ÏôÑÎ£å`);
        }
        
        // Í≤∞Í≥º Î∏îÎ°ù Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ ÌÜ†Í∏Ä Ï¥àÍ∏∞Ìôî
        function initResultToggle(stepNumber) {
            const item = document.getElementById(`step${stepNumber}Result`);
            if (!item) return;
            const title = item.querySelector('.step-result-title');
            const content = item.querySelector('.step-result-content');
            if (!title || !content) return;

            // Ï¥àÍ∏∞ ÎÜíÏù¥ ÏÑ§Ï†ï
            if (!item.classList.contains('expanded')) {
                content.style.maxHeight = '0px';
            }

            // Ï§ëÎ≥µ Î∞îÏù∏Îî© Î∞©ÏßÄ
            title.removeEventListener('click', title._toggleHandler);
            title._toggleHandler = () => {
                const isExpanded = item.classList.contains('expanded');
                if (isExpanded) {
                    item.classList.remove('expanded');
                    content.style.maxHeight = '0px';
                } else {
                    item.classList.add('expanded');
                    content.style.maxHeight = content.scrollHeight + 'px';
                }
            };
            title.addEventListener('click', title._toggleHandler);
        }

        // Îã®Í≥ÑÎ≥Ñ ÏôÑÎ£å ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
        function createStepCompletionText(stepNumber, processedData) {
            let title = '';
            let content = '';
            
            switch(stepNumber) {
                case 1: // Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù
                    title = '1Îã®Í≥Ñ: Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù ÏôÑÎ£å';
                    content = `
                        <p><span class="highlight">${processedData.people_count || 0}Î™Ö</span></p>
                        <p><strong>üß≥ Ï¥ù Ïßê Í∞úÏàò:</strong> <span class="highlight">${processedData.total_luggage || 0}Í∞ú</span></p>
                        <p>Ïù¥ÎØ∏ÏßÄÏóêÏÑú <span class="highlight">${processedData.people_count || 0}Î™ÖÏùò Ïù∏Ïõê</span>Í≥º <span class="highlight">${processedData.total_luggage || 0}Í∞úÏùò Ïßê</span>ÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ïù∏ÏãùÌñàÏäµÎãàÎã§.</p>
                    `;
                    break;
                    
                case 2: // Ïßê Ïù∏Ïãù Î∞è Î∂ÑÎ•ò
                    title = '2Îã®Í≥Ñ: Ïßê Ïù∏Ïãù Î∞è Î∂ÑÎ•ò ÏôÑÎ£å';
                    content = `
                        <p><strong>ü™ë Ï¢åÏÑù Î∞∞Ïπò ÏßÄÏãúÏÇ¨Ìï≠ ÏÉùÏÑ± ÏôÑÎ£å</strong></p>
                        <p>Í∞Å ÏßêÏùò ÌäπÏÑ±Ïóê ÎßûÎäî <span class="highlight">Ï¢åÏÑù Î∞∞Ïπò ÏßÄÏãúÏÇ¨Ìï≠</span>ÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÌñàÏäµÎãàÎã§.</p>
                    `;
                    break;
                    
                case 3: // Ï∞®Îüâ Í≥µÍ∞Ñ Í≥ÑÏÇ∞
                    title = '3Îã®Í≥Ñ: Ï∞®Îüâ Í≥µÍ∞Ñ Í≥ÑÏÇ∞ ÏôÑÎ£å';
                    content = `
                        <p><strong>üöó Ï∞®Îüâ ÌôòÍ≤Ω Î∂ÑÏÑù ÏôÑÎ£å</strong></p>
                        <p>Ï∞®ÎüâÏùò <span class="highlight">Í≥µÍ∞Ñ Íµ¨Ï°∞</span>ÏôÄ <span class="highlight">ÏûëÏóÖ ÏàúÏÑú</span>Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í≥ÑÏÇ∞ÌñàÏäµÎãàÎã§.</p>
                    `;
                    break;
                    
                case 4: // ÏµúÏ†Å Î∞∞Ïπò ÏÉùÏÑ±
                    title = '4Îã®Í≥Ñ: ÏµúÏ†Å Î∞∞Ïπò ÏÉùÏÑ± ÏôÑÎ£å';
                    content = `
                        <p><strong>üéØ ÏµúÏ†Å Î∞∞Ïπò ÏΩîÎìú ÏÉùÏÑ± ÏôÑÎ£å</strong></p>
                        <p><span class="highlight">${processedData.code_length || 0}ÏûêÎ¶¨ Î∞∞Ïπò ÏΩîÎìú</span>Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÌñàÏäµÎãàÎã§.</p>
                        <p>ÏΩîÎìú: <span class="highlight">${processedData.placement_code || ''}</span></p>
                    `;
                    break;
                    
                default:
                    title = `${stepNumber}Îã®Í≥Ñ: Î∂ÑÏÑù ÏôÑÎ£å`;
                    content = `<p>Î∂ÑÏÑùÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.</p>`;
            }
            
            return `
                <div class="step-completion-text" id="step${stepNumber}CompletionText">
                    <h4>${title}</h4>
                    ${content}
                </div>
            `;
        }
        
        // Îã®Í≥ÑÎ≥Ñ Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞ Ìè¨Îß∑ÌåÖ
        function formatStepResult(stepNumber, resultData) {
            console.log(`üîß formatStepResult Ìò∏Ï∂úÎê®: Îã®Í≥Ñ ${stepNumber}, Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ: ${typeof resultData}`);
            try {
                let formattedResult = '';
                
                switch(stepNumber) {
                    case 1: // Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù
                        console.log(`üîß 1Îã®Í≥Ñ Îç∞Ïù¥ÌÑ∞ ÌååÏã± ÏãúÎèÑ:`, resultData);
                        const chain1Data = (function(){
                            const parsed = safeJsonParse(resultData);
                            return parsed && typeof parsed === 'object' ? parsed : {};
                        })();
                        console.log(`üîß 1Îã®Í≥Ñ ÌååÏã± ÏôÑÎ£å:`, chain1Data);
                        formattedResult = `
                            <strong>üë• Ïù∏Ïõê Ïàò:</strong> ${chain1Data.people || 0}Î™Ö
                            <br><strong>üß≥ Ï¥ù Ïßê Í∞úÏàò:</strong> ${chain1Data.total_luggage_count || 0}Í∞ú
                            <br><strong>üìã Ïßê ÏÉÅÏÑ∏ Ï†ïÎ≥¥</strong>
                        `;
                        let luggageTableRows = '';
                        
                        for (let luggage in chain1Data.luggage_details) {
                            luggageTableRows += `
                                <tr>
                                    <td>${chain1Data.luggage_details[luggage].object}</td>
                                    <td>${chain1Data.luggage_details[luggage].color}</td>
                                    <td>${chain1Data.luggage_details[luggage].material}</td>
                                    <td>${chain1Data.luggage_details[luggage].shape}</td>
                                </tr>
                            `;
                        }

                        formattedResult += `
                            <br><table border="1">
                                <thead>
                                    <tr>
                                        <th>Î¨ºÍ±¥</th>
                                        <th>ÏÉâÏÉÅ</th>
                                        <th>Ïû¨Î£å</th>
                                        <th>Î™®Ïñë</th>
                                    </tr>
                                </thead>
                                <tbody>${luggageTableRows}</tbody>
                            </table>
                        `;
                        break;
                        
                    case 2: // Ïßê Ïù∏Ïãù Î∞è Î∂ÑÎ•ò
                        const chain2Data = (function(){
                            const parsed = safeJsonParse(resultData);
                            return parsed && typeof parsed === 'object' ? parsed : {};
                        })();
                        formattedResult = `
                            <strong>ü™ë Ï¢åÏÑù Î∞∞Ïπò ÏßÄÏãúÏÇ¨Ìï≠</strong>
                        `;
                        let seatsTableRows = '';
                        for (let seat in chain2Data.instruction.seats) {
                            let seatDataArray = chain2Data.instruction.seats[seat];
                            let tableSeatData = '';
                            seatDataArray.forEach(data => {
                                tableSeatData += `<td>${data}</td>`;
                            });
                            seatsTableRows += `<tr>${tableSeatData}</tr>`;
                        }
                        formattedResult += `
                            <br><table border="1">
                                <thead>
                                    <tr>
                                        <th>ÏúÑÏπò</th>
                                        <th>Î∞©Î≤ï</th>
                                        <th>Ïö©Îüâ</th>
                                        <th>chair|storage</th>
                                    </tr>
                                </thead>
                                <tbody>${seatsTableRows}</tbody>
                            </table>
                        `;
                        break;
                        
                    case 3: // Ï∞®Îüâ Í≥µÍ∞Ñ Í≥ÑÏÇ∞
                        const cleanData = (typeof resultData === 'string') ? resultData.replace(/```json\s*|```/g, '') : resultData;
                        const chain3Data = (function(){
                            const parsed = safeJsonParse(cleanData);
                            return parsed && typeof parsed === 'object' ? parsed : {};
                        })();

                        let environmentBeforeTableRows = '';
                        for (let seat in chain3Data.environment_before.seats) {
                            environmentBeforeTableRows += `<tr>
                                <td>${chain3Data.environment_before.seats[seat].rail_axis}</td>
                                <td>${chain3Data.environment_before.seats[seat].position}</td>
                                <td>${chain3Data.environment_before.seats[seat].facing}</td>
                                <td>${chain3Data.environment_before.seats[seat].mode}</td>
                            </tr>`;
                        }

                        let taskSequenceTableRows = '';
                        for (let seq in chain3Data.task_sequence) {
                            let taskSequenceDataArray = chain3Data.task_sequence[seq];
                            let tabletaskSequenceData = '';
                            taskSequenceDataArray.forEach(data => {
                                tabletaskSequenceData += `<td>${data}</td>`;
                            });
                            taskSequenceTableRows += `<tr>${tabletaskSequenceData}</tr>`;
                        }

                        let environmentAfterTableRows = '';
                        for (let seat in chain3Data.environment_after.seats) {
                            environmentAfterTableRows += `<tr>
                                <td>${chain3Data.environment_after.seats[seat].rail_axis}</td>
                                <td>${chain3Data.environment_after.seats[seat].position}</td>
                                <td>${chain3Data.environment_after.seats[seat].facing}</td>
                                <td>${chain3Data.environment_after.seats[seat].mode}</td>
                            </tr>`;
                        }


                        formattedResult = `
                            <strong>üöó ÌôòÍ≤Ω ÏÑ§Ï†ï (Ïù¥Ï†Ñ):</strong>
                            <br><table border="1">
                                <thead>
                                    <tr>
                                        <th>rail_axis</th>
                                        <th>position</th>
                                        <th>facing</th>
                                        <th>mode</th>
                                    </tr>
                                </thead>
                                <tbody>${environmentBeforeTableRows}</tbody>
                            </table>
                            <br><strong>üìã ÏûëÏóÖ ÏàúÏÑú:</strong>
                            <br><table border="1">
                                <tbody>${taskSequenceTableRows}</tbody>
                            </table>
                            <br><strong>üöó ÌôòÍ≤Ω ÏÑ§Ï†ï (Ïù¥ÌõÑ):</strong>
                            <br><table border="1">
                                <thead>
                                    <tr>
                                        <th>rail_axis</th>
                                        <th>position</th>
                                        <th>facing</th>
                                        <th>mode</th>
                                    </tr>
                                </thead>
                                <tbody>${environmentAfterTableRows}</tbody>
                            </table>
                        `;

                        break;
                        
                    case 4: // ÏµúÏ†Å Î∞∞Ïπò ÏÉùÏÑ±
                        formattedResult = `
                            <strong>üéØ ÏµúÏ†Å Î∞∞Ïπò ÏΩîÎìú:</strong> ${resultData}
                            <br><em>16ÏûêÎ¶¨ ÏΩîÎìúÎäî Í∞Å Ï¢åÏÑùÏùò ÏµúÏ†Å Î∞∞Ïπò ÏÉÅÌÉúÎ•º ÎÇòÌÉÄÎÉÖÎãàÎã§.</em>
                        `;
                        break;
                        
                    default:
                        formattedResult = `<pre>${resultData}</pre>`;
                }
                
                return formattedResult;
                
            } catch (error) {
                console.error(`Îã®Í≥Ñ ${stepNumber} Í≤∞Í≥º Ìè¨Îß∑ÌåÖ Ïò§Î•ò:`, error);
                return `<p>Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò: ${error.message}</p><pre>${resultData}</pre>`;
            }
        }
        
        // Í∞ÄÍ≥µÎêú Îã®Í≥ÑÎ≥Ñ Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞ Ìè¨Îß∑ÌåÖ
        function formatProcessedStepResult(stepNumber, processedData) {
            try {
                let formattedResult = '';
                
                switch(stepNumber) {
                    case 1: // Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù
                        try {
                            // processedDataÍ∞Ä Î¨∏ÏûêÏó¥Ïù∏ Í≤ΩÏö∞ JSON ÌååÏã± ÏãúÎèÑ
                            let chain1Data = processedData;
                            if (typeof processedData === 'string') {
                                chain1Data = safeJsonParse(processedData) || {};
                            }
                            
                            const peopleCount = chain1Data.people || chain1Data.people_count || 0;
                            const totalLuggage = chain1Data.total_luggage_count || chain1Data.total_luggage || 0;
                            const luggageDetails = chain1Data.luggage_details || {};
                            
                            // Ïßê ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Ìëú ÌòïÌÉúÎ°ú Î≥ÄÌôò
                            let luggageTableRows = '';
                            if (typeof luggageDetails === 'object' && luggageDetails !== null) {
                                console.log("luggageDetails" + luggageDetails);
                                Object.entries(luggageDetails).forEach(([key, value]) => {
                                    luggageTableRows += `
                                        <tr>
                                            <td>${key}</td>
                                            <td>${typeof value === 'object' ? JSON.stringify(value) : value}</td>
                                        </tr>
                                    `;
                                });
                            }
                            
                            formattedResult = `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Ìï≠Î™©</th>
                                            <th>Í∞í</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>üë• Ïù∏Ïõê Ïàò</strong></td>
                                            <td>${peopleCount}Î™Ö</td>
                                        </tr>
                                        <tr>
                                            <td><strong>üß≥ Ï¥ù Ïßê Í∞úÏàò</strong></td>
                                            <td>${totalLuggage}Í∞ú</td>
                                        </tr>
                                        ${luggageTableRows ? `
                                        <tr>
                                            <td colspan="2"><strong>üìã Ïßê ÏÉÅÏÑ∏ Ï†ïÎ≥¥</strong></td>
                                        </tr>
                                        ${luggageTableRows}
                                        ` : ''}
                                    </tbody>
                                </table>
                            `;
                        } catch (error) {
                            console.error('1Îã®Í≥Ñ Í≤∞Í≥º Ìè¨Îß∑ÌåÖ Ïò§Î•ò:', error);
                            formattedResult = `Ìè¨Îß∑ÌåÖ Ïò§Î•ò Î∞úÏÉù`;
                        }
                        break;
                        
                    case 2: // Ïßê Ïù∏Ïãù Î∞è Î∂ÑÎ•ò
                        try {
                            // Í∞ÄÍ≥µÎêú Ï¢åÏÑù Î∞∞Ïπò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäî Í≤ΩÏö∞
                            if (processedData.seat_assignments && Array.isArray(processedData.seat_assignments)) {
                                const seatAssignments = processedData.seat_assignments;
                                const seatsCount = processedData.seats_count || seatAssignments.length;
                                
                                // Ï¢åÏÑù Î∞∞Ïπò Ìëú ÏÉùÏÑ±
                                let tableRows = '';
                                seatAssignments.forEach(seat => {
                                    tableRows += `
                                        <tr>
                                            <td>${seat.seat_id}</td>
                                            <td>${seat.type}</td>
                                            <td>${seat.size}</td>
                                            <td>${seat.category}</td>
                                        </tr>
                                    `;
                                });
                                
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Ï¢åÏÑù Î≤àÌò∏</th>
                                                <th>ÌÉÄÏûÖ</th>
                                                <th>ÌÅ¨Í∏∞</th>
                                                <th>Ïπ¥ÌÖåÍ≥†Î¶¨</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tableRows}
                                        </tbody>
                                    </table>
                                `;
                            } else {
                                // Í∞ÄÍ≥µÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÏõêÎ≥∏ ÌëúÏãú
                                let instructionData = processedData && processedData.instruction ? processedData.instruction : {};
                                if (typeof processedData === 'string') {
                                    const parsed = safeJsonParse(processedData) || {};
                                    instructionData = parsed.instruction || parsed;
                                }
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Ìï≠Î™©</th>
                                                <th>Í∞í</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>ü™ë Ï¢åÏÑù Î∞∞Ïπò ÏßÄÏãúÏÇ¨Ìï≠</strong></td>
                                                <td><pre>${JSON.stringify(instructionData, null, 2)}</pre></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                            }
                        } catch (error) {
                            console.error('2Îã®Í≥Ñ Í≤∞Í≥º Ìè¨Îß∑ÌåÖ Ïò§Î•ò:', error);
                            formattedResult = `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Ìï≠Î™©</th>
                                            <th>Í∞í</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>ü™ë Ï¢åÏÑù Î∞∞Ïπò ÏßÄÏãúÏÇ¨Ìï≠</strong></td>
                                            <td><pre>${processedData}</pre></td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        }
                        break;
                        
                    case 3: // Ï∞®Îüâ Í≥µÍ∞Ñ Í≥ÑÏÇ∞
                        try {
                            // Í∞ÄÍ≥µÎêú ÏûëÏóÖ ÏàúÏÑú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäî Í≤ΩÏö∞
                            if (processedData.task_sequence_list && Array.isArray(processedData.task_sequence_list)) {
                                const taskSequenceList = processedData.task_sequence_list;
                                
                                // ÏûëÏóÖ ÏàúÏÑú Ìëú ÏÉùÏÑ±
                                let taskRows = '';
                                taskSequenceList.forEach(task => {
                                    taskRows += `
                                        <tr>
                                            <td>${task.step_id}</td>
                                            <td>${task.action}</td>
                                            <td>${task.target}</td>
                                            <td>${task.description}</td>
                                        </tr>
                                    `;
                                });
                                
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Îã®Í≥Ñ</th>
                                                <th>ÏûëÏóÖ</th>
                                                <th>ÎåÄÏÉÅ</th>
                                                <th>ÏÑ§Î™Ö</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${taskRows}
                                        </tbody>
                                    </table>
                                    <br>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ÌôòÍ≤Ω ÏÑ§Ï†ï</th>
                                                <th>Í∞í</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>üåç ÌôòÍ≤Ω ÏÑ§Ï†ï (Ïù¥Ï†Ñ)</strong></td>
                                                <td><pre>${JSON.stringify(processedData.environment_before || {}, null, 2)}</pre></td>
                                            </tr>
                                            <tr>
                                                <td><strong>üåç ÌôòÍ≤Ω ÏÑ§Ï†ï (Ïù¥ÌõÑ)</strong></td>
                                                <td><pre>${JSON.stringify(processedData.environment_after || {}, null, 2)}</pre></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                            } else {
                                // Í∞ÄÍ≥µÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÏõêÎ≥∏ ÌëúÏãú
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Ìï≠Î™©</th>
                                                <th>Í∞í</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>üåç ÌôòÍ≤Ω ÏÑ§Ï†ï (Ïù¥Ï†Ñ)</strong></td>
                                                <td><pre>${JSON.stringify(processedData.environment_before || {}, null, 2)}</pre></td>
                                            </tr>
                                            <tr>
                                                <td><strong>üìã ÏûëÏóÖ ÏàúÏÑú</strong></td>
                                                <td><pre>${JSON.stringify(processedData.task_sequence || {}, null, 2)}</pre></td>
                                            </tr>
                                            <tr>
                                                <td><strong>üåç ÌôòÍ≤Ω ÏÑ§Ï†ï (Ïù¥ÌõÑ)</strong></td>
                                                <td><pre>${JSON.stringify(processedData.environment_after || {}, null, 2)}</pre></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                            }
                        } catch (error) {
                            console.error('3Îã®Í≥Ñ Í≤∞Í≥º Ìè¨Îß∑ÌåÖ Ïò§Î•ò:', error);
                            formattedResult = `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Ìï≠Î™©</th>
                                            <th>Í∞í</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>üöó Ï∞®Îüâ Í≥µÍ∞Ñ Í≥ÑÏÇ∞ Í≤∞Í≥º</strong></td>
                                            <td><pre>${processedData}</pre></td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        }
                        break;
                        
                    case 4: // ÏµúÏ†Å Î∞∞Ïπò ÏÉùÏÑ±
                        try {
                            // Í∞ÄÍ≥µÎêú Î∞∞Ïπò Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäî Í≤ΩÏö∞
                            if (processedData.placement_analysis) {
                                const analysis = processedData.placement_analysis;
                                const complexityText = {
                                    'basic': 'Í∏∞Î≥∏',
                                    'medium': 'Ï§ëÍ∞Ñ',
                                    'high': 'Í≥†Í∏â'
                                }[analysis.complexity_level] || 'Í∏∞Î≥∏';
                                
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Ìï≠Î™©</th>
                                                <th>Í∞í</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>üìè ÏΩîÎìú Í∏∏Ïù¥</strong></td>
                                                <td>${processedData.code_length || 0}Ïûê</td>
                                            </tr>
                                            <tr>
                                                <td><strong>üìã ÏßÄÏãúÏÇ¨Ìï≠ Ïàò</strong></td>
                                                <td>${analysis.total_instructions}Í∞ú</td>
                                            </tr>
                                            <tr>
                                                <td><strong>‚ö° Î≥µÏû°ÎèÑ</strong></td>
                                                <td>${complexityText}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>üìù Î∞∞Ïπò ÏΩîÎìú</strong></td>
                                                <td><pre>${processedData.placement_code || ''}</pre></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                            } else {
                                // Í∞ÄÍ≥µÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÏõêÎ≥∏ ÌëúÏãú
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Ìï≠Î™©</th>
                                                <th>Í∞í</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>üéØ ÏµúÏ†Å Î∞∞Ïπò ÏΩîÎìú</strong></td>
                                                <td><pre>${processedData.placement_code || ''}</pre></td>
                                            </tr>
                                            <tr>
                                                <td><strong>üìè ÏΩîÎìú Í∏∏Ïù¥</strong></td>
                                                <td>${processedData.code_length || 0}Ïûê</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                            }
                        } catch (error) {
                            console.error('4Îã®Í≥Ñ Í≤∞Í≥º Ìè¨Îß∑ÌåÖ Ïò§Î•ò:', error);
                            formattedResult = `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Ìï≠Î™©</th>
                                            <th>Í∞í</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>üéØ ÏµúÏ†Å Î∞∞Ïπò ÏÉùÏÑ± Í≤∞Í≥º</strong></td>
                                            <td><pre>${processedData}</pre></td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        }
                        break;
                        
                    default:
                        formattedResult = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ìï≠Î™©</th>
                                        <th>Í∞í</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>üìä Î∂ÑÏÑù Í≤∞Í≥º</strong></td>
                                        <td><pre>${JSON.stringify(processedData, null, 2)}</pre></td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                }
                
                return formattedResult;
                
            } catch (error) {
                console.error(`Í∞ÄÍ≥µÎêú Îã®Í≥Ñ ${stepNumber} Í≤∞Í≥º Ìè¨Îß∑ÌåÖ Ïò§Î•ò:`, error);
                return `<p>Îç∞Ïù¥ÌÑ∞ Ìè¨Îß∑ÌåÖ Ïò§Î•ò: ${error.message}</p><pre>${JSON.stringify(processedData, null, 2)}</pre>`;
            }
        }
        
        // Î∂ÑÏÑù ÏãúÏûë
        async function startAnalysis() {
            try {
                // ÏÉàÎ°úÏö¥ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ± (Ïù¥Ï†Ñ Îç∞Ïù¥ÌÑ∞ Î∞©ÏßÄ)
                const newScenario = `step_analysis_${new Date().toISOString().replace(/[:.]/g, '-')}`;
                console.log('ÏÉàÎ°úÏö¥ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±:', newScenario);
                
                // ÏÑ∏ÏÖò Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const analysisDataStr = sessionStorage.getItem('analysisData');
                let analysisData = {
                    people_count: 4,
                    image_data_url: 'default_image',
                    scenario: newScenario  // ÏÉàÎ°úÏö¥ ÏãúÎÇòÎ¶¨Ïò§ ÏÇ¨Ïö©
                };
                
                if (analysisDataStr) {
                    analysisData = (function(){
                        try { return JSON.parse(analysisDataStr); } catch { return {}; }
                    })();
                    // ÏÉàÎ°úÏö¥ ÏãúÎÇòÎ¶¨Ïò§Î°ú ÎçÆÏñ¥Ïì∞Í∏∞
                    analysisData.scenario = newScenario;
                    console.log('ÏÑ∏ÏÖòÏóêÏÑú Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò¥ (ÏÉàÎ°úÏö¥ ÏãúÎÇòÎ¶¨Ïò§ Ï†ÅÏö©):', {
                        scenario: analysisData.scenario,
                        people_count: analysisData.people_count,
                        image_data_url: analysisData.image_data_url.substring(0, 50) + '...'
                    });
                } else {
                    console.warn('ÏÑ∏ÏÖòÏóêÏÑú Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©');
                }
                
                // Î∂ÑÏÑù ÏãúÏûë API Ìò∏Ï∂ú
                console.log('Î∂ÑÏÑù API Ìò∏Ï∂ú ÏãúÏûë...');
                const response = await fetch('/desktop/api/step_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        people_count: analysisData.people_count,
                        image_data_url: analysisData.image_data_url,
                        scenario: analysisData.scenario
                    })
                });
                
                const result = await response.json();
                console.log('Î∂ÑÏÑù ÏãúÏûë ÏùëÎãµ:', result);
                
                if (result.success) {
                    console.log('Î∂ÑÏÑùÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏãúÏûëÎêòÏóàÏäµÎãàÎã§.');
                    // currentScenario ÏóÖÎç∞Ïù¥Ìä∏
                    currentScenario = newScenario;
                    console.log('ÌòÑÏû¨ ÏãúÎÇòÎ¶¨Ïò§ ÏóÖÎç∞Ïù¥Ìä∏:', currentScenario);
                    // ÏßÑÌñâÎ•† ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                    document.getElementById('progressText').textContent = 'AIÍ∞Ä Î∂ÑÏÑùÏùÑ ÏãúÏûëÌñàÏäµÎãàÎã§...';
                } else {
                    console.error('Î∂ÑÏÑù ÏãúÏûë Ïã§Ìå®:', result.message);
                    // Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú
                    document.getElementById('progressText').textContent = 'Î∂ÑÏÑù ÏãúÏûëÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + result.message;
                }
            } catch (error) {
                console.error('Î∂ÑÏÑù ÏãúÏûë Ïò§Î•ò:', error);
                document.getElementById('progressText').textContent = 'Î∂ÑÏÑù ÏãúÏûë Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message;
            }
        }

        function initializeAccordions() {
            const accordionItems = document.querySelectorAll('.accordion-item');
            accordionItems.forEach(item => {
                item.classList.remove('active');
            });
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            currentScenario = getScenarioFromURL();
            console.log('ÏãúÎÇòÎ¶¨Ïò§:', currentScenario);
            
            // Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï
            updateProgress(0);
            updateStepDisplay();
            // Î∂ÑÏÑù Ï§ëÏóêÎèÑ ÏÉÅÏÑ∏Î≥¥Í∏∞ Í∞ÄÎä•ÌïòÎèÑÎ°ù Î≤ÑÌäº ÎÖ∏Ï∂ú
            showResultButton();
            
            // Î∂ÑÏÑù ÏãúÏûë
            startAnalysis();
            
            // ÏïÑÏΩîÎîîÏñ∏ Ï¥àÍ∏∞Ìôî
            initializeAccordions();
            
            // SSE ÏãúÏûë
            try {
                if (eventSource) {
                    eventSource.close();
                }
                eventSource = new EventSource('/desktop/api/status_stream');
                eventSource.onmessage = (e) => {
                    try {
                        const payload = JSON.parse(e.data);
                        // Ïó∞Í≤∞ Ïù¥Î≤§Ìä∏Îäî Í±¥ÎÑàÎúÄ
                        if (payload && payload.event === 'connected') return;
                        handleStatusData(payload);
                        const status = payload.status || payload.system?.status;
                        const hasFinal = !!(payload.chain4_out || payload.analysis_result?.chain4_out || payload.processed_results?.chain4_out);
                        if (status === 'done' && hasFinal) {
                            document.getElementById('progressText').textContent = 'Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!';
                            showResultButton();
                            eventSource.close();
                        } else if (status === 'error') {
                            document.getElementById('progressText').textContent = 'Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                            eventSource.close();
                        }
                    } catch (err) {
                        console.error('SSE Î©îÏãúÏßÄ Ï≤òÎ¶¨ Ïò§Î•ò:', err);
                    }
                };
                eventSource.onerror = (e) => {
                    console.warn('SSE Ïò§Î•ò ÎòêÎäî Ï¢ÖÎ£å:', e);
                    try { eventSource.close(); } catch (_) {}
                };
            } catch (e) {
                console.error('SSE Ïó∞Í≤∞ Ïã§Ìå®:', e);
            }
        });
    </script>
</body>
</html>