<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë¶„ì„ ì§„í–‰ ì¤‘ - AI TETRIS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hyundai Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            color: #2d3748;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: white;
            padding: 10px 12px;
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        
        .title {
            font-size: 20px;
            font-weight: 700;
            color: white;
            text-align: center;
            flex: 1;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .refresh-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: white;
            padding: 10px 12px;
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        
        .main-content {
            /* background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%); */
            margin-top: 100px;
            padding: 32px 20px;
            text-align: center;
            max-width: 480px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .status-message {
            margin-bottom: 40px;
        }
        
        .status-title {
            font-size: 28px;
            font-weight: 800;
            color: #1a365d;
            letter-spacing: -0.5px;
        }
        
        .status-subtitle {
            font-size: 14px;
            color: #4a5568;
            font-weight: 500;
            opacity: 0.8;
        }
        
        .progress-info {
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            padding: 20px 24px;
            border-radius: 10px;
            margin-bottom: 32px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .progress-percentage {
            font-size: 40px;
            font-weight: 800;
            color: #1a365d;
            margin-bottom: 10px;
            text-shadow: 0 2px 8px rgba(26, 54, 93, 0.15);
            letter-spacing: -1px;
        }
        
        .progress-text {
            font-size: 18px;
            color: #4a5568;
            font-weight: 500;
            line-height: 1.4;
        }
        
        .illustration {
            margin: 30px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .ai-brain {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 50%, #4a5568 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: pulse 2s infinite;
            box-shadow: 0 12px 40px rgba(26, 54, 93, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .ai-brain::before {
            content: "ğŸš—";
            font-size: 48px;
        }
        
        .ai-brain::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid #002c5f;
            animation: ripple 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes ripple {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        
        .progress-steps {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 44, 95, 0.15);
            border: 1px solid rgba(0, 44, 95, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            flex: 1;
            min-width: 0;
            text-align: center;
            position: relative;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 2px;
            background: linear-gradient(90deg, #e9ecef 0%, #dee2e6 100%);
            z-index: 1;
        }
        
        .step.completed:not(:last-child)::after {
            background: linear-gradient(90deg, #00a651 0%, #00c853 100%);
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .step-icon.pending {
            background: #f7fafc;
            color: #a0aec0;
            border: 2px solid #e2e8f0;
        }
        
        .step-icon.active {
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            color: white;
            animation: pulse 1.5s infinite;
            box-shadow: 0 6px 20px rgba(26, 54, 93, 0.25);
            transform: scale(1.05);
        }
        
        .step-icon.completed {
            background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(56, 161, 105, 0.25);
            transform: scale(1.02);
        }
        
        .step-content {
            flex: 1;
            text-align: center;
        }
        
        .step-title {
            font-size: 12px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 6px;
            line-height: 1.3;
            letter-spacing: -0.2px;
        }
        
        .step-description {
            font-size: 10px;
            color: #718096;
            line-height: 1.3;
            font-weight: 500;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .result-check-button {
            width: 100%;
            padding: 20px 24px;
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(26, 54, 93, 0.25);
            letter-spacing: -0.3px;
            display: none;
        }
        
        .result-check-button.show {
            display: block;
        }
        
        .result-check-button:hover {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(26, 54, 93, 0.35);
        }
        
        .result-check-button:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(26, 54, 93, 0.3);
        }
        
        /* í–¥ìƒëœ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .main-content {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .progress-info {
            animation: slideIn 0.8s ease-out;
        }
        
        .progress-steps {
            animation: fadeInUp 1s ease-out;
        }
        
        /* ë‹¨ê³„ë³„ ê²°ê³¼ í‘œì‹œ ì˜ì—­ */
        .step-results {
            margin-top: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }
        
        .step-result-item {
            margin-bottom: 16px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #e2e8f0;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
        }
        
        .step-result-item.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .step-result-item.completed {
            border-left-color: #38a169;
            background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
        }
        
        .step-result-title {
            font-size: 14px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .step-result-title::before {
            content: "âœ“";
            margin-right: 8px;
            color: #38a169;
            font-weight: 800;
        }
        
        .step-result-content {
            font-size: 13px;
            color: #4a5568;
            line-height: 1.5;
            background: #f7fafc;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .step-result-content pre {
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            background: transparent;
            padding: 0;
            border: none;
        }
        
        /* í‘œ ìŠ¤íƒ€ì¼ */
        .step-result-content table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            margin: 12px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .step-result-content table thead {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        .step-result-content table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .step-result-content table td {
            padding: 12px 16px;
            font-size: 13px;
            color: #4a5568;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .step-result-content table tbody tr:hover {
            background: #f8fafc;
        }
        
        .step-result-content table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* í‘œ ë‚´ë¶€ pre íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .step-result-content table pre {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin: 4px 0;
            border: 1px solid #e9ecef;
            max-height: 150px;
            overflow-y: auto;
        }
        
        /* ë¶„ì„ ê²°ê³¼ ìš”ì•½ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .analysis-summary {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .summary-title {
            color: #2d3748;
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 16px 0;
            text-align: center;
        }
        
        .summary-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .summary-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #00a651;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .summary-item-title {
            color: #2d3748;
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }
        
        .summary-item-content {
            color: #4a5568;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .summary-item-content strong {
            color: #2d3748;
            font-weight: 600;
        }
        
        /* ë‹¨ê³„ë³„ ì™„ë£Œ í…ìŠ¤íŠ¸ í‘œì‹œ */
        .step-completion-text {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
            border-radius: 8px;
            border-left: 4px solid #38a169;
            font-size: 14px;
            color: #2d3748;
            line-height: 1.5;
            animation: slideInFromRight 0.5s ease-out;
        }
        
        .step-completion-text h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 700;
            color: #38a169;
            display: flex;
            align-items: center;
        }
        
        .step-completion-text h4::before {
            content: "âœ…";
            margin-right: 8px;
            font-size: 18px;
        }
        
        .step-completion-text p {
            margin: 8px 0;
            font-size: 13px;
            color: #4a5568;
        }
        
        .step-completion-text .highlight {
            background: #e6fffa;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: #2d3748;
        }
        
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="history.back()">âœ•</button>
        <h1 class="title">í˜„ëŒ€ìë™ì°¨ AI TETRIS ì„œë¹„ìŠ¤</h1>
        <button class="refresh-btn" onclick="location.reload()">â†»</button>
    </div>
    
    <div class="main-content">
        <div class="status-message">
            <h2 class="status-title">ì°¨ëŸ‰ ì‹œíŠ¸ ë°°ì¹˜ ë¶„ì„</h2>
            <!-- <p class="status-subtitle">ì°¨ëŸ‰ ì‹œíŠ¸ ë°°ì¹˜ ë¶„ì„</p> -->
        </div>

        <div class="illustration">
            <div class="ai-brain"></div>
        </div>

        <div class="progress-info">
            <div class="progress-percentage" id="progressPercentage">0%</div>
            <div class="progress-text" id="progressText">ë¶„ì„ì„ ì‹œì‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>
        
        <!-- ë¶„ì„ ê²°ê³¼ ìš”ì•½ ì˜ì—­ -->
        <div class="analysis-summary" id="analysisSummary" style="display: none;">
            <h3 class="summary-title">ë¶„ì„ ê²°ê³¼ ìš”ì•½</h3>
            <div class="summary-content" id="summaryContent">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ìš”ì•½ ë‚´ìš© -->
            </div>
        </div>
        
        <div class="progress-steps">
            <div class="step" id="step1">
                <div class="step-icon pending">1</div>
                <div class="step-content">
                    <div class="step-title">ì´ë¯¸ì§€ ë¶„ì„</div>
                    <div class="step-description">ì‚¬ì§„ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
        </div>
            </div>
            
            <div class="step" id="step2">
                <div class="step-icon pending">2</div>
                <div class="step-content">
                    <div class="step-title">ì§ ì¸ì‹ ë° ë¶„ë¥˜</div>
                    <div class="step-description">ì§ì„ ì¸ì‹í•˜ê³  ë¶„ë¥˜í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
            </div>
        </div>
            
            <div class="step" id="step3">
                <div class="step-icon pending">3</div>
                <div class="step-content">
                    <div class="step-title">ì°¨ëŸ‰ ê³µê°„ ê³„ì‚°</div>
                    <div class="step-description">ì°¨ëŸ‰ ê³µê°„ì„ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
                </div>
        </div>
            
            <div class="step" id="step4">
                <div class="step-icon pending">4</div>
                <div class="step-content">
                    <div class="step-title">ìµœì  ë°°ì¹˜ ìƒì„±</div>
                    <div class="step-description">ìµœì ì˜ ë°°ì¹˜ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
                </div>
        </div>
            
            <div class="step" id="step5">
                <div class="step-icon pending">5</div>
                <div class="step-content">
                    <div class="step-title">ê²°ê³¼ ê²€ì¦ ë° ì™„ë£Œ</div>
                    <div class="step-description">ê²°ê³¼ë¥¼ ê²€ì¦í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
                </div>
            </div>
        </div>
        
        <!-- ë‹¨ê³„ë³„ ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        <div class="step-results" id="stepResults">
            <div class="step-result-item" id="step1Result" style="display: none;">
                <div class="step-result-title">1ë‹¨ê³„: ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼</div>
                <div class="step-result-content" id="step1ResultContent">ë¶„ì„ ì¤‘...</div>
            </div>
            
            <div class="step-result-item" id="step2Result" style="display: none;">
                <div class="step-result-title">2ë‹¨ê³„: ì§ ì¸ì‹ ë° ë¶„ë¥˜ ê²°ê³¼</div>
                <div class="step-result-content" id="step2ResultContent">ë¶„ì„ ì¤‘...</div>
            </div>
            
            <div class="step-result-item" id="step3Result" style="display: none;">
                <div class="step-result-title">3ë‹¨ê³„: ì°¨ëŸ‰ ê³µê°„ ê³„ì‚° ê²°ê³¼</div>
                <div class="step-result-content" id="step3ResultContent">ë¶„ì„ ì¤‘...</div>
            </div>
            
            <div class="step-result-item" id="step4Result" style="display: none;">
                <div class="step-result-title">4ë‹¨ê³„: ìµœì  ë°°ì¹˜ ìƒì„± ê²°ê³¼</div>
                <div class="step-result-content" id="step4ResultContent">ë¶„ì„ ì¤‘...</div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <button class="result-check-button" id="resultCheckButton" onclick="showResult()">
            ğŸ“Š ë¶„ì„ ê²°ê³¼ í™•ì¸
        </button>
</div>
    
    <script>
        let currentStep = 0;
        let progressValue = 0;
        let doneWaitCount = 0;
        let currentScenario = null;
        let eventSource = null;
        let shownSteps = { 1: false, 2: false, 3: false, 4: false };
        
        // URLì—ì„œ ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getScenarioFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('scenario') || 'default';
        }
        
        // ë’¤ë¡œê°€ê¸°
        function goBack() {
            window.history.back();
        }
        
        // HTTP í´ë§ ì œê±°ë¨: ìƒíƒœ ìƒˆë¡œê³ ì¹¨ì€ SSEë¡œë§Œ ì²˜ë¦¬
        
        // í˜„ì¬ ë‹¨ê³„ì— ë§ëŠ” ë¬¸êµ¬ ë°˜í™˜
        function getCurrentStepMessage(step) {
            const messages = {
                1: "ì´ë¯¸ì§€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...",
                2: "ì§ ì¸ì‹ ë° ë¶„ë¥˜ ì¤‘ì…ë‹ˆë‹¤...",
                3: "ì°¨ëŸ‰ ê³µê°„ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...",
                4: "ìµœì  ë°°ì¹˜ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...",
                5: "ê²°ê³¼ ê²€ì¦ ë° ì™„ë£Œ ì¤‘ì…ë‹ˆë‹¤..."
            };
            return messages[step] || "ë¶„ì„ì„ ì‹œì‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...";
        }
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ - ì„œë²„ ê°’ë§Œ ì‚¬ìš©
        function updateProgress(percentage, serverStep = null) {
            // ì§„í–‰ë¥ ì€ í›„í‡´í•˜ì§€ ì•Šë„ë¡ ë³´ì¥
            if (typeof percentage === 'number') {
                progressValue = Math.max(progressValue || 0, percentage);
                document.getElementById('progressPercentage').textContent = progressValue + '%';
            }
            
            // ì„œë²„ ë‹¨ê³„ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
            if (serverStep === null || serverStep === undefined) {
                console.log('âš ï¸ ì„œë²„ì—ì„œ ë‹¨ê³„ ì •ë³´ë¥¼ ë°›ì§€ ëª»í•¨, í˜„ì¬ ë‹¨ê³„ ìœ ì§€');
                return;
            }
            console.log('âœ… ì„œë²„ì—ì„œ ë°›ì€ ë‹¨ê³„:', serverStep);
            
            // ë‹¨ê³„ëŠ” í›„í‡´í•˜ì§€ ì•Šë„ë¡ ë³´ì¥ (ë‹¨, 1ë‹¨ê³„ë¡œì˜ ì´ˆê¸°í™”ëŠ” í—ˆìš©)
            if (serverStep < currentStep && serverStep !== 1) {
                console.log('â­ï¸ ë‹¨ê³„ í›„í‡´ ê°ì§€, ë¬´ì‹œí•©ë‹ˆë‹¤. (í˜„ì¬:', currentStep, 'ìˆ˜ì‹ :', serverStep, ')');
                return;
            }
            
            if (serverStep !== currentStep) {
                currentStep = serverStep;
                updateStepDisplay();
                document.getElementById('progressText').textContent = getCurrentStepMessage(currentStep);
                console.log('ë‹¨ê³„ ë³€ê²½:', currentStep + 'ë‹¨ê³„ë¡œ ì—…ë°ì´íŠ¸');
            }
        }
        
        // ë‹¨ê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStepDisplay() {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                const icon = step.querySelector('.step-icon');
                const title = step.querySelector('.step-title');
                const description = step.querySelector('.step-description');
                
                if (i < currentStep) {
                    // ì™„ë£Œëœ ë‹¨ê³„
                    icon.className = 'step-icon completed';
                    icon.textContent = 'âœ“';
                    title.style.color = '#28a745';
                    description.textContent = 'ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
                } else if (i === currentStep) {
                    // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë‹¨ê³„
                    if (currentStep === 5) {
                        // 5ë‹¨ê³„ëŠ” ì™„ë£Œ ìƒíƒœë¡œ í‘œì‹œ
                        icon.className = 'step-icon completed';
                        icon.textContent = 'âœ“';
                        title.style.color = '#28a745';
                        description.textContent = 'ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                    } else {
                        icon.className = 'step-icon active';
                        icon.textContent = i;
                        title.style.color = '#007bff';
                        description.textContent = 'ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...';
                    }
                } else {
                    // ëŒ€ê¸° ì¤‘ì¸ ë‹¨ê³„
                    icon.className = 'step-icon pending';
                    icon.textContent = i;
                    title.style.color = '#999';
                    description.textContent = 'ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤';
                }
            }
        }
        
        // SSE ìƒíƒœ ìˆ˜ì‹  í•¸ë“¤ëŸ¬
        function handleStatusData(statusData) {
            try {
                if (statusData) {
                    console.log('SSE ìƒíƒœ ë°ì´í„°:', statusData);
                    
                    // ì „ì²´ statusData ë¡œê·¸ ì¶œë ¥
                    console.log('ğŸ“Š ì „ì²´ statusData:', statusData);
                    console.log('ğŸ” statusData.current_step:', statusData.current_step);
                    console.log('ğŸ” statusData.processing:', statusData.processing);
                    console.log('ğŸ” statusData.progress:', statusData.progress);
                    console.log('ğŸ” statusData.status:', statusData.status);
                    
                    // ì„œë²„ì—ì„œ ë°›ì€ ë‹¨ê³„ ì •ë³´ í™•ì¸
                    const serverStep = statusData.current_step || statusData.processing?.current_step;
                    console.log('âœ… ì„œë²„ ë‹¨ê³„ ì •ë³´:', serverStep);
                    
                    // current_stepì´ undefinedì¸ì§€ í™•ì¸
                    if (statusData.current_step === undefined) {
                        console.warn('âš ï¸ current_stepì´ undefinedì…ë‹ˆë‹¤!');
                    } else {
                        console.log('âœ… current_step ê°’:', statusData.current_step, 'íƒ€ì…:', typeof statusData.current_step);
                    }
                    
                    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì„œë²„ ê°’ë§Œ ì‚¬ìš©)
                    const progress = statusData.progress || statusData.processing?.progress;
                    if (progress !== undefined && serverStep !== null && serverStep !== undefined) {
                        console.log('ğŸ“Š ì„œë²„ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸:', progress + '%', 'ë‹¨ê³„:', serverStep);
                        updateProgress(progress, serverStep);
                    } else {
                        console.log('âš ï¸ ì„œë²„ì—ì„œ ì§„í–‰ë¥  ë˜ëŠ” ë‹¨ê³„ ì •ë³´ê°€ ë¶ˆì™„ì „í•¨:', {
                            progress: progress,
                            serverStep: serverStep
                        });
                    }
                    
                    // ì„œë²„ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ (ì§„í–‰ë¥ ê³¼ ë…ë¦½ì ìœ¼ë¡œ)
                    const serverMessage = statusData.message;
                    if (serverMessage) {
                        document.getElementById('progressText').textContent = serverMessage;
                        console.log('ğŸ“ ì„œë²„ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸:', serverMessage);
                    }
                    
                    // í˜„ì¬ ë‹¨ê³„ í™•ì¸
                    const currentStep = statusData.current_step || 0;
                    console.log(`í˜„ì¬ ë‹¨ê³„: ${currentStep}`);
                    console.log(`í˜„ì¬ ë‹¨ê³„ íƒ€ì…: ${typeof currentStep}`);
                    console.log(`currentStep >= 1: ${currentStep >= 1}`);
                    console.log(`currentStep >= 2: ${currentStep >= 2}`);
                    console.log(`currentStep >= 3: ${currentStep >= 3}`);
                    console.log(`currentStep >= 4: ${currentStep >= 4}`);
                    
                    // ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘ ê°ì§€ (current_stepì´ 1ì´ê³  ì´ì „ì— ë” ë†’ì€ ë‹¨ê³„ì˜€ë˜ ê²½ìš°)
                    if (currentStep === 1) {
                        console.log('ğŸ”„ ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘ ê°ì§€ - ì´ì „ ê²°ê³¼ í´ë¦¬ì–´');
                        clearAllStepResults();
                    }
                    
                    // ì´ë²ˆ ì´ë²¤íŠ¸ payloadì— í¬í•¨ëœ 'ìƒˆë¡œ ì™„ë£Œëœ ìŠ¤í…'ë§Œ í‘œì‹œ
                    const ar = statusData.analysis_result || {};
                    if (ar.chain1_out && !shownSteps[1]) {
                        displayStepResult(1, ar.chain1_out);
                        updateAnalysisSummary(1, statusData);
                        shownSteps[1] = true;
                    }
                    if (ar.chain2_out && !shownSteps[2]) {
                        displayStepResult(2, ar.chain2_out);
                        updateAnalysisSummary(2, statusData);
                        shownSteps[2] = true;
                    }
                    if (ar.chain3_out && !shownSteps[3]) {
                        displayStepResult(3, ar.chain3_out);
                        updateAnalysisSummary(3, statusData);
                        shownSteps[3] = true;
                    }
                    if (ar.chain4_out && !shownSteps[4]) {
                        displayStepResult(4, ar.chain4_out);
                        updateAnalysisSummary(4, statusData);
                        shownSteps[4] = true;
                    }
                    
                    // 5ë‹¨ê³„ ì™„ë£Œ ì‹œ - ì‹¤ì œ 4ë‹¨ê³„ ê²°ê³¼ê°€ ë„ì°©í•œ ê²½ìš°ì—ë§Œ ì™„ë£Œ ì²˜ë¦¬
                    const hasStep4Output = !!(shownSteps[4] || statusData.analysis_result?.chain4_out);
                    if (currentStep >= 5 && hasStep4Output) {
                        console.log('âœ… 5ë‹¨ê³„ ì™„ë£Œ - ë¶„ì„ ì™„ë£Œ ì²˜ë¦¬ (ì¶œë ¥ í™•ì¸ë¨)');
                        updateProgress(100, 5);
                        document.getElementById('progressText').textContent = 'ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                        showResultButton();
                    } else if (currentStep >= 5 && !hasStep4Output) {
                        doneWaitCount = (doneWaitCount || 0) + 1;
                        console.log(`â³ 5ë‹¨ê³„ ì‹ í˜¸ ìˆ˜ì‹ , ê·¸ëŸ¬ë‚˜ step4 ì¶œë ¥ ë¯¸ë„ì°© â†’ ì™„ë£Œ ì²˜ë¦¬ ë³´ë¥˜ (ì‹œë„ ${doneWaitCount})`);
                        // ì•ˆì „ì¥ì¹˜: ì¼ì • íšŸìˆ˜(ì˜ˆ: 5íšŒ) ì´ìƒ ëŒ€ê¸° ì‹œ ì™„ë£Œë¡œ ê°„ì£¼
                        if (doneWaitCount >= 5) {
                            console.log('âš ï¸ ìµœì¢… ì¶œë ¥ ë¯¸ë„ì°© íƒ€ì„ì•„ì›ƒ â†’ ì™„ë£Œë¡œ ê°„ì£¼í•˜ê³  ì¢…ë£Œ');
                            document.getElementById('progressText').textContent = 'ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                            updateProgress(100, 5);
                            showResultButton();
                        }
                    }
                    
                    // ìƒíƒœì— ë”°ë¥¸ ì²˜ë¦¬
                    const status = statusData.status || statusData.system?.status;
                    if (status === 'done') {
                        const hasFinal = !!(statusData.chain4_out || statusData.analysis_result?.chain4_out || statusData.processed_results?.chain4_out);
                        if (hasFinal) {
                            console.log('ë¶„ì„ ì™„ë£Œ! (ìµœì¢… ì¶œë ¥ í™•ì¸)');
                            document.getElementById('progressText').textContent = 'ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                            showResultButton();
                        } else {
                            doneWaitCount = (doneWaitCount || 0) + 1;
                            console.log(`ë¶„ì„ ì™„ë£Œ ì‹ í˜¸ ìˆ˜ì‹ , ê·¸ëŸ¬ë‚˜ ìµœì¢… ì¶œë ¥ ë¯¸ë„ì°© â†’ í´ë§ ìœ ì§€ (ì‹œë„ ${doneWaitCount})`);
                        }
                    } else if (status === 'error') {
                        console.log('ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ');
                        document.getElementById('progressText').textContent = 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    }
                }
            } catch (error) {
                console.error('ìƒíƒœ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            }
        }
        
        // ê²°ê³¼ í™•ì¸ ë²„íŠ¼ í‘œì‹œ
        function showResultButton() {
            const button = document.getElementById('resultCheckButton');
            button.classList.add('show');
        }
        
        // ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™
        function showResult() {
            window.location.href = '/mobile/result';
        }
        
        // ë‹¨ê³„ë³„ ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateStepResults(resultData) {
            console.log('updateStepResults í˜¸ì¶œë¨:', resultData);
            
            // 1ë‹¨ê³„: ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼
            if (resultData.chain1_out) {
                console.log('1ë‹¨ê³„ ê²°ê³¼ ë°œê²¬:', resultData.chain1_out);
                displayStepResult(1, resultData.chain1_out);
            }
            
            // 2ë‹¨ê³„: ì§ ì¸ì‹ ë° ë¶„ë¥˜ ê²°ê³¼
            if (resultData.chain2_out) {
                console.log('2ë‹¨ê³„ ê²°ê³¼ ë°œê²¬:', resultData.chain2_out);
                displayStepResult(2, resultData.chain2_out);
            }
            
            // 3ë‹¨ê³„: ì°¨ëŸ‰ ê³µê°„ ê³„ì‚° ê²°ê³¼
            if (resultData.chain3_out) {
                console.log('3ë‹¨ê³„ ê²°ê³¼ ë°œê²¬:', resultData.chain3_out);
                displayStepResult(3, resultData.chain3_out);
            }
            
            // 4ë‹¨ê³„: ìµœì  ë°°ì¹˜ ìƒì„± ê²°ê³¼
            if (resultData.chain4_out) {
                console.log('4ë‹¨ê³„ ê²°ê³¼ ë°œê²¬:', resultData.chain4_out);
                displayStepResult(4, resultData.chain4_out);
            }
        }
        
        // ê°€ê³µëœ ë‹¨ê³„ë³„ ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateProcessedStepResults(processedResults) {
            console.log('updateProcessedStepResults í˜¸ì¶œë¨:', processedResults);
            
            // 1ë‹¨ê³„: ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼
            if (processedResults.chain1_out) {
                console.log('ê°€ê³µëœ 1ë‹¨ê³„ ê²°ê³¼ ë°œê²¬:', processedResults.chain1_out);
                displayProcessedStepResult(1, processedResults.chain1_out);
            }
            
            // 2ë‹¨ê³„: ì§ ì¸ì‹ ë° ë¶„ë¥˜ ê²°ê³¼
            if (processedResults.chain2_out) {
                console.log('ê°€ê³µëœ 2ë‹¨ê³„ ê²°ê³¼ ë°œê²¬:', processedResults.chain2_out);
                displayProcessedStepResult(2, processedResults.chain2_out);
            }
            
            // 3ë‹¨ê³„: ì°¨ëŸ‰ ê³µê°„ ê³„ì‚° ê²°ê³¼
            if (processedResults.chain3_out) {
                console.log('ê°€ê³µëœ 3ë‹¨ê³„ ê²°ê³¼ ë°œê²¬:', processedResults.chain3_out);
                displayProcessedStepResult(3, processedResults.chain3_out);
            }
            
            // 4ë‹¨ê³„: ìµœì  ë°°ì¹˜ ìƒì„± ê²°ê³¼
            if (processedResults.chain4_out) {
                console.log('ê°€ê³µëœ 4ë‹¨ê³„ ê²°ê³¼ ë°œê²¬:', processedResults.chain4_out);
                displayProcessedStepResult(4, processedResults.chain4_out);
            }
        }
        
        // ëª¨ë“  ë‹¨ê³„ ê²°ê³¼ í´ë¦¬ì–´
        function clearAllStepResults() {
            console.log('ğŸ§¹ ëª¨ë“  ë‹¨ê³„ ê²°ê³¼ í´ë¦¬ì–´ ì‹œì‘');
            
            for (let i = 1; i <= 4; i++) {
                const resultElement = document.getElementById(`step${i}Result`);
                const contentElement = document.getElementById(`step${i}ResultContent`);
                
                if (resultElement && contentElement) {
                    contentElement.innerHTML = '';
                    resultElement.style.display = 'none';
                    console.log(`ğŸ§¹ ${i}ë‹¨ê³„ ê²°ê³¼ í´ë¦¬ì–´ ì™„ë£Œ`);
                }
            }
            
            // ìš”ì•½ ì˜ì—­ë„ í´ë¦¬ì–´
            const summaryElement = document.getElementById('analysisSummary');
            const summaryContent = document.getElementById('summaryContent');
            if (summaryElement && summaryContent) {
                summaryContent.innerHTML = '';
                summaryElement.style.display = 'none';
                console.log('ğŸ§¹ ë¶„ì„ ìš”ì•½ í´ë¦¬ì–´ ì™„ë£Œ');
            }
            
            console.log('ğŸ§¹ ëª¨ë“  ë‹¨ê³„ ê²°ê³¼ í´ë¦¬ì–´ ì™„ë£Œ');
        }
        
        // ì•ˆì „ ìœ í‹¸ë¦¬í‹° (ì‚­ì œë˜ì—ˆì„ ìˆ˜ ìˆì–´ ì¬ì •ì˜)
        function safeSliceText(value, max = 100) {
            try {
                if (typeof value !== 'string') {
                    value = JSON.stringify(value);
                }
            } catch (_) {
                value = String(value);
            }
            if (!value) return '';
            return value.length > max ? value.slice(0, max) + '...' : value;
        }
        
        function safeJsonParse(data) {
            if (data && typeof data === 'object') {
                return data;
            }
            if (typeof data !== 'string') {
                return null;
            }
            let s = data.trim();
            // ì½”ë“œíœìŠ¤ ì œê±°
            if (s.startsWith('```')) {
                s = s.replace(/^```json\s*/i, '')
                     .replace(/^```/i, '')
                     .replace(/```$/i, '')
                     .trim();
            }
            s = s.replace(/```json\s*|```/gi, '').trim();
            // JSON í˜•ì‹ì´ ì•„ë‹ˆë©´ ìŠ¤í‚µ
            if (!(s.startsWith('{') || s.startsWith('['))) {
                return null;
            }
            try {
                return JSON.parse(s);
            } catch (_) {
                return null;
            }
        }
        
        // ë¶„ì„ ê²°ê³¼ ìš”ì•½ ì—…ë°ì´íŠ¸
        function updateAnalysisSummary(step, data) {
            console.log(`ğŸ“Š ${step}ë‹¨ê³„ ìš”ì•½ ì—…ë°ì´íŠ¸:`, data);
            
            const summaryElement = document.getElementById('analysisSummary');
            const summaryContent = document.getElementById('summaryContent');
            
            if (!summaryElement || !summaryContent) {
                console.error('ìš”ì•½ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ìš”ì•½ ì˜ì—­ í‘œì‹œ
            summaryElement.style.display = 'block';
            
            // ë‹¨ê³„ë³„ ìš”ì•½ ìƒì„±
            let summaryHtml = '';
            
            // 1ë‹¨ê³„: ì´ë¯¸ì§€ ë¶„ì„
            if (step >= 1 && data.chain1_out) {
                const chain1Data = typeof data.chain1_out === 'string' ? safeJsonParse(data.chain1_out) : data.chain1_out;
                const peopleCount = chain1Data.people || chain1Data.people_count || 0;
                const totalLuggage = chain1Data.total_luggage || chain1Data.total_luggage_count || 0;
                
                summaryHtml += `
                    <div class="summary-item">
                        <div class="summary-item-content">
                            <strong>ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼</strong> íƒ‘ìŠ¹ì ìˆ˜: ${peopleCount}ëª…, ì´ ì§ ê°œìˆ˜: ${totalLuggage}ê°œ
                        </div>
                    </div>
                `;
            }
            
            // 2ë‹¨ê³„: ì§ ì¸ì‹ ë° ë¶„ë¥˜
            if (step >= 2 && data.chain2_out) {
                const chain2Data = typeof data.chain2_out === 'string' ? safeJsonParse(data.chain2_out) : data.chain2_out;
                const instruction = chain2Data.instruction || 'ë¶„ë¥˜ ì •ë³´ ì—†ìŒ';
                
                summaryHtml += `
                    <div class="summary-item">
                        <div class="summary-item-content">
                            <strong>ì§ ì¸ì‹ ë° ë¶„ë¥˜ ê²°ê³¼</strong> ë¶„ë¥˜ ì •ë³´: ${instruction.length} -->
                        </div>
                    </div>
                `;
            }
            
            // 3ë‹¨ê³„: ì°¨ëŸ‰ ê³µê°„ ê³„ì‚°
            if (step >= 3 && data.chain3_out) {
                const chain3Data = typeof data.chain3_out === 'string' ? safeJsonParse(data.chain3_out) : data.chain3_out;
                const taskSequence = chain3Data.task_sequence || 'ì‘ì—… ìˆœì„œ ì—†ìŒ';
                
                summaryHtml += `
                    <div class="summary-item">
                        <div class="summary-item-content">
                            <strong>ì°¨ëŸ‰ ê³µê°„ ê³„ì‚° ê²°ê³¼</strong> ì‘ì—… ìˆœì„œ: ${taskSequence.length}
                        </div>
                    </div>
                `;
            }
            
            // 4ë‹¨ê³„: ìµœì  ë°°ì¹˜ ìƒì„±
            if (step >= 4 && data.chain4_out) {
                const chain4Data = data.chain4_out;
                const codeLength = chain4Data.length || 0;
                
                summaryHtml += `
                    <div class="summary-item">
                        <div class="summary-item-content">
                            <strong>ìµœì  ë°°ì¹˜ ìƒì„± ê²°ê³¼</strong> ì½”ë“œ ê¸¸ì´: ${codeLength}ì
                        </div>
                    </div>
                `;
            }
            
            summaryContent.innerHTML = summaryHtml;
            console.log(`ğŸ“Š ${step}ë‹¨ê³„ ìš”ì•½ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
        }
        
        // íŠ¹ì • ë‹¨ê³„ì˜ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
        function displayStepResult(stepNumber, resultData) {
            console.log(`ğŸ¯ displayStepResult í˜¸ì¶œë¨: ë‹¨ê³„ ${stepNumber}, ë°ì´í„°:`, resultData);
            
            const resultElement = document.getElementById(`step${stepNumber}Result`);
            const contentElement = document.getElementById(`step${stepNumber}ResultContent`);
            
            console.log(`ğŸ¯ ìš”ì†Œ í™•ì¸: resultElement=${!!resultElement}, contentElement=${!!contentElement}`);
            
            if (!resultElement || !contentElement) {
                console.error(`ë‹¨ê³„ ${stepNumber} ê²°ê³¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
            
            // ì´ì „ ë°ì´í„° í´ë¦¬ì–´
            contentElement.innerHTML = '';
            resultElement.style.display = 'none';
            
            // ê²°ê³¼ ë°ì´í„° í¬ë§·íŒ…
            const formattedResult = formatStepResult(stepNumber, resultData);
            console.log(`ğŸ¯ í¬ë§·ëœ ê²°ê³¼:`, formattedResult);
            
            // ë‚´ìš© ì—…ë°ì´íŠ¸
            contentElement.innerHTML = formattedResult;
            
            // ê²°ê³¼ ì˜ì—­ í‘œì‹œ
            resultElement.style.display = 'block';
            
            // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ í‘œì‹œ
            setTimeout(() => {
                resultElement.classList.add('show', 'completed');
                initResultToggle(stepNumber);
            }, 100);
            
            console.log(`ë‹¨ê³„ ${stepNumber} ê²°ê³¼ í‘œì‹œ ì™„ë£Œ`);
        }
        
        // ê°€ê³µëœ íŠ¹ì • ë‹¨ê³„ì˜ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
        function displayProcessedStepResult(stepNumber, processedData) {
            const resultElement = document.getElementById(`step${stepNumber}Result`);
            const contentElement = document.getElementById(`step${stepNumber}ResultContent`);
            
            if (!resultElement || !contentElement) {
                console.error(`ë‹¨ê³„ ${stepNumber} ê²°ê³¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
            
            // ì´ì „ ë°ì´í„° í´ë¦¬ì–´
            contentElement.innerHTML = '';
            resultElement.style.display = 'none';
            
            // ê°€ê³µëœ ê²°ê³¼ ë°ì´í„° í¬ë§·íŒ…
            const formattedResult = formatProcessedStepResult(stepNumber, processedData);
            
            // ë‚´ìš© ì—…ë°ì´íŠ¸
            contentElement.innerHTML = formattedResult;
            
            // ê²°ê³¼ ì˜ì—­ í‘œì‹œ
            resultElement.style.display = 'block';
            
            // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ í‘œì‹œ
            setTimeout(() => {
                resultElement.classList.add('show', 'completed');
                initResultToggle(stepNumber);
            }, 100);
            
            // ë‹¨ê³„ë³„ ì™„ë£Œ í…ìŠ¤íŠ¸ í‘œì‹œ
            showStepCompletionText(stepNumber, processedData);
            
            console.log(`ê°€ê³µëœ ë‹¨ê³„ ${stepNumber} ê²°ê³¼ í‘œì‹œ ì™„ë£Œ`);
        }
        
        // ë‹¨ê³„ë³„ ì™„ë£Œ í…ìŠ¤íŠ¸ í‘œì‹œ
        function showStepCompletionText(stepNumber, processedData) {
            const stepResultsContainer = document.getElementById('stepResults');
            if (!stepResultsContainer) return;
            
            // ê¸°ì¡´ ì™„ë£Œ í…ìŠ¤íŠ¸ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            const existingText = document.getElementById(`step${stepNumber}CompletionText`);
            if (existingText) {
                existingText.remove();
            }
            
            // ì™„ë£Œ í…ìŠ¤íŠ¸ ìƒì„±
            const completionText = createStepCompletionText(stepNumber, processedData);
            
            // ì™„ë£Œ í…ìŠ¤íŠ¸ë¥¼ í•´ë‹¹ ë‹¨ê³„ ê²°ê³¼ ì•„ë˜ì— ì‚½ì…
            const resultElement = document.getElementById(`step${stepNumber}Result`);
            if (resultElement) {
                resultElement.insertAdjacentHTML('afterend', completionText);
            } else {
                // ê²°ê³¼ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì»¨í…Œì´ë„ˆì— ì§ì ‘ ì¶”ê°€
                stepResultsContainer.insertAdjacentHTML('beforeend', completionText);
            }
            
            console.log(`ë‹¨ê³„ ${stepNumber} ì™„ë£Œ í…ìŠ¤íŠ¸ í‘œì‹œ ì™„ë£Œ`);
        }
        
        // ê²°ê³¼ ë¸”ë¡ ì ‘ê¸°/í¼ì¹˜ê¸° í† ê¸€ ì´ˆê¸°í™”
        function initResultToggle(stepNumber) {
            const item = document.getElementById(`step${stepNumber}Result`);
            if (!item) return;
            const title = item.querySelector('.step-result-title');
            const content = item.querySelector('.step-result-content');
            if (!title || !content) return;

            // ì´ˆê¸° ë†’ì´ ì„¤ì •
            if (!item.classList.contains('expanded')) {
                content.style.maxHeight = '0px';
            }

            // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
            title.removeEventListener('click', title._toggleHandler);
            title._toggleHandler = () => {
                const isExpanded = item.classList.contains('expanded');
                if (isExpanded) {
                    item.classList.remove('expanded');
                    content.style.maxHeight = '0px';
                } else {
                    item.classList.add('expanded');
                    content.style.maxHeight = content.scrollHeight + 'px';
                }
            };
            title.addEventListener('click', title._toggleHandler);
        }

        // ë‹¨ê³„ë³„ ì™„ë£Œ í…ìŠ¤íŠ¸ ìƒì„±
        function createStepCompletionText(stepNumber, processedData) {
            let title = '';
            let content = '';
            
            switch(stepNumber) {
                case 1: // ì´ë¯¸ì§€ ë¶„ì„
                    title = '1ë‹¨ê³„: ì´ë¯¸ì§€ ë¶„ì„ ì™„ë£Œ';
                    content = `
                        <p><span class="highlight">${processedData.people_count || 0}ëª…</span></p>
                        <p><strong>ğŸ§³ ì´ ì§ ê°œìˆ˜:</strong> <span class="highlight">${processedData.total_luggage || 0}ê°œ</span></p>
                        <p>ì´ë¯¸ì§€ì—ì„œ <span class="highlight">${processedData.people_count || 0}ëª…ì˜ ì¸ì›</span>ê³¼ <span class="highlight">${processedData.total_luggage || 0}ê°œì˜ ì§</span>ì„ ì„±ê³µì ìœ¼ë¡œ ì¸ì‹í–ˆìŠµë‹ˆë‹¤.</p>
                    `;
                    break;
                    
                case 2: // ì§ ì¸ì‹ ë° ë¶„ë¥˜
                    title = '2ë‹¨ê³„: ì§ ì¸ì‹ ë° ë¶„ë¥˜ ì™„ë£Œ';
                    content = `
                        <p><strong>ğŸª‘ ì¢Œì„ ë°°ì¹˜ ì§€ì‹œì‚¬í•­ ìƒì„± ì™„ë£Œ</strong></p>
                        <p>ê° ì§ì˜ íŠ¹ì„±ì— ë§ëŠ” <span class="highlight">ì¢Œì„ ë°°ì¹˜ ì§€ì‹œì‚¬í•­</span>ì„ ì„±ê³µì ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤.</p>
                    `;
                    break;
                    
                case 3: // ì°¨ëŸ‰ ê³µê°„ ê³„ì‚°
                    title = '3ë‹¨ê³„: ì°¨ëŸ‰ ê³µê°„ ê³„ì‚° ì™„ë£Œ';
                    content = `
                        <p><strong>ğŸš— ì°¨ëŸ‰ í™˜ê²½ ë¶„ì„ ì™„ë£Œ</strong></p>
                        <p>ì°¨ëŸ‰ì˜ <span class="highlight">ê³µê°„ êµ¬ì¡°</span>ì™€ <span class="highlight">ì‘ì—… ìˆœì„œ</span>ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê³„ì‚°í–ˆìŠµë‹ˆë‹¤.</p>
                    `;
                    break;
                    
                case 4: // ìµœì  ë°°ì¹˜ ìƒì„±
                    title = '4ë‹¨ê³„: ìµœì  ë°°ì¹˜ ìƒì„± ì™„ë£Œ';
                    content = `
                        <p><strong>ğŸ¯ ìµœì  ë°°ì¹˜ ì½”ë“œ ìƒì„± ì™„ë£Œ</strong></p>
                        <p><span class="highlight">${processedData.code_length || 0}ìë¦¬ ë°°ì¹˜ ì½”ë“œ</span>ë¥¼ ì„±ê³µì ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤.</p>
                        <p>ì½”ë“œ: <span class="highlight">${processedData.placement_code || ''}</span></p>
                    `;
                    break;
                    
                default:
                    title = `${stepNumber}ë‹¨ê³„: ë¶„ì„ ì™„ë£Œ`;
                    content = `<p>ë¶„ì„ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
            }
            
            return `
                <div class="step-completion-text" id="step${stepNumber}CompletionText">
                    <h4>${title}</h4>
                    ${content}
                </div>
            `;
        }
        
        // ë‹¨ê³„ë³„ ê²°ê³¼ ë°ì´í„° í¬ë§·íŒ…
        function formatStepResult(stepNumber, resultData) {
            console.log(`ğŸ”§ formatStepResult í˜¸ì¶œë¨: ë‹¨ê³„ ${stepNumber}, ë°ì´í„° íƒ€ì…: ${typeof resultData}`);
            try {
                let formattedResult = '';
                
                switch(stepNumber) {
                    case 1: // ì´ë¯¸ì§€ ë¶„ì„
                        console.log(`ğŸ”§ 1ë‹¨ê³„ ë°ì´í„° íŒŒì‹± ì‹œë„:`, resultData);
                        const chain1Data = (function(){
                            const parsed = safeJsonParse(resultData);
                            return parsed && typeof parsed === 'object' ? parsed : {};
                        })();
                        console.log(`ğŸ”§ 1ë‹¨ê³„ íŒŒì‹± ì™„ë£Œ:`, chain1Data);
                        formattedResult = `
                            <strong>ğŸ‘¥ ì¸ì› ìˆ˜:</strong> ${chain1Data.people || 0}ëª…
                            <br><strong>ğŸ§³ ì´ ì§ ê°œìˆ˜:</strong> ${chain1Data.total_luggage_count || 0}ê°œ
                            <br><strong>ğŸ“‹ ì§ ìƒì„¸ ì •ë³´:</strong>
                            <br><pre>${JSON.stringify(chain1Data.luggage_details || {}, null, 2)}</pre>
                        `;
                        break;
                        
                    case 2: // ì§ ì¸ì‹ ë° ë¶„ë¥˜
                        const chain2Data = (function(){
                            const parsed = safeJsonParse(resultData);
                            return parsed && typeof parsed === 'object' ? parsed : {};
                        })();
                        formattedResult = `
                            <strong>ğŸª‘ ì¢Œì„ ë°°ì¹˜ ì§€ì‹œì‚¬í•­:</strong>
                            <br><pre>${JSON.stringify(chain2Data.instruction || {}, null, 2)}</pre>
                        `;
                        break;
                        
                    case 3: // ì°¨ëŸ‰ ê³µê°„ ê³„ì‚°
                        const cleanData = (typeof resultData === 'string') ? resultData.replace(/```json\s*|```/g, '') : resultData;
                        const chain3Data = (function(){
                            const parsed = safeJsonParse(cleanData);
                            return parsed && typeof parsed === 'object' ? parsed : {};
                        })();
                        formattedResult = `
                            <strong>ğŸš— í™˜ê²½ ì„¤ì • (ì´ì „):</strong>
                            <br><pre>${JSON.stringify(chain3Data.environment_before || {}, null, 2)}</pre>
                            <br><strong>ğŸ“‹ ì‘ì—… ìˆœì„œ:</strong>
                            <br><pre>${JSON.stringify(chain3Data.task_sequence || {}, null, 2)}</pre>
                            <br><strong>ğŸš— í™˜ê²½ ì„¤ì • (ì´í›„):</strong>
                            <br><pre>${JSON.stringify(chain3Data.environment_after || {}, null, 2)}</pre>
                        `;
                        break;
                        
                    case 4: // ìµœì  ë°°ì¹˜ ìƒì„±
                        formattedResult = `
                            <strong>ğŸ¯ ìµœì  ë°°ì¹˜ ì½”ë“œ:</strong>
                            <br><pre>${resultData}</pre>
                            <br><em>16ìë¦¬ ì½”ë“œëŠ” ê° ì¢Œì„ì˜ ìµœì  ë°°ì¹˜ ìƒíƒœë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</em>
                        `;
                        break;
                        
                    default:
                        formattedResult = `<pre>${resultData}</pre>`;
                }
                
                return formattedResult;
                
            } catch (error) {
                console.error(`ë‹¨ê³„ ${stepNumber} ê²°ê³¼ í¬ë§·íŒ… ì˜¤ë¥˜:`, error);
                return `<p>ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: ${error.message}</p><pre>${resultData}</pre>`;
            }
        }
        
        // ê°€ê³µëœ ë‹¨ê³„ë³„ ê²°ê³¼ ë°ì´í„° í¬ë§·íŒ…
        function formatProcessedStepResult(stepNumber, processedData) {
            try {
                let formattedResult = '';
                
                switch(stepNumber) {
                    case 1: // ì´ë¯¸ì§€ ë¶„ì„
                        try {
                            // processedDataê°€ ë¬¸ìì—´ì¸ ê²½ìš° JSON íŒŒì‹± ì‹œë„
                            let chain1Data = processedData;
                            if (typeof processedData === 'string') {
                                chain1Data = safeJsonParse(processedData) || {};
                            }
                            
                            const peopleCount = chain1Data.people || chain1Data.people_count || 0;
                            const totalLuggage = chain1Data.total_luggage_count || chain1Data.total_luggage || 0;
                            const luggageDetails = chain1Data.luggage_details || {};
                            
                            // ì§ ìƒì„¸ ì •ë³´ë¥¼ í‘œ í˜•íƒœë¡œ ë³€í™˜
                            let luggageTableRows = '';
                            if (typeof luggageDetails === 'object' && luggageDetails !== null) {
                                console.log("luggageDetails" + luggageDetails);
                                Object.entries(luggageDetails).forEach(([key, value]) => {
                                    luggageTableRows += `
                                        <tr>
                                            <td>${key}</td>
                                            <td>${typeof value === 'object' ? JSON.stringify(value) : value}</td>
                                        </tr>
                                    `;
                                });
                            }
                            
                            formattedResult = `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>í•­ëª©</th>
                                            <th>ê°’</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>ğŸ‘¥ ì¸ì› ìˆ˜</strong></td>
                                            <td>${peopleCount}ëª…</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ğŸ§³ ì´ ì§ ê°œìˆ˜</strong></td>
                                            <td>${totalLuggage}ê°œ</td>
                                        </tr>
                                        ${luggageTableRows ? `
                                        <tr>
                                            <td colspan="2"><strong>ğŸ“‹ ì§ ìƒì„¸ ì •ë³´</strong></td>
                                        </tr>
                                        ${luggageTableRows}
                                        ` : ''}
                                    </tbody>
                                </table>
                            `;
                        } catch (error) {
                            console.error('1ë‹¨ê³„ ê²°ê³¼ í¬ë§·íŒ… ì˜¤ë¥˜:', error);
                            formattedResult = `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>í•­ëª©</th>
                                            <th>ê°’</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>ğŸ‘¥ ì¸ì› ìˆ˜</strong></td>
                                            <td>0ëª…</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ğŸ§³ ì´ ì§ ê°œìˆ˜</strong></td>
                                            <td>0ê°œ</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ğŸ“‹ ì›ë³¸ ë°ì´í„°</strong></td>
                                            <td><pre>${processedData}</pre></td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        }
                        break;
                        
                    case 2: // ì§ ì¸ì‹ ë° ë¶„ë¥˜
                        try {
                            // ê°€ê³µëœ ì¢Œì„ ë°°ì¹˜ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
                            if (processedData.seat_assignments && Array.isArray(processedData.seat_assignments)) {
                                const seatAssignments = processedData.seat_assignments;
                                const seatsCount = processedData.seats_count || seatAssignments.length;
                                
                                // ì¢Œì„ ë°°ì¹˜ í‘œ ìƒì„±
                                let tableRows = '';
                                seatAssignments.forEach(seat => {
                                    tableRows += `
                                        <tr>
                                            <td>${seat.seat_id}</td>
                                            <td>${seat.type}</td>
                                            <td>${seat.size}</td>
                                            <td>${seat.category}</td>
                                        </tr>
                                    `;
                                });
                                
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ì¢Œì„ ë²ˆí˜¸</th>
                                                <th>íƒ€ì…</th>
                                                <th>í¬ê¸°</th>
                                                <th>ì¹´í…Œê³ ë¦¬</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tableRows}
                                        </tbody>
                                    </table>
                                `;
                            } else {
                                // ê°€ê³µëœ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì›ë³¸ í‘œì‹œ
                                let instructionData = processedData && processedData.instruction ? processedData.instruction : {};
                                if (typeof processedData === 'string') {
                                    const parsed = safeJsonParse(processedData) || {};
                                    instructionData = parsed.instruction || parsed;
                                }
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>í•­ëª©</th>
                                                <th>ê°’</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>ğŸª‘ ì¢Œì„ ë°°ì¹˜ ì§€ì‹œì‚¬í•­</strong></td>
                                                <td><pre>${JSON.stringify(instructionData, null, 2)}</pre></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                            }
                        } catch (error) {
                            console.error('2ë‹¨ê³„ ê²°ê³¼ í¬ë§·íŒ… ì˜¤ë¥˜:', error);
                            formattedResult = `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>í•­ëª©</th>
                                            <th>ê°’</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>ğŸª‘ ì¢Œì„ ë°°ì¹˜ ì§€ì‹œì‚¬í•­</strong></td>
                                            <td><pre>${processedData}</pre></td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        }
                        break;
                        
                    case 3: // ì°¨ëŸ‰ ê³µê°„ ê³„ì‚°
                        try {
                            // ê°€ê³µëœ ì‘ì—… ìˆœì„œ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
                            if (processedData.task_sequence_list && Array.isArray(processedData.task_sequence_list)) {
                                const taskSequenceList = processedData.task_sequence_list;
                                
                                // ì‘ì—… ìˆœì„œ í‘œ ìƒì„±
                                let taskRows = '';
                                taskSequenceList.forEach(task => {
                                    taskRows += `
                                        <tr>
                                            <td>${task.step_id}</td>
                                            <td>${task.action}</td>
                                            <td>${task.target}</td>
                                            <td>${task.description}</td>
                                        </tr>
                                    `;
                                });
                                
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ë‹¨ê³„</th>
                                                <th>ì‘ì—…</th>
                                                <th>ëŒ€ìƒ</th>
                                                <th>ì„¤ëª…</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${taskRows}
                                        </tbody>
                                    </table>
                                    <br>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>í™˜ê²½ ì„¤ì •</th>
                                                <th>ê°’</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>ğŸŒ í™˜ê²½ ì„¤ì • (ì´ì „)</strong></td>
                                                <td><pre>${JSON.stringify(processedData.environment_before || {}, null, 2)}</pre></td>
                                            </tr>
                                            <tr>
                                                <td><strong>ğŸŒ í™˜ê²½ ì„¤ì • (ì´í›„)</strong></td>
                                                <td><pre>${JSON.stringify(processedData.environment_after || {}, null, 2)}</pre></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                            } else {
                                // ê°€ê³µëœ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì›ë³¸ í‘œì‹œ
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>í•­ëª©</th>
                                                <th>ê°’</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>ğŸŒ í™˜ê²½ ì„¤ì • (ì´ì „)</strong></td>
                                                <td><pre>${JSON.stringify(processedData.environment_before || {}, null, 2)}</pre></td>
                                            </tr>
                                            <tr>
                                                <td><strong>ğŸ“‹ ì‘ì—… ìˆœì„œ</strong></td>
                                                <td><pre>${JSON.stringify(processedData.task_sequence || {}, null, 2)}</pre></td>
                                            </tr>
                                            <tr>
                                                <td><strong>ğŸŒ í™˜ê²½ ì„¤ì • (ì´í›„)</strong></td>
                                                <td><pre>${JSON.stringify(processedData.environment_after || {}, null, 2)}</pre></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                            }
                        } catch (error) {
                            console.error('3ë‹¨ê³„ ê²°ê³¼ í¬ë§·íŒ… ì˜¤ë¥˜:', error);
                            formattedResult = `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>í•­ëª©</th>
                                            <th>ê°’</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>ğŸš— ì°¨ëŸ‰ ê³µê°„ ê³„ì‚° ê²°ê³¼</strong></td>
                                            <td><pre>${processedData}</pre></td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        }
                        break;
                        
                    case 4: // ìµœì  ë°°ì¹˜ ìƒì„±
                        try {
                            // ê°€ê³µëœ ë°°ì¹˜ ë¶„ì„ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
                            if (processedData.placement_analysis) {
                                const analysis = processedData.placement_analysis;
                                const complexityText = {
                                    'basic': 'ê¸°ë³¸',
                                    'medium': 'ì¤‘ê°„',
                                    'high': 'ê³ ê¸‰'
                                }[analysis.complexity_level] || 'ê¸°ë³¸';
                                
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>í•­ëª©</th>
                                                <th>ê°’</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>ğŸ“ ì½”ë“œ ê¸¸ì´</strong></td>
                                                <td>${processedData.code_length || 0}ì</td>
                                            </tr>
                                            <tr>
                                                <td><strong>ğŸ“‹ ì§€ì‹œì‚¬í•­ ìˆ˜</strong></td>
                                                <td>${analysis.total_instructions}ê°œ</td>
                                            </tr>
                                            <tr>
                                                <td><strong>âš¡ ë³µì¡ë„</strong></td>
                                                <td>${complexityText}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>ğŸ“ ë°°ì¹˜ ì½”ë“œ</strong></td>
                                                <td><pre>${processedData.placement_code || ''}</pre></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                            } else {
                                // ê°€ê³µëœ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì›ë³¸ í‘œì‹œ
                                formattedResult = `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>í•­ëª©</th>
                                                <th>ê°’</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>ğŸ¯ ìµœì  ë°°ì¹˜ ì½”ë“œ</strong></td>
                                                <td><pre>${processedData.placement_code || ''}</pre></td>
                                            </tr>
                                            <tr>
                                                <td><strong>ğŸ“ ì½”ë“œ ê¸¸ì´</strong></td>
                                                <td>${processedData.code_length || 0}ì</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                `;
                            }
                        } catch (error) {
                            console.error('4ë‹¨ê³„ ê²°ê³¼ í¬ë§·íŒ… ì˜¤ë¥˜:', error);
                            formattedResult = `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>í•­ëª©</th>
                                            <th>ê°’</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>ğŸ¯ ìµœì  ë°°ì¹˜ ìƒì„± ê²°ê³¼</strong></td>
                                            <td><pre>${processedData}</pre></td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        }
                        break;
                        
                    default:
                        formattedResult = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>í•­ëª©</th>
                                        <th>ê°’</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>ğŸ“Š ë¶„ì„ ê²°ê³¼</strong></td>
                                        <td><pre>${JSON.stringify(processedData, null, 2)}</pre></td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                }
                
                return formattedResult;
                
            } catch (error) {
                console.error(`ê°€ê³µëœ ë‹¨ê³„ ${stepNumber} ê²°ê³¼ í¬ë§·íŒ… ì˜¤ë¥˜:`, error);
                return `<p>ë°ì´í„° í¬ë§·íŒ… ì˜¤ë¥˜: ${error.message}</p><pre>${JSON.stringify(processedData, null, 2)}</pre>`;
            }
        }
        
        // ë¶„ì„ ì‹œì‘
        async function startAnalysis() {
            try {
                // ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± (ì´ì „ ë°ì´í„° ë°©ì§€)
                const newScenario = `step_analysis_${new Date().toISOString().replace(/[:.]/g, '-')}`;
                console.log('ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±:', newScenario);
                
                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶„ì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const analysisDataStr = sessionStorage.getItem('analysisData');
                let analysisData = {
                    people_count: 4,
                    image_data_url: 'default_image',
                    scenario: newScenario  // ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤ ì‚¬ìš©
                };
                
                if (analysisDataStr) {
                    analysisData = (function(){
                        try { return JSON.parse(analysisDataStr); } catch { return {}; }
                    })();
                    // ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ë®ì–´ì“°ê¸°
                    analysisData.scenario = newScenario;
                    console.log('ì„¸ì…˜ì—ì„œ ë¶„ì„ ë°ì´í„° ê°€ì ¸ì˜´ (ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤ ì ìš©):', {
                        scenario: analysisData.scenario,
                        people_count: analysisData.people_count,
                        image_data_url: analysisData.image_data_url.substring(0, 50) + '...'
                    });
                } else {
                    console.warn('ì„¸ì…˜ì—ì„œ ë¶„ì„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©');
                }
                
                // ë¶„ì„ ì‹œì‘ API í˜¸ì¶œ
                console.log('ë¶„ì„ API í˜¸ì¶œ ì‹œì‘...');
                const response = await fetch('/desktop/api/step_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        people_count: analysisData.people_count,
                        image_data_url: analysisData.image_data_url,
                        scenario: analysisData.scenario
                    })
                });
                
                const result = await response.json();
                console.log('ë¶„ì„ ì‹œì‘ ì‘ë‹µ:', result);
                
                if (result.success) {
                    console.log('ë¶„ì„ì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    // currentScenario ì—…ë°ì´íŠ¸
                    currentScenario = newScenario;
                    console.log('í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤ ì—…ë°ì´íŠ¸:', currentScenario);
                    // ì§„í–‰ë¥  í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    document.getElementById('progressText').textContent = 'AIê°€ ë¶„ì„ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤...';
                } else {
                    console.error('ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨:', result.message);
                    // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                    document.getElementById('progressText').textContent = 'ë¶„ì„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message;
                }
            } catch (error) {
                console.error('ë¶„ì„ ì‹œì‘ ì˜¤ë¥˜:', error);
                document.getElementById('progressText').textContent = 'ë¶„ì„ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            currentScenario = getScenarioFromURL();
            console.log('ì‹œë‚˜ë¦¬ì˜¤:', currentScenario);
            
            // ì´ˆê¸° ìƒíƒœ ì„¤ì •
            updateProgress(0);
            updateStepDisplay();
            
            // ë¶„ì„ ì‹œì‘
            startAnalysis();
            
            // SSE ì‹œì‘
            try {
                if (eventSource) {
                    eventSource.close();
                }
                eventSource = new EventSource('/desktop/api/status_stream');
                eventSource.onmessage = (e) => {
                    try {
                        const payload = JSON.parse(e.data);
                        // ì—°ê²° ì´ë²¤íŠ¸ëŠ” ê±´ë„ˆëœ€
                        if (payload && payload.event === 'connected') return;
                        handleStatusData(payload);
                        const status = payload.status || payload.system?.status;
                        const hasFinal = !!(payload.chain4_out || payload.analysis_result?.chain4_out || payload.processed_results?.chain4_out);
                        if (status === 'done' && hasFinal) {
                            document.getElementById('progressText').textContent = 'ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                            showResultButton();
                            eventSource.close();
                        } else if (status === 'error') {
                            document.getElementById('progressText').textContent = 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                            eventSource.close();
                        }
                    } catch (err) {
                        console.error('SSE ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
                    }
                };
                eventSource.onerror = (e) => {
                    console.warn('SSE ì˜¤ë¥˜ ë˜ëŠ” ì¢…ë£Œ:', e);
                    try { eventSource.close(); } catch (_) {}
                };
            } catch (e) {
                console.error('SSE ì—°ê²° ì‹¤íŒ¨:', e);
            }
        });
    </script>
</body>
</html>