# TETRIS AI 모터 제어 시스템 - 최종 구조 흐름도

## 🎯 시스템 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        TETRIS 통합 시스템                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    메인 진입점                                     │   │
│  │                 tetris.py                                         │   │
│  │              (통합 시스템 관리)                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                │                                           │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   실행 모드 분기                                   │   │
│  │                                                                     │   │
│  │  ┌─────────────────┐                ┌─────────────────────────────┐ │   │
│  │  │   웹 모드       │                │      시나리오 모드          │ │   │
│  │  │ --mode web      │                │   --mode scenario          │ │   │
│  │  └─────────────────┘                └─────────────────────────────┘ │   │
│  │           │                                    │                    │   │
│  │           ▼                                    ▼                    │   │
│  │  ┌─────────────────┐                ┌─────────────────────────────┐ │   │
│  │  │  web_interface/ │                │      main_chain/           │ │   │
│  │  │   (웹 서버)     │                │    (AI 체인 처리)          │ │   │
│  │  └─────────────────┘                └─────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                │                                           │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   모터 제어 통합                                   │   │
│  │                rpi_controller/                                     │   │
│  │             (아두이노 모터 제어)                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🌐 웹 인터페이스 구조 (web_interface/)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        web_interface/                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    web.py                                          │   │
│  │              (메인 웹 서버)                                         │   │
│  │           Flask 앱 생성 및 Blueprint 등록                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                │                                           │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   Blueprint 등록                                   │   │
│  │                                                                     │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │   │
│  │  │   control/      │    │     user/       │    │    source/      │ │   │
│  │  │  (관제 영역)    │    │  (사용자 영역)  │    │  (공통 리소스)  │ │   │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘ │   │
│  │           │                       │                       │         │   │
│  │           ▼                       ▼                       ▼         │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │   │
│  │  │  routes.py      │    │   routes.py     │    │    utils.py     │ │   │
│  │  │  control_utils  │    │  input_handler  │    │ session_manager │ │   │
│  │  │  templates/     │    │  user_utils     │    │  file_handler   │ │   │
│  │  │  static/        │    │  templates/     │    │  templates/     │ │   │
│  │  │                 │    │  static/        │    │  static/        │ │   │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🔄 시스템 실행 흐름

### 1. 시스템 시작 흐름
```
사용자 실행
    ↓
python tetris/tetris.py --mode web
    ↓
tetris.py 메인 진입점
    ↓
웹 모드 선택
    ↓
web_interface/web.py 실행
    ↓
Flask 앱 생성 및 Blueprint 등록
    ↓
웹 서버 시작 (포트 5002)
    ↓
관제 화면 표시 (/desktop/control)
```

### 2. 사용자 접속 흐름
```
휴대폰 QR 코드 스캔
    ↓
휴대폰 웹 접속 (/mobile/input)
    ↓
사용자 입력 수집
    - 이미지 업로드
    - 인원 수 선택
    ↓
실시간 통신 (WebSocket/SSE)
    ↓
관제 화면과 동기화
```

### 3. AI 처리 흐름
```
사용자 입력 완료
    ↓
AI 처리 시작 버튼 클릭
    ↓
main_chain/main_chain.py 호출
    ↓
4단계 AI 체인 순차 실행
    - chain1: 이미지 분석
    - chain2: 데이터 처리
    - chain3: 결과 생성
    - chain4: 모터 제어 코드 생성
    ↓
16-digit 모터 제어 코드 생성
    ↓
실행 버튼 활성화 (휴대폰 웹)
```

### 4. 모터 제어 흐름
```
휴대폰 웹에서 실행 버튼 클릭
    ↓
rpi_controller/rpi_controller.py 호출
    ↓
아두이노 시리얼 통신
    ↓
스테퍼 모터 제어 시작
    ↓
실시간 모터 상태 모니터링
    ↓
모터 위치 데이터 수집
    ↓
최종 결과 표시
```

## 📱 화면별 역할 분담

### 관제 화면 (control/)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        데스크탑 관제 화면                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │
│  │   QR 코드 표시  │  │  실시간 모니터링│  │     시스템 로그             │ │
│  │                 │  │                 │  │                             │ │
│  │  휴대폰 접속용  │  │  AI 처리 진행률 │  │  오류 상황 및 상태 표시     │ │
│  │  QR 코드 생성   │  │  모터 상태 추적 │  │                             │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    실시간 데이터 표시                              │   │
│  │                                                                     │   │
│  │  • 현재 세션 상태                                                   │   │
│  │  • AI 체인 진행률 (chain1~4)                                        │   │
│  │  • 모터 연결 상태                                                   │   │
│  │  • 모터 위치 데이터                                                 │   │
│  │  • 사용자 조작 기록                                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 휴대폰 웹 화면 (user/)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        모바일 사용자 화면                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │
│  │   입력 수집     │  │  진행상황 확인  │  │     결과 표시               │ │
│  │                 │  │                 │  │                             │ │
│  │  이미지 업로드  │  │  AI 처리 진행률 │  │  모터 실행 결과             │ │
│  │  인원 수 선택   │  │  실시간 업데이트│  │  최종 데이터 표시           │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    제어 기능                                       │   │
│  │                                                                     │   │
│  │  • 이미지 미리보기                                                  │   │
│  │  • AI 처리 시작 버튼                                                │   │
│  │  • 모터 실행 버튼                                                   │   │
│  │  • 추가 모터 조작 패널                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🔧 모터 제어 시스템 (rpi_controller/)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        모터 제어 시스템                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                rpi_controller.py                                   │   │
│  │              (아두이노 컨트롤러)                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                │                                           │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   제어 기능                                        │   │
│  │                                                                     │   │
│  │  ┌─────────────────┐                ┌─────────────────────────────┐ │   │
│  │  │   시리얼 통신   │                │     모터 제어               │ │   │
│  │  │                 │                │                             │ │   │
│  │  │  아두이노 연결  │                │  스테퍼 모터 정밀 제어     │ │   │
│  │  │  명령 전송      │                │  위치 제어                  │ │   │
│  │  │  데이터 수신    │                │  속도 제어                  │ │   │
│  │  └─────────────────┘                └─────────────────────────────┘ │   │
│  │                                                                     │   │
│  │  ┌─────────────────┐                ┌─────────────────────────────┐ │   │
│  │  │   상태 모니터링 │                │     데이터 수집             │ │   │
│  │  │                 │                │                             │ │   │
│  │  │  연결 상태 확인 │                │  모터 위치 데이터           │ │   │
│  │  │  실시간 상태    │                │  실행 결과 데이터           │ │   │
│  │  │  오류 감지      │                │  로그 데이터                │ │   │
│  │  └─────────────────┘                └─────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🤖 AI 체인 처리 시스템 (main_chain/)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        AI 체인 처리 시스템                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                main_chain.py                                       │   │
│  │              (메인 AI 체인 실행기)                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                │                                           │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   4단계 AI 체인                                    │   │
│  │                                                                     │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐ │   │
│  │  │    Chain 1      │  │    Chain 2      │  │     Chain 3         │ │   │
│  │  │                 │  │                 │  │                     │ │   │
│  │  │  이미지 분석    │  │  데이터 처리    │  │  결과 생성           │ │   │
│  │  │  객체 인식      │  │  패턴 분석      │  │  최적화             │ │   │
│  │  │  특징 추출      │  │  분류           │  │  검증               │ │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────┘ │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │                        Chain 4                                 │ │   │
│  │  │                                                                 │ │   │
│  │  │                  모터 제어 코드 생성                           │ │   │
│  │  │                  16-digit 코드 출력                           │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 📊 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           데이터 흐름                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  사용자 입력 → 웹 인터페이스 → AI 체인 → 모터 제어 → 결과 출력             │
│      │              │            │           │            │                │
│      ▼              ▼            ▼           ▼            ▼                │
│  ┌─────────┐  ┌─────────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────┐   │
│  │ 이미지  │  │  실시간    │  │ AI 처리 │  │ 모터    │  │ 최종 결과   │   │
│  │ 업로드  │  │  통신      │  │ 진행률  │  │ 상태    │  │ 표시        │   │
│  │ 인원수  │  │  동기화    │  │ 업데이트│  │ 모니터링│  │ 데이터     │   │
│  └─────────┘  └─────────────┘  └─────────┘  └─────────┘  └─────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    실시간 피드백 루프                              │   │
│  │                                                                     │   │
│  │  관제 화면 ←→ 웹 인터페이스 ←→ AI 체인 ←→ 모터 제어                │   │
│  │     ↑              ↑              ↑              ↑                 │   │
│  │  상태 표시      통신 관리      진행률        모터 제어             │   │
│  │  모니터링       동기화        업데이트      상태 추적              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🎯 최종 구조 요약

### 핵심 특징
1. **단일 진입점**: `tetris.py`로 모든 기능 통합
2. **모듈 분리**: control/user/source 영역 명확히 분리
3. **모터 중심**: 스테퍼 모터 제어에 특화
4. **실시간 동기화**: 관제 화면과 휴대폰 웹 동시 업데이트
5. **확장 가능**: Blueprint 기반 모듈화 구조

### 실행 방법
```bash
# 웹 모드 (통합)
python tetris/tetris.py --mode web

# 시나리오 모드 (통합)
python tetris/tetris.py --mode scenario
```

### 접속 방법
- **관제 화면**: http://localhost:5002/desktop/control
- **휴대폰 웹**: QR 코드 스캔 또는 http://<라즈베리파이IP>:5002

---

**이 흐름도는 TETRIS AI 모터 제어 시스템의 최종 재구조화된 구조를 시각적으로 보여줍니다.**
